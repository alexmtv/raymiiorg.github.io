<!-- nominify -->



    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Chef: overwrite templates in wrapper-cookbooks - Raymii.org</title>
        <link href="/s/inc/css/bootstrap.css" rel="stylesheet" />
        <link href="/s/inc/css/custom.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link href="inc/img/icons/iphone.png" rel="apple-touch-icon" />
        <link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76" />
        <link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120" />
        <link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="http://feeds.feedburner.com/Raymiiorg" />
    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="https://raymii.org/s/inc/img/resistor-50.png" alt="IEC Resistor logo"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS Feed</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/everything.html" class="special-menu">All Items</a></li><li><a href="/s/tags/bash.html" class="link">Bash</a></li><li><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li><a href="/s/tags/ssl.html" class="link">SSL</a></li><li><a href="/s/tags/debian.html" class="link">Debian</a></li><li><a href="/s/tags/python.html" class="link">Python</a></li><li><a href="/s/tags/vpn.html" class="link">VPN</a></li><li><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li><li><a href="/s/tags/nginx.html" class="link">nginx</a></li><li><a href="/s/tags/apache.html" class="link">Apache</a></li><li><a href="/s/tags/ansible.html" class="link">Ansible</a></li></ul>
               <!-- advertisement start -->
               
                
                <strong>Support this website:</strong><br />
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting VPS Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean VPS Affiliate</a><br />
                <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
                <input type="hidden" name="cmd" value="_s-xclick">
                <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
                ">
                <input type="image" src="https://www.paypalobjects.com/en_US/NL/i/btn/btn_donateCC_LG.gif" name="submit" alt="PayPal - The safer, easier way to pay online!">
                <img alt="" src="https://www.paypalobjects.com/nl_NL/i/scr/pixel.gif" width="1" height="1">
                </form>
                <script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script>
                <script type="text/javascript"
                src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>    
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">


           <h2 class='headheader'>Chef: overwrite templates in wrapper-cookbooks</h2><ul class="breadcrumb"><li><a href="../" class="link">Home</a></li><li><a href="../articles" class="link">Articles</a></li><li><a href="Chef_-_overwrite_templates_in_wrapper_cookbooks.html" class="link">Chef: overwrite templates in wrapper-cookbooks</a></li></ul><p><small>02-04-2014</small> | <small>Remy van Elst</small></p><p>This article describes how to use a template in a wrapper-cookbook in Chef. </p>

<h3>Background on Wrapper Cookbooks</h3>

<p>The Chef Cookbook Wrapper Pattern is based upon a design convention where you customize an existing library cookbook by using a separate wrapper cookbook, which wraps the original cookbook with any related configuration changes. </p>

<p>A library cookbook is an existing cookbook, typically an open-source contribution from a user in the Chef community, designed for server configuration purposes. </p>

<p>A wrapper cookbook is a cookbook that wraps the original library cookbook with custom modifications or additions such as overriding a Chef attribute, changing a Chef template, converting a Chef attribute to a user-definable input, etc. </p>

<p>As the Chef community continues to grow, both in the number of active Chef developers and the range of available applications, finding an existing community cookbook that you want to leverage will become more of the norm than the exception. Therefore, it will be easier to find an existing cookbook that you can either use as-is or slightly modify for your own purposes. When possible, it&#39;s best to leverage an existing cookbook (assuming that it&#39;s actively being maintained) than trying to create your own custom cookbook from scratch or forking a cookbook repository. </p>

<p>Although forking a repository may initially seem like the easiest way to modify an existing cookbook, it will likely cause you more headaches over time as you try to maintain and upgrade your codebase over time. Therefore, it&#39;s recommended that you spend the extra time and effort to integrate a Wrapper Cookbook Pattern into your development routine because you will have a more manageable upgrade path for integrating future bug fixes and new functionality. </p>

<p><a href="http://support.rightscale.com/12-Guides/Chef_Cookbooks_Developer_Guide/04-Developer/06-Development_Resources/Chef_Cookbook_Design_Patterns/Wrapper_Cookbook_Pattern">Source</a></p>

<h3>Templates in wrapper-cookbooks</h3>

<p>To override a template by just defining it again would result in it being written two times every Chef run, which is not what we want. Using this method, you can override the template from the default cookbook with a template in your wrapper-cookbook. </p>

<p>One of my clients uses graphite and wants to limit which users can login using LDAP in Apache. The <a href="https://github.com/hw-cookbooks/graphite">graphite</a> cookbook does not support this by default, but it works for all the other things.</p>

<p>Graphite itself has support for LDAP login, however, the client has experience with Apache LDAP and wants to use that so that other admins can manage it as well.</p>

<p>So what we want to do is overwrite the default apache template from the graphite cookbook with our template which has the LDAP data. </p>

<p>In the graphite cookbook we see the following piece of code which places the template for the graphite website in the apache <code>sites-available</code> folder:</p>

<pre><code>template &quot;#{node[&#39;apache&#39;][&#39;dir&#39;]}/sites-available/graphite&quot; do
  source &quot;graphite-vhost.conf.erb&quot;
  mode 0755
  variables(:timezone =&gt; node[&#39;graphite&#39;][&#39;timezone&#39;],
            :debug =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;debug&#39;],
            :base_dir =&gt; node[&#39;graphite&#39;][&#39;base_dir&#39;],
            :doc_root =&gt; node[&#39;graphite&#39;][&#39;doc_root&#39;],
            :storage_dir =&gt; node[&#39;graphite&#39;][&#39;storage_dir&#39;],
            :cluster_servers =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;cluster_servers&#39;],
            :carbonlink_hosts =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;carbonlink_hosts&#39;],
            :memcached_hosts =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;memcached_hosts&#39;],
     )
  notifies :reload, &quot;service[apache2]&quot;, :immediately
end
</code></pre>

<p>We are going to override this template with extra variables for the LDAP connection in Apache.</p>

<p>Add a few node attributes, or place them in a data bag, whatever you like, for the LDAP:</p>

<pre><code>{
    &quot;tags&quot;: [],
    &quot;graphite&quot;: {
        &quot;ldap&quot;: {
            &quot;password&quot;: &quot;passw0rd&quot;,
            &quot;server&quot;: &quot;ldap.example.org&quot;,
            &quot;enabled&quot;: true,
            &quot;binddn&quot;: &quot;uid=graphite,ou=Applications,dc=example,dc=org&quot;,
            &quot;accessgroup&quot;: &quot;cn=graphite_users,ou=Groups,dc=example,dc=org&quot;,
            &quot;apachefilter&quot;: &quot;uid?sub?(ObjectClass=*)&quot;,
            &quot;userdn&quot;: &quot;ou=Users,dc=example,dc=org&quot;,
            &quot;port&quot;: 636
        }
    }
}
</code></pre>

<p>We are going to use these in the apache template.</p>

<p>Create a new cookbook:</p>

<pre><code>knife cookbook create wrapper-graphite
</code></pre>

<p>Copy the template over from the graphite cookbook to the wrapper cookbook:</p>

<pre><code>cp cookbooks/graphite/templates/default/graphite-vhost.conf.erb cookbooks/wrapper-graphite/templates/default/graphite-vhost.conf.erb
</code></pre>

<p>Add the LDAP settings to the template <code>graphite-vhost.conf.erb</code> in the wrapper-cookbook folder:</p>

<pre><code>&lt;Location /&gt;
  Order deny,allow
  Deny from All
  AuthName &quot;Authorization Required&quot;
  AuthType Basic
  # Needed for require-valid-user
  AuthzLDAPAuthoritative off
  AuthBasicProvider ldap
  AuthLDAPUrl &quot;ldap://&lt;%- @ldap_server %&gt;/&lt;%- @ldap_basedn %&gt;?&lt;%- @ldap_apachefilter %&gt;&quot;
  AuthLDAPBindDN &quot;&lt;%- @ldap_binddn %&gt;&quot;
  AuthLDAPBindPassword &quot;&lt;%- @ldap_password %&gt;&quot;
  Require ldap-group &lt;%- @ldap_accessgroup %&gt;
  Satisfy any
&lt;/Location&gt;
</code></pre>

<p>Then edit your recipe, <code>cookbooks/wrapper-graphite/recipes/default.rb</code>. Add the basic header boilerplate and include the <code>graphite</code> recipe:</p>

<pre><code>#
# Cookbook Name:: wrapper-graphite
# Recipe:: default
#
# Copyright 2014, EXAMPLE COMPANY
#
# License: GPLv3

include_recipe &quot;graphite&quot;
</code></pre>

<p>Don&#39;t forget to also add it to the <code>metadata.rb</code> file:</p>

<pre><code>depends         &quot;graphite&quot;
</code></pre>

<p>Add the following magic to the wrapper cookbook. This is the part that overrides the template in the normal cookbook with the template from the wrapper cookbook:</p>

<pre><code>begin
    r = resources(:template =&gt; &quot;#{node[&#39;apache&#39;][&#39;dir&#39;]}/sites-available/graphite&quot;)
    r.cookbook &quot;wrapper-graphite&quot;
    r.source &quot;graphite-vhost.conf.erb&quot;
    r.mode 0755
    r.variables(:timezone =&gt; node[&#39;graphite&#39;][&#39;timezone&#39;],
        :debug =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;debug&#39;],
        :base_dir =&gt; node[&#39;graphite&#39;][&#39;base_dir&#39;],
        :doc_root =&gt; node[&#39;graphite&#39;][&#39;doc_root&#39;],
        :storage_dir =&gt; node[&#39;graphite&#39;][&#39;storage_dir&#39;],
        :cluster_servers =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;cluster_servers&#39;],
        :carbonlink_hosts =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;carbonlink_hosts&#39;],
        :memcached_hosts =&gt; node[&#39;graphite&#39;][&#39;web&#39;][&#39;memcached_hosts&#39;],
        :ldap_enabled =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;enabled&#39;],
        :ldap_server =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;server&#39;],
        :ldap_port =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;port&#39;],
        :ldap_binddn =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;binddn&#39;],
        :ldap_basedn =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;basedn&#39;],
        :ldap_accessgroup =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;access_group&#39;],
        :ldap_password =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;password&#39;],
        :ldap_apachefilter =&gt; node[&#39;graphite&#39;][&#39;ldap&#39;][&#39;apachefilter&#39;]
    )
    r.notifies :reload, &quot;service[apache2]&quot;, :immediately
    rescue Chef::Exceptions::ResourceNotFound
        Chef::Log.warn &quot;could not find template to override!&quot;
end
</code></pre>

<p>This works because a chef-client run has <a href="http://docs.opscode.com/essentials_nodes_chef_run.html">multiple phases</a>. The <a href="http://docs.opscode.com/chef/resources.html#run-resources-from-the-resource-collection">resource collection</a> is the ordered list of resources, from the recipes in your expanded run list, that are to be run on a node. </p>

<p>During the resource collection phase we can manipulate attributes of the resources in the resource collection. </p>

<p>Because Chef uses a two-phase execution model (compile, then converge), you can manipulate the results of that compilation in many different ways before convergence happens.</p>

<p>As you can see we need to set all of the variables, even the ones that were already declared in the original cookbook. If you don&#39;t do this, it will bork.</p>

<p>Now by adding the wrapper-graphite recipe to a node instead of the graphite recipe, it will do all the things from the graphite recipe, except for the override we define here.</p>

<p>The big advantage of this approach for me is that I can update the upstream cookbook at any moment (for example, when a new graphite is releases or the upstream cookbook changes) while my own changes do not need to be backported in there. </p>

<p><a href="http://www.getchef.com/blog/2013/12/03/doing-wrapper-cookbooks-right/">Here</a> is a blog entry from Opscode about wrapper cookbooks.</p>
<hr>Tags: <a href="../tags/chef.html" class="link">chef, </a><a href="../tags/deployment.html" class="link">deployment, </a><a href="../tags/devops.html" class="link">devops, </a><a href="../tags/graphite.html" class="link">graphite, </a><a href="../tags/ldap.html" class="link">ldap, </a><a href="../tags/ruby.html" class="link">ruby, </a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
     
    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->
    </body>
    </html>
    