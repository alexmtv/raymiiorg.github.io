
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Persistent reverse (NAT bypassing) SSH access with autossh - Raymii.org</title>
        <link href="/s/inc/css/bootstrap.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link rel="alternate" type="application/rss+xml" title="Raymii.org RSS" href="http://feeds.feedburner.com/Raymiiorg" />

    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
        <div class="row-fluid">
        
        <div class="span10 offset1">
                
            <div class="span4 well"> 
            
                <h1 class="topheader">Raymii.org</h1>
                <h6>Quis custodiet ipsos custodes?</h6>
                <h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS</a></h6>
            
            </div>

            <div class="span4 green-block">
                
                    <h3>Featured Items</h3>
    <a href="/s/tutorials/Ansible.html" class="whitelink">Ansible</a>
<br />
<a href="/s/tutorials/Autossh_persistent_tunnels.html" class="whitelink">Autossh persistent tunnels</a>
<br />
<a href="/s/software/Codename_Geld.html" class="whitelink">Codename Geld</a>
<br />
<a href="/s/tutorials/Munin_optimalization_on_Debian.html" class="whitelink">Munin optimalization on Debian</a>
<br />
<a href="/s/articles/Small_Linux_PCs.html" class="whitelink">Small Linux PCs</a>
<br />

            
        </div>
        <div class="span4 green-block">
            
                <h3>Featured Items</h3>
    <a href="/s/software/Bash_PHP_Server_Status_Monitor.html" class="whitelink">Bash PHP Server Status Monitor</a>
<br />
<a href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html" class="whitelink">IPSEC L2TP vpn with Ubuntu 12.04</a>
<br />
<a href="/s/software/Nopriv.py.html" class="whitelink">Nopriv.py</a>
<br />
<a href="/s/software/NutsManager.html" class="whitelink">NutsManager</a>
<br />
<a href="/s/tutorials/Tahoe_LAFS_Storage_Grid.html" class="whitelink">Tahoe LAFS Storage Grid</a>
<br />

            
        </div>
    </div>
    
    </div>
    <div class="row-fluid">
    <div class="span10 offset1">
    

    <div class="span3">
    <h3>Menu</h3><ul class="nav nav-pills nav-stacked">
<li><a href="/s/" class="link">Home</a>
</li>
<li><a href="/s/static/Contact.html" class="link">Contact</a>
</li>
<li><a href="/s/static/Disclaimer.html" class="link">Disclaimer</a>
</li>
<li><a href="/s/static/Hosted_OSWA.html" class="link">Hosted Oswa</a>
</li>
<li><a href="/s/static/Terrible-Linux.html" class="link">Terrible Linux</a>
</li>
</ul>
<h3>Categories</h3>
<ul class="nav nav-pills nav-stacked">
<li><a href="/s/articles" class="link">Articles</a>
</li>
<li><a href="/s/snippets" class="link">Snippets</a>
</li>
<li><a href="/s/software" class="link">Software</a>
</li>
<li><a href="/s/tutorials" class="link">Tutorials</a>
</li>
</ul>
               <!-- advertisement start -->
                <hr class="alt2">
                <h2>Advertisement</h2>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Need a VPS server? InceptionHosting has excellent VPS servers located in the USA or NL!</a><p />
                <script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                /* Raymii-2 */
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script>
                <script type="text/javascript"
                src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>    
                <!-- advertisement end -->

           </div>  
           <div class="span7"> 
                <div class="inner">


           <h2>Persistent reverse (NAT bypassing) SSH access with autossh</h2>
<ul class="breadcrumb">
<li><a href="../" class="link">Home</a>
<span class="divider">/</span></li>
<li><a href="../tutorials" class="link">Tutorials</a>
<span class="divider">/</span></li>
<li><a href="Autossh_persistent_tunnels.html" class="link">Persistent reverse (NAT bypassing) SSH access with autossh</a>
</li>
</ul>
<h6>Author: Remy Van Elst</h6>
<h6>Date: 05-10-2012</h6>
<br>
<p>Situation: you are in a restricted network (company, hotel, hospital) where you have a &quot;server&quot; which you want to access from outside that network. You cannot forward ports to that machine, but you can ssh outside (to your own server). This tutorial solves this problem.</p>

<p>You need another server to which you setup a persistent ssh connection with a reverse tunnel. Then if you need to access the machine you ssh into the other server, and from there you ssh through the tunnel to the restriced machine.</p>

<p>Make sure you have permission to do this from the administrators. They generally don&#39;t like holes in the firewall/security. They don&#39;t block it for no reason.</p>

<h4>Naming convention:</h4>

<p>restricted machine: machine inside the restricted network
middleman: machine to which the restricted machine sets up the tunnel, and from which you access the restricted server</p>

<h4>Install the tools</h4>

<p>We are going to use autossh. This is in the debian/ubuntu repositories. Make sure you also install openssh server.</p>

<p>Execute on: restricted machine.</p>

<pre><code>sudo apt-get install autossh ssh
</code></pre>

<h4>Create your ssh-key.</h4>

<p>Execute on: restricted machine.</p>

<pre><code>ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): */root/.ssh/nopwd*
Enter passphrase (empty for no passphrase): *leave empty*
Enter same passphrase again: *leave empty*
</code></pre>

<h4>Copy your key to the middleman machine</h4>

<p>Execute on: restricted machine.</p>

<pre><code>ssh-copy-id -i .ssh/nopwd.pub &quot;-p 2222 remy@middleman&quot;
</code></pre>

<p>(replace remy@middleman with your username and middleman ssh server. Also note how you can give a custom port in the ssh-copy-id.)</p>

<h4>Test the connection with autossh</h4>

<p>Execute on: restricted machine</p>

<pre><code>autossh -M 10984 -o &quot;PubkeyAuthentication=yes&quot; -o &quot;PasswordAuthentication=no&quot; -i /root/.ssh/nopwd -R 6666:localhost:22 remy@middleman -p 2222
</code></pre>

<p>Explanation&quot;of options:</p>

<ul>
<li>-M 10984: autossh monitoring port.</li>
<li>-o &quot;PubkeyAuthentication=yes&quot;: authenticate with ssh-keys instead of password.</li>
<li>-o &quot;PasswordAuthentication=no&quot;: explicitly disable password authentication.</li>
<li>-i /root/.ssh/nopwd: the location of the ssh key to use.</li>
<li>-R 6666:localhost:22: reverse tunnel. forward all traffic on port 6666 on host middleman to port 22 on host restricted machine.</li>
<li>remy@middleman -p 2222: ssh user remy, ssh host middleman, ssh port 2222</li>
</ul>

<p>If this all goes well you should be logged in to the middleman host without being asked for a password. You might get the question if you want to add the ssh key. Say yes to this.</p>

<p>If it does not go well, check the permissions on the ssh key (should be 600), and make sure you have the correct values in the autossh command. </p>

<h4>SSH back in the restricted host</h4>

<p>From another machine (outside the restricted network preferably) ssh into the middleman host.</p>

<p>Execute on: other machine</p>

<pre><code>ssh -p 2222 remy@middleman
</code></pre>

<p>From the middleman, ssh into the restricted host via the reverse tunnel we created:</p>

<p>Execute on: middleman</p>

<pre><code>ssh -p 6666 remy@127.0.0.1
</code></pre>

<p>If all goes well, you should see a prompt to login to the restricted machine. Enter your password and go. If this goes well, you can continue. If this does not work, check the values in the command and the ssh configs. Also make sure you have executed the steps above correctly.</p>

<h4>Enable the tunnel on boot</h4>

<p>We are going to edit the /etc/rc.local file. This script normally does nothing, but gets executed at boot. If you make any errors in this script, your machine might not boot so make sure to do this correctly.</p>

<p>Execute on: restricted machine</p>

<pre><code>sudo nano /etc/rc.local
</code></pre>

<p>Add (and change) the following line</p>

<pre><code>autossh -M 10984 -N -f -o &quot;PubkeyAuthentication=yes&quot; -o &quot;PasswordAuthentication=no&quot; -i /root/.ssh/nopwd -R 6666:localhost:22 remy@middleman -p 2222 &amp;
</code></pre>

<p>We have three new things in this command:</p>

<ul>
<li>-N: Do not execute a command on the middleman machine</li>
<li>-f: drop in the background</li>
<li>&amp;: Execute this command but do not wait for output or an exit code. If this is not added, your machine might hang at boot.</li>
</ul>

<p>Save the file, and as make it executable:</p>

<p>Execute on: restricted machine</p>

<pre><code>sudo chmod +x /etc/rc.local
</code></pre>

<p>And test it:</p>

<p>Execute on: restricted machine</p>

<pre><code>sudo /etc/rc.local
</code></pre>

<p>If you get your regular promt back without any output you&#39;ve done it correct.z</p>

<h4>Forward a website, not ssh</h4>

<p>You might want to forward a website on the restricted host. Follow the above tutorial, but change the autossh command:</p>

<pre><code>autossh -M 10984 -o &quot;PubkeyAuthentication=yes&quot; -o &quot;PasswordAuthentication=no&quot; -i /root/.ssh/nopwd -R 8888:localhost:80 remy@middleman -p 2222
</code></pre>

<ul>
<li>-R 8888:localhost:80: this forwards all traffic on host middleman to port 80 on host restrictedhost. (port 80 = website).</li>
</ul>

<h4>Other host inside restricted network</h4>

<p>You can also forward ports from other restricted hosts in the network:</p>

<pre><code>autossh -M 10984 -o &quot;PubkeyAuthentication=yes&quot; -o &quot;PasswordAuthentication=no&quot; -i /root/.ssh/nopwd -R 7777:host2.restrictednetwork:22 remy@middleman -p 2222
</code></pre>

<p>This will forward all traffic to port 7777 on host middleman, via host restrictedhost, to host host2.restrictednetwork port 22. </p>
<hr>
Tags: <a href="../tags/autossh.html" class="link">autossh, 
</a>
<a href="../tags/featured-one.html" class="link">featured-one, 
</a>
<a href="../tags/firewall.html" class="link">firewall, 
</a>
<a href="../tags/nat.html" class="link">nat, 
</a>
<a href="../tags/remote-access.html" class="link">remote-access, 
</a>
<a href="../tags/ssh.html" class="link">ssh, 
</a>
<div class="footer">
                <hr />
                <br />
                <p>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    var disqus_shortname = 'raymiiorg'; // required: replace example with your forum shortname
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </p>
        
                <hr>

                <p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br />

                <small></small></p>

                <small><iframe src="//crypto.stanford.edu/flashproxy/embed.html" width="80" height="15" frameborder="0" scrolling="no"></iframe></small>

                
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
     
    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "http://irixos.nl/piwik/" : "http://irixos.nl/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 2);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://irixos.nl/piwik/piwik.php?idsite=2" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->
    
    <!-- google analytics -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-3704876-6");
    pageTracker._trackPageview();
    } catch(err) {}</script>
    <!--end analytics -->
    </body>
    </html>
    