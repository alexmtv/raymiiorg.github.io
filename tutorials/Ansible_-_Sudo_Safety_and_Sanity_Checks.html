
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Ansible - /etc/sudoers safety and sanity checking in playbook - Raymii.org</title>
        <link href="/s/inc/css/bootstrap.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link rel="alternate" type="application/rss+xml" title="Raymii.org RSS" href="http://feeds.feedburner.com/Raymiiorg" />

    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
        <div class="row-fluid">
        
        <div class="span10 offset1">
                
            <div class="span4 well"> 
            
                <h1 class="topheader">Raymii.org</h1>
                <h6>Quis custodiet ipsos custodes?</h6>
                <h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS</a></h6>
            
            </div>

            <div class="span4 green-block">
                
                    <h3>Featured Items</h3>
    <a href="/s/tutorials/Ansible.html" class="whitelink">Ansible</a>
<br />
<a href="/s/tutorials/Autossh_persistent_tunnels.html" class="whitelink">Autossh persistent tunnels</a>
<br />
<a href="/s/static/Hosted_Piwik.html" class="whitelink">Hosted Piwik</a>
<br />
<a href="/s/tutorials/Munin_optimalization_on_Debian.html" class="whitelink">Munin optimalization on Debian</a>
<br />
<a href="/s/articles/Small_Linux_PCs.html" class="whitelink">Small Linux PCs</a>
<br />

            
        </div>
        <div class="span4 green-block">
            
                <h3>Featured Items</h3>
    <a href="/s/software/Bash_PHP_Server_Status_Monitor.html" class="whitelink">Bash PHP Server Status Monitor</a>
<br />
<a href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html" class="whitelink">IPSEC L2TP vpn with Ubuntu 12.04</a>
<br />
<a href="/s/software/Nopriv.py.html" class="whitelink">Nopriv.py</a>
<br />
<a href="/s/software/NutsManager.html" class="whitelink">NutsManager</a>
<br />
<a href="/s/tutorials/Tahoe_LAFS_Storage_Grid.html" class="whitelink">Tahoe LAFS Storage Grid</a>
<br />

            
        </div>
    </div>
    
    </div>
    <div class="row-fluid">
    <div class="span10 offset1">
    

    <div class="span3">
    <h3>Menu</h3><ul class="nav nav-pills nav-stacked">
<li><a href="/s/" class="link">Home</a>
</li>
<li><a href="/s/static/Contact.html" class="link">Contact</a>
</li>
<li><a href="/s/static/Disclaimer.html" class="link">Disclaimer</a>
</li>
<li><a href="/s/static/Hosted_Piwik.html" class="link">Hosted Piwik</a>
</li>
<li><a href="/s/static/Terrible-Linux.html" class="link">Terrible Linux</a>
</li>
</ul>
<h3>Categories</h3>
<ul class="nav nav-pills nav-stacked">
<li><a href="/s/articles" class="link">Articles</a>
</li>
<li><a href="/s/snippets" class="link">Snippets</a>
</li>
<li><a href="/s/software" class="link">Software</a>
</li>
<li><a href="/s/tutorials" class="link">Tutorials</a>
</li>
<li><a href="/s/everything.html" class="link">All Items</li>
</a>
</ul>
               <!-- advertisement start -->
                <hr class="alt2">
                <h2>Advertisement</h2>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Need a VPS server? InceptionHosting has excellent VPS servers located in the USA or NL!</a><p />
                <script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                /* Raymii-2 */
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script>
                <script type="text/javascript"
                src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>    
                <!-- advertisement end -->

           </div>  
           <div class="span7"> 
                <div class="inner">


           <h2>Ansible - /etc/sudoers safety and sanity checking in playbook</h2>
<ul class="breadcrumb">
<li><a href="../" class="link">Home</a>
<span class="divider">/</span></li>
<li><a href="../tutorials" class="link">Tutorials</a>
<span class="divider">/</span></li>
<li><a href="Ansible_-_Sudo_Safety_and_Sanity_Checks.html" class="link">Ansible - /etc/sudoers safety and sanity checking in playbook</a>
</li>
</ul>
<h6>Author: Remy Van Elst</h6>
<h6>Date: 23-03-2013</h6>
<br>
<p>Using Ansible to manage the /etc/sudoers file is fine, except when you have a syntax error in your template. This method helps you to only deploy a correct sudoers file. </p>

<p>I use <a href="http://ansible.cc">Ansible</a> on my servers, and I also manage the <code>sudo</code> config (<code>/etc/sudoers/</code>) via Ansible. My sudo playbook creates an admin group, adds me to that admin group, and sets some variables in <code>/etc/sudoers/</code>. I do not have a sudoers template file, because I created the playbook at a client which had various different sudoers files which they do not wanted to have changed because of different nagios checks that needed sudo on different hosts. However, if you start of clean, then a template file for <code>/etc/sudoers</code> is the best choice.</p>

<p>This is the playbook:</p>

<hr>

<ul>
<li><p>hosts: all
sudo: True
user: remy
connection: ssh # or paramiko</p>

<p>vars:
  date: $PIPE(date)
  distro: ${ansible<em>distribution}
  pkg</em>mgr: ${ansible<em>pkg</em>mgr}
  pbname: $inventory_hostname</p>

<p>tasks:</p>

<ul>
<li>name: Copy sudoers file for safety
command: cp -f /etc/sudoers /etc/sudoers.tmp</li>
<li>name: Create sudoers file backup
command: cp -f /etc/sudoers /etc/sudoers.${date}.bak</li>
<li>name: Create admins group
group: name=admins system=yes state=present</li>
<li>name: make sure we can sudo as admin group
lineinfile: dest=/etc/sudoers.tmp state=present regexp=&#39;^%admin&#39; line=&#39;%admin ALL=(ALL) ALL&#39;</li>
<li>name: also make sure ssh-agent works via sudo
lineinfile: dest=/etc/sudoers.tmp state=present regexp=&#39;^Defaults env<em>keep+\=SSH</em>AUTH<em>SOCK&#39; line=&#39;Defaults env</em>keep+=SSH<em>AUTH</em>SOCK&#39;</li>
<li>name: Final sudoers file check
shell: visudo -q -c -f /etc/sudoers.tmp &amp;&amp; cp -f /etc/sudoers.tmp /etc/sudoers</li>
<li>We create the <code>admins</code> group, to which all users that need sudo are added by other playbooks.<br></li>
<li>We copy the remote sudoers file to a temp one and perform all actions on the temp sudoers file. We also back up the sudoers file.</li>
<li>We enable the <code>admins</code> group to sudo</li>
<li>We make sure <code>ssh-agent</code> works via sudo. This was used for a git repository on the root user account, to show our own names in the commits.</li>
<li>Finally we use <code>visudo</code> to check if the file is correct, and if so we copy the file over the &quot;original&quot; sudos file.</li>
</ul></li>
</ul>

<p>By using the temp file we make sure we don&#39;t have any syntax errors and lock ourselves out of machines, needing to use ILO/DRAC to reset passwords and such. Been there, done that, not funny at all.</p>
<hr>
Tags: <a href="../tags/ansible.html" class="link">ansible, 
</a>
<a href="../tags/configuration-management.html" class="link">configuration-management, 
</a>
<a href="../tags/deployment.html" class="link">deployment, 
</a>
<a href="../tags/python.html" class="link">python, 
</a>
<a href="../tags/sudo.html" class="link">sudo, 
</a>
<a href="../tags/sudoers.html" class="link">sudoers, 
</a>
<a href="../tags/visudo.html" class="link">visudo, 
</a>
<div class="footer">
                <hr />
                <br />
        
                <hr>

                <p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br />

                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
     
    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->
    
    <!-- google analytics -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-3704876-6");
    pageTracker._trackPageview();
    } catch(err) {}</script>
    <!--end analytics -->
    </body>
    </html>
    