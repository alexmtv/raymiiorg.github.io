<!DOCTYPE html><html lang="en"><head><title>Munin optimization guide for Debian (rrdcached, tmpfs, ionice and nice) - Raymii.org</title><link href="/s/inc/css/light.css" rel="stylesheet" title="light"/><link href="/s/inc/css/dark.css" rel="alternate stylesheet" title="dark"/><script src="/s/inc/js/jquery-2.1.1.min.js"></script><script src="/s/inc/js/bootstrap.3.2.0.min.js"></script><script src="/s/inc/js/styleswitcher.js"></script><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="https://raymii.org/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Items</a></li><li><a class="link" href="/s/tags/bash.html">Bash</a></li><li><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li><a class="link" href="/s/tags/ssl.html">SSL</a></li><li><a class="link" href="/s/tags/debian.html">Debian</a></li><li><a class="link" href="/s/tags/python.html">Python</a></li><li><a class="link" href="/s/tags/vpn.html">VPN</a></li><li><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li><a class="link" href="/s/tags/nginx.html">nginx</a></li><li><a class="link" href="/s/tags/apache.html">Apache</a></li><li><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><ul class="navbar-collapse nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Style<b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#" onclick="setActiveStyleSheet('dark')">Dark</a></li><li><a href="#" onclick="setActiveStyleSheet('light')">Light</a></li></ul></li></ul><br/><br/><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link</a><br/><script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">Munin optimization guide for Debian (rrdcached, tmpfs, ionice and nice)</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../tutorials/index.html">Tutorials</a></li><li><a class="link" href="Munin_optimalization_on_Debian.html">Munin optimization guide for Debian (rrdcached, tmpfs, ionice and nice)</a></li></ul><p><small>08-12-2012</small> | <small>Remy van Elst</small></p><div class="ad"><script type="text/javascript"><!--
                            google_ad_client = "ca-pub-7993642564731324";
                            /* voorartikel */
                            google_ad_slot = "6172324376";
                            google_ad_width = 728;
                            google_ad_height = 90;
                            //-->
                            </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                            </script></div><br/><p>This guide will help you tune the performance of Munin. When Munin monitors more than a few hosts the performance goes down and it requires more resources. This gets better with newer releases, but it still is not perfect. You can limit munin yourself so that the IO performance gets better.</p><p>This guide assumes a working munin setup (1.4 or 2.0) on debian/ubuntu. It also assumes root access to the server (either su or sudo).</p><h4>rrdcached</h4><p>rrdcached is as the name implies a caching daemon for rrd. Munin uses rrd for the database, and updates the rrd files every 5 minutes, which gives a lot of random IO. rrdcached makes the writes more sequential and less often.</p><p><em>Do note that rrdcached is only fully supported in munin 2.0. Usage on 1.4 is not supported.</em></p><p>First install it:</p><pre><code>apt-get install rrdcached
</code></pre><p>Then run the below command to create an rrd socket</p><pre><code>sudo -u munin /usr/bin/rrdcached 
  -p /run/munin/rrdcached.pid 
  -B -b /var/lib/munin/ 
  -F -j /var/lib/munin/rrdcached-journal/ 
  -m 0660 -l unix:/run/munin/rrdcached.sock 
  -w 1800 -z 1800 -f 3600
</code></pre><p>Make sure to add it to <code>/etc/rc.local</code>.</p><p>Now add the following to your <code>/etc/munin/munin.conf</code> to enable the socket:</p><pre><code>rrdcached_socket /run/munin/rrdcached.sock
</code></pre><p>Some info about the command:</p><pre><code>RRDCached writes the spool data every 5 minutes by default. This is the same as the munin master. To have an effect, change the flushing intervals to allow more data to be spooled. Use the following parameters, and tune to your liking:

-w 1800 Wait 30 minutes before writing data
-z 1800 Delay writes by a random factor of up to 30 minutes (this should be equal to, or lower than, -w)
-f 3600 Flush all data every hour
</code></pre><p>By default munin-graph runs every 5 minutes so the caching we do above will not work if the data is read every 5 minutes. To solve this we split the munin-updating and the munin-graphing.</p><p>Edit the file <code>/etc/cron.d/munin</code>, add the following line:</p><pre><code>10 * * * *      munin if [ -x /usr/bin/munin-graph ]; then /usr/bin/munin-graph; fi
</code></pre><p>The file <code>/usr/bin/munin-graph</code> does not exist yet, we are going to create it:</p><pre><code>nano /usr/bin/munin-graph
</code></pre><p>Now add this:</p><pre><code>#!/bin/bash
# We always launch munin-html.
# It is a noop if html_strategy is &amp;quot;cgi&amp;quot;
nice /usr/share/munin/munin-html $@ || exit 1

# The result of munin-html is needed for munin-graph.
# It is a noop if graph_strategy is &amp;quot;cgi&amp;quot;
nice /usr/share/munin/munin-graph --cron $@ || exit 1 
</code></pre><p>and make it executable:</p><pre><code>chmod +x /usr/bin/munin-graph
</code></pre><p>Now we edit the <code>/usr/bin/munin-cron</code> file and comment out the lines we put in the <code>munin-graph</code> file:</p><pre><code>[...]
# We always launch munin-html.
# It is a noop if html_strategy is &amp;quot;cgi&amp;quot;
# nice /usr/share/munin/munin-html $@ || exit 1

# The result of munin-html is needed for munin-graph.
# It is a noop if graph_strategy is &amp;quot;cgi&amp;quot;
# nice /usr/share/munin/munin-graph --cron $@ || exit 1   
</code></pre><p>By doing this, the munin-update runs every 5 minutes, and the graphing and HTML page creation runs only once per hour. This prevents data loss, and I dont think you are going to look at the graphs every 5 minutes. Whenever you need to have faster updates, just change the crontab file to also create the munin-graphs more often.</p><h4>nice and ionice</h4><p>This little tweak to the munin-cron file makes it IO and CPU friendlier. Note that you need to use the default disk-scheduler for the ionice to work. Also check the syntax of the nice command, different versions exist.</p><p>Edit the <code>/etc/cron.d/munin</code> file and change the cronjob:</p><pre><code>*/5 * * * *     munin if [ -x /usr/bin/munin-cron ]; then /usr/bin/ionice -c 3 /usr/bin/nice -n 19 /usr/bin/munin-cron; fi
</code></pre><p>If you have applied the above tweak with rrdcached then you can also make the other cronjob nicer:</p><pre><code>10 * * * *      munin if [ -x /usr/bin/munin-graph ]; then /usr/bin/ionice -c 3 /usr/bin/nice -n 19 /usr/bin/munin-graph; fi
</code></pre><h4>munin html and graphs in RAM</h4><p>By mounting the folder where munin creates the HTML (in my case <code>/var/www/munin</code>) we lower the IO a bit more because it is written to the RAM instead of the disk. Data loss after a power outage/reboot is not an issue, because the html and graphs are generated fresh every time.</p><p>Edit <code>/etc/fstab</code> and add the following (be careful not to change something else):</p><pre><code>tmpfs  /var/www/munin   tmpfs   rw,mode=755,uid=munin,gid=munin,size=150M   0 0
</code></pre><p>Because my munin-server has 256MB RAM I give it a 150M size. If you have more RAM available you can easisly up this to 1000 M. If you save your munin graphs somewhere else (check the <code>htmldir</code> variable in <code>/etc/munin/munin.conf</code>) the make sure you change that as well.</p><p>Now make sure it is mounted by executing the following:</p><pre><code>mount -a
</code></pre><h4>cgi strategy</h4><p>Another way to up the performance of Munin is by using a cgi-based graph strategy. However, for me this made the munin webinterface terribly slow and unworkable so I will not cover that here.</p><h4>Links</h4><ul><li><a href="http://munin.readthedocs.org/en/latest/master/rrdcached.html">http://munin.readthedocs.org/en/latest/master/rrdcached.html</a></li><li><a href="http://blog.pwkf.org/post/2011/06/Enhance-RRD-I/O-performance-in-Munin-1.4-and-Scale">http://blog.pwkf.org/post/2011/06/Enhance-RRD-I/O-performance-in-Munin-1.4-and-Scale</a></li><li><a href="http://beeznest.wordpress.com/2012/06/25/munin-2-0-on-debian-2/">http://beeznest.wordpress.com/2012/06/25/munin-2-0-on-debian-2/</a></li><li><a href="http://www.jethrocarr.com/2012/05/26/munin-performance/">http://www.jethrocarr.com/2012/05/26/munin-performance/</a></li></ul><hr/>Tags: <a class="link" href="../tags/debian.html">debian,</a><a class="link" href="../tags/ionice.html">ionice,</a><a class="link" href="../tags/monitoring.html">monitoring,</a><a class="link" href="../tags/munin.html">munin,</a><a class="link" href="../tags/nice.html">nice,</a><a class="link" href="../tags/performance.html">performance,</a><a class="link" href="../tags/rrdcached.html">rrdcached,</a><a class="link" href="../tags/tmpfs.html">tmpfs,</a><a class="link" href="../tags/ubuntu.html">ubuntu,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>