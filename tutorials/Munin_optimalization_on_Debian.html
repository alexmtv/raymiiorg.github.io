
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Munin optimalization guide for Debian (rrdcached, tmpfs, ionice and nice) - Raymii.org</title>
        <link href="/s/inc/css/bootstrap.css" rel="stylesheet" />
        <link href="/s/inc/js/google-code-prettify/prettify.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
        <div class="row-fluid">
        
        <div class="span10 offset1">
                
            <div class="span4 well"> 
            
                <h1 class="topheader">Raymii.org</h1>
                <h6>Quis custodiet ipsos custodes?</h6>
                <h6><a href="/s/feed.xml">RSS</a></h6>
            
            </div>

            <div class="span4 green-block">
                
                    <h3>Featured Items</h3>
    <a href="/s/tutorials/Ansible.html" class="whitelink">Ansible</a>
<br />
<a href="/s/tutorials/Autossh_persistent_tunnels.html" class="whitelink">Autossh persistent tunnels</a>
<br />
<a href="/s/software/Codename_Geld.html" class="whitelink">Codename Geld</a>
<br />
<a href="/s/tutorials/Munin_optimalization_on_Debian.html" class="whitelink">Munin optimalization on Debian</a>
<br />
<a href="/s/articles/Small_Linux_PCs.html" class="whitelink">Small Linux PCs</a>
<br />

            
        </div>
        <div class="span4 green-block">
            
                <h3>Featured Items</h3>
    <a href="/s/software/Bash_PHP_Server_Status_Monitor.html" class="whitelink">Bash PHP Server Status Monitor</a>
<br />
<a href="/s/articles/Encryption-on-ANY-cloud-service.html" class="whitelink">Encryption on ANY cloud service</a>
<br />
<a href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html" class="whitelink">IPSEC L2TP vpn with Ubuntu 12.04</a>
<br />
<a href="/s/software/NutsManager.html" class="whitelink">NutsManager</a>
<br />
<a href="/s/tutorials/Tahoe_LAFS_Storage_Grid.html" class="whitelink">Tahoe LAFS Storage Grid</a>
<br />

            
        </div>
    </div>
    
    </div>
    <div class="row-fluid">
    <div class="span10 offset1">
    

    <div class="span3">
    <h3>Menu</h3><ul class="nav nav-pills nav-stacked">
<li><a href="/s/" class="link">Home</a>
</li>
<li><a href="/s/static/Contact.html" class="link">Contact</a>
</li>
<li><a href="/s/static/Disclaimer.html" class="link">Disclaimer</a>
</li>
<li><a href="/s/static/Terrible-Linux.html" class="link">Terrible Linux</a>
</li>
</ul>
<h3>Categories</h3>
<ul class="nav nav-pills nav-stacked">
<li><a href="/s/articles" class="link">Articles</a>
</li>
<li><a href="/s/snippets" class="link">Snippets</a>
</li>
<li><a href="/s/software" class="link">Software</a>
</li>
<li><a href="/s/tutorials" class="link">Tutorials</a>
</li>
</ul>
               <!-- advertisement start -->
                <hr class="alt2">
                <h2>Advertisement</h2>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Need a VPS server? InceptionHosting has excellent VPS servers located in the USA or NL!</a><p />
                <script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                /* Raymii-2 */
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script>
                <script type="text/javascript"
                src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>    
                <!-- advertisement end -->

           </div>  
           <div class="span7"> 
                <div class="inner">


           <h2>Munin optimalization guide for Debian (rrdcached, tmpfs, ionice and nice)</h2>
<ul class="breadcrumb">
<li><a href="../" class="link">Home</a>
<span class="divider">/</span></li>
<li><a href="../tutorials" class="link">Tutorials</a>
<span class="divider">/</span></li>
<li><a href="Munin_optimalization_on_Debian.html" class="link">Munin optimalization guide for Debian (rrdcached, tmpfs, ionice and nice)</a>
</li>
</ul>
<h6>Author: Remy Van Elst</h6>
<h6>Date: 12-12-2012</h6>
<br>
<p>This guide will help you tune the performance of Munin. When Munin monitors more than a few hosts the performance goes down and it requires more resources. This gets better with newer releases, but it still is not perfect. You can limit munin yourself so that the IO performance gets better.</p>

<p>This guide assumes a working munin setup (1.4 or 2.0) on debian/ubuntu. It also assumes root access to the server (either su or sudo).</p>

<h4>rrdcached</h4>

<p>rrdcached is as the name implies a caching daemon for rrd. Munin uses rrd for the database, and updates the rrd files every 5 minutes, which gives a lot of random IO. rrdcached makes the writes more sequential and less often.</p>

<p><em>Do note that rrdcached is only fully supported in munin 2.0. Usage on 1.4 is not supported.</em></p>

<p>First install it:</p>

<pre><code>apt-get install rrdcached
</code></pre>

<p>Then run the below command to create an rrd socket </p>

<pre><code>sudo -u munin /usr/bin/rrdcached \
  -p /run/munin/rrdcached.pid \
  -B -b /var/lib/munin/ \
  -F -j /var/lib/munin/rrdcached-journal/ \
  -m 0660 -l unix:/run/munin/rrdcached.sock \
  -w 1800 -z 1800 -f 3600
</code></pre>

<p>Make sure to add it to <code>/etc/rc.local</code>. </p>

<p>Now add the following to your <code>/etc/munin/munin.conf</code> to enable the socket:</p>

<pre><code>rrdcached_socket /run/munin/rrdcached.sock
</code></pre>

<p>Some info about the command:</p>

<pre><code>RRDCached writes the spool data every 5 mintes by default. This is the same as the munin master. To have an effect, change the flushing intervals to allow more data to be spooled. Use the following parameters, and tune to your liking:

-w 1800 Wait 30 minutes before writing data
-z 1800 Delay writes by a random factor of up to 30 minutes (this should be equal to, or lower than, -w)
-f 3600 Flush all data every hour
</code></pre>

<p>By default munin-graph runs every 5 minutes so the caching we do above will not work if the data is read every 5 minutes. To solve this we split the munin-updating and the munin-graphing.</p>

<p>Edit the file <code>/etc/cron.d/munin</code>, add the following line:</p>

<pre><code>10 * * * *      munin if [ -x /usr/bin/munin-graph ]; then /usr/bin/munin-graph; fi
</code></pre>

<p>The file <code>/usr/bin/munin-graph</code> does not exist yet, we are going to create it:</p>

<pre><code>nano /usr/bin/munin-graph
</code></pre>

<p>Now add this:</p>

<pre><code>#!/bin/bash
# We always launch munin-html.
# It is a noop if html_strategy is &quot;cgi&quot;
nice /usr/share/munin/munin-html $@ || exit 1

# The result of munin-html is needed for munin-graph.
# It is a noop if graph_strategy is &quot;cgi&quot;
nice /usr/share/munin/munin-graph --cron $@ || exit 1 
</code></pre>

<p>and make it executable:</p>

<pre><code>chmod +x /usr/bin/munin-graph
</code></pre>

<p>Now we edit the <code>/usr/bin/munin-cron</code> file and comment out the lines we put in the <code>munin-graph</code> file:</p>

<pre><code>[...]
# We always launch munin-html.
# It is a noop if html_strategy is &quot;cgi&quot;
# nice /usr/share/munin/munin-html $@ || exit 1

# The result of munin-html is needed for munin-graph.
# It is a noop if graph_strategy is &quot;cgi&quot;
# nice /usr/share/munin/munin-graph --cron $@ || exit 1   
</code></pre>

<p>By doing this, the munin-update runs every 5 minutes, and the graphing and HTML page creation runs only once per hour. This prevents data loss, and I dont think you are going to look at the graphs every 5 minutes. Whenever you need to have faster updates, just change the crontab file to also create the munin-graphs more often. </p>

<h4>nice and ionice</h4>

<p>This little tweak to the munin-cron file makes it IO and CPU friendlier. Note that you need to use the default disk-scheduler for the ionice to work. Also check the syntax of the nice command, different versions exist.</p>

<p>Edit the <code>/etc/cron.d/munin</code> file and change the cronjob:</p>

<pre><code>*/5 * * * *     munin if [ -x /usr/bin/munin-cron ]; then /usr/bin/ionice -c 3 /usr/bin/nice -n 19 /usr/bin/munin-cron; fi
</code></pre>

<p>If you have applied the above tweak with rrdcached then you can also make the other cronjob nicer:</p>

<pre><code>10 * * * *      munin if [ -x /usr/bin/munin-graph ]; then /usr/bin/ionice -c 3 /usr/bin/nice -n 19 /usr/bin/munin-graph; fi
</code></pre>

<h4>munin html and graphs in RAM</h4>

<p>By mounting the folder where munin creates the HTML (in my case <code>/var/www/munin</code>) we lower the IO a bit more because it is written to the RAM instead of the disk. Data loss after a power outage/reboot is not an issue, because the html and graphs are generated fresh every time. </p>

<p>Edit <code>/etc/fstab</code> and add the following (be carefull not to change something else):</p>

<pre><code>tmpfs  /var/www/munin   tmpfs   rw,mode=755,uid=munin,gid=munin,size=150M   0 0
</code></pre>

<p>Beacuse my munin-server has 256MB RAM I give it a 150M size. If you have more RAM available you can easisly up this to 1000 M. If you save your munin graphs somewhere else (check the <code>htmldir</code> variable in <code>/etc/munin/munin.conf</code>) the make sure you change that as well.</p>

<p>Now make sure it is mounted by executing the following:</p>

<pre><code>mount -a
</code></pre>

<h4>cgi strategy</h4>

<p>Another way to up the performance of Munin is by using a cgi-based graph strategy. However, for me this made the munin webinterface terribly slow and unworkable so I will not cover that here. </p>

<h4>Links</h4>

<ul>
<li><a href="http://munin.readthedocs.org/en/latest/master/rrdcached.html">http://munin.readthedocs.org/en/latest/master/rrdcached.html</a></li>
<li><a href="http://blog.pwkf.org/post/2011/06/Enhance-RRD-I/O-performance-in-Munin-1.4-and-Scale">http://blog.pwkf.org/post/2011/06/Enhance-RRD-I/O-performance-in-Munin-1.4-and-Scale</a></li>
<li><a href="http://beeznest.wordpress.com/2012/06/25/munin-2-0-on-debian-2/">http://beeznest.wordpress.com/2012/06/25/munin-2-0-on-debian-2/</a></li>
<li><a href="http://www.jethrocarr.com/2012/05/26/munin-performance/">http://www.jethrocarr.com/2012/05/26/munin-performance/</a></li>
</ul>
<hr>
Tags: <a href="../tags/debian.html" class="link">debian, 
</a>
<a href="../tags/featured-one.html" class="link">featured-one, 
</a>
<a href="../tags/ionice.html" class="link">ionice, 
</a>
<a href="../tags/monitoring.html" class="link">monitoring, 
</a>
<a href="../tags/munin.html" class="link">munin, 
</a>
<a href="../tags/nice.html" class="link">nice, 
</a>
<a href="../tags/performance.html" class="link">performance, 
</a>
<a href="../tags/rrdcached.html" class="link">rrdcached, 
</a>
<a href="../tags/tmpfs.html" class="link">tmpfs, 
</a>
<a href="../tags/ubuntu.html" class="link">ubuntu, 
</a>
<div class="footer">
                <hr />
                <br />
                <p>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'raymiiorg'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </p>
        
                <hr>

                <p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br />

                <small></small></p>

                <small><a href="http://validator.w3.org/check/referer" target="_blank">Validate XHTML</a></small>

                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>    
    </body>
    </html>
    