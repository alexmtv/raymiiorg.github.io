<!DOCTYPE html><html lang="en"><head><title>Set up a federated XMPP Chat Network with ejabberd, your own Google Talk/Hangouts alternative - Raymii.org</title><link href="/s/inc/css/light.css" rel="stylesheet" title="light"/><link href="/s/inc/css/dark.css" rel="alternate stylesheet" title="dark"/><script async="" src="/s/inc/js/jquery-2.1.1.min.js"></script><script async="" src="/s/inc/js/bootstrap.3.2.0.min.js"></script><script async="" src="/s/inc/js/styleswitcher.js"></script><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="https://raymii.org/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Items</a></li><li><a class="link" href="/s/tags/bash.html">Bash</a></li><li><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li><a class="link" href="/s/tags/ssl.html">SSL</a></li><li><a class="link" href="/s/tags/debian.html">Debian</a></li><li><a class="link" href="/s/tags/python.html">Python</a></li><li><a class="link" href="/s/tags/vpn.html">VPN</a></li><li><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li><a class="link" href="/s/tags/nginx.html">nginx</a></li><li><a class="link" href="/s/tags/openstack.html">Openstack</a></li><li><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><ul class="navbar-collapse nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Style<b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#" onclick="setActiveStyleSheet('dark')">Dark</a></li><li><a href="#" onclick="setActiveStyleSheet('light')">Light</a></li></ul></li></ul><br/><br/><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link</a><br/><script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">Set up a federated XMPP Chat Network with ejabberd, your own Google Talk/Hangouts alternative</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../tutorials/index.html">Tutorials</a></li><li><a class="link" href="Set_up_a_federated_XMPP_Chat_Network_with_ejabberd.html">Set up a federated XMPP Chat Network with ejabberd, your own Google Talk/Hangouts alternative</a></li></ul><p><small>11-06-2013</small> | <small>Remy van Elst</small></p><div class="ad"><script type="text/javascript"><!--
                            google_ad_client = "ca-pub-7993642564731324";
                            /* voorartikel */
                            google_ad_slot = "6172324376";
                            google_ad_width = 728;
                            google_ad_height = 90;
                            //-->
                            </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                            </script></div><br/><p>This tutorial shows you how to set up your own federated chat network using ejabberd. It covers a basic single node ejabberd server and also the setup of an ejabberd cluster, including errors and DNS SRV record examples. Last but not least federation is also covered. You can use an <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting VPS to set up your own XMPP server, I use them and they are very stable and offer good performance and pricing.</a></p><h3>Why set up your own XMPP server</h3><p>There are a few reasons to set up your own XMPP server.</p><p>You might use Google Talk or as it now is named Hangouts. Google's service recently changed and it is going to drop XMPP compatibility. If you have non-gmail chat contacts you can keep chatting to them. And still use an open protocol which is widely supported, not being locked in to google specific software and hardware.</p><p>Or you might want to have more control over the logging of your data. Turn of ejabberd logging and use <a href="http://otr.cypherpunks.ca/">Off The Record</a> which gives you full privacy (and perfect forward secrecy).</p><p>You might want to use awesome multi-account chatting applications like <a href="http://pidgin.im/">Pidgin</a>, <a href="http://psi-im.org/">Psi+</a>, <a href="https://live.gnome.org/Empathy">Empathy</a>, <a href="http://adium.im/">Adium</a>, iChat/Messages or Miranda IM. And on Android you can use <a href="http://www.xabber.com/">Xabber</a>, <a href="http://beem-project.com/">Beem</a> or <a href="http://oneteam.im/">OneTeam</a>. Did you know that big players like Facebook, WhatsApp and Google (used) to use XMPP as their primary chat protocol?</p><p>Or you might be a sysadmin in need of an internal chat solution. I've got a ejabberd cluster running for a client consisting of 4 Debian 7 VM's (2GB RAM each) spread over 3 sites and 1 datacenter, serving 12000 total users and most of the time 6000 concurrently.</p><p>XMPP is an awesome and extendible protocol, on which you can find more here: <a href="https://en.wikipedia.org/wiki/XMPP">https://en.wikipedia.org/wiki/XMPP</a></p><h3>Information</h3><p>This setup is tested on Debian 7, Ubuntu 12.04 and 10.04 and OS X 10.8 Server, all running <code>ejabberd</code> installed via the package manager, either <code>apt</code> or <code>ports</code>. It also works on Windows Server 2012 with the <code>ejabberd</code> compiled from the <code>erlang</code> source but that is not covered in this tutorial.</p><p>This tutorial uses the <code>example.org</code> domain as the chat domain, and the server <code>chat.example.org</code> as the xmpp server domain. For the clustering part the servers <code>srv1.example.org</code> and <code>srv2.example.org</code> are used. Replace these values for your setup.</p><h3>Single node / master node ejabberd installation</h3><p>If you want to set up a single node installation of ejabberd, e.g. no clustering, then follow only this part and the DNS part of the tutorial. If you want to set up a cluster, then also follow this part and continue with the next part.</p><h4>Installing Ejabberd</h4><p>This is simple, use your package manager to install ejabberd:</p><pre><code>apt-get install ejabberd
</code></pre><p>You will also install a few dependencies for the erlang runtime.</p><h4>Configuring ejabberd</h4><p>We are going to configure the <code>ejabberd</code> service. First stop it:</p><pre><code>/etc/init.d/ejabberd stop
</code></pre><p>Now use your favorite text editor to edit the config files. The ejabberd config is erlang config, so comments are not <code>#</code> but <code>%%</code>. Also, every config option ends with a dot <code>(.)</code>.</p><pre><code>vim /etc/ejabberd/ejabberd.cfg
</code></pre><p>First we are going to add our chat domain name:</p><pre><code>{hosts, ["example.org"]}.
</code></pre><p>If you want more domains then you add them as shown below:</p><pre><code>{hosts, ["sparklingclouds.nl", "raymii.org", "sparklingnetwork.nl"]}.
</code></pre><p>This domain name is not the name of the servers you are adding.</p><p>Next we define an admin user:</p><pre><code>{acl, admin, {user, "remy", "example.org"}}.
</code></pre><p><code>remy</code> corresponds with the part before the <code>@</code> in the XMPP ID, and <code>example.org</code> with the part after. If you need more admin users, add another ACL line.</p><p>Now if you want people to be able to register via their XMPP client enable in band registration:</p><pre><code>{access, register, [{allow, all}]}.
</code></pre><p>If you are using MySQL or LDAP authentication then you wouldn't enable this.</p><p>I like to have a shared roster with roster groups, and some clients of mine use a shared roster with everybody so that nobody has to add contacts but they see all online users, enable the mod<em>shared</em>roster:</p><pre><code>%% Do this in the modules block
  {mod_shared_roster,[]},
</code></pre><p>If you are pleased with the config file, save it and restart ejabberd:</p><pre><code>/etc/init.d/ejabberd restart
</code></pre><p>We now need to register a user to test our setup. If you've enabled in-band registration you can use your XMPP client, and if you did not enable in-band registration you can use the <code>ejabberdctl</code> command:</p><pre><code>ejabberdctl register remy example.org 'passw0rd'
</code></pre><p>Now test it using an XMPP client like Pidgin, Psi+ or Empathy. If you can connect, then you can continue with the tutorial. If you cannot connect, check your ejabberd logs, firewall setting and such to troubleshoot it.</p><h3>Clustering ejabberd</h3><p>Note that you have to have a correctly working master node to continue with the ejabberd clustering. If your master node is not working then fix that first.</p><p>Important: the modules you use should be the same on every cluster node. If you use LDAP/MySQL authentication, or a shared_roster, or special MUC settings, or offline messaging, for the clustering this does not matter as long as it is on all nodes.</p><p>So lets get started. We are first going to configure the master node, and then the slave nodes.</p><h4>Prepare the master node</h4><p>Stop the ejabberd server on the master and edit the <code>/etc/default/ejabberd</code> file:</p><pre><code>vim /etc/default/ejabberd
</code></pre><p>Uncomment the hostname option and change it to a FQDN hostname:</p><pre><code>ERLANG_NODE=ejabberd@srv1.example.org
</code></pre><p>And add the external (public) IP addres as a tuple (no dots but comma's):</p><pre><code>INET_DIST_INTERFACE={20,30,10,5}
</code></pre><p>If you use ejabberd internally then use the primary NIC address.</p><p>We are going to remove all the mnesia tables. They will be rebuilt with an ejabberd restart. This is way easier then changing the mnesia data itself. Don't do this on a already configured node without backing up the erlang cookie.</p><p>First backup the erlang cookie:</p><pre><code>cp /var/lib/ejabberd/.erlang.cookie ~/
</code></pre><p>Then remove the mnesia database:</p><pre><code>rm /var/lib/ejabberd/*
</code></pre><p>And restore the erlang cookie:</p><pre><code>cp ~/.erlang.cookie /var/lib/ejabberd/.erlang.cookie
</code></pre><p>To make sure all erlang processes are stopped kill all processes from the ejabberd user. This is not needed but the <code>epmd</code> supervisor process might still be running:</p><pre><code>killall -u ejabberd
</code></pre><p>And start ejabberd again:</p><pre><code>/etc/init.d/ejabberd start 
</code></pre><p>If you can still connect and chat, then continue with the next part, configuring the slave nodes.</p><h4>Prepare the slave nodes</h4><p>*A slave node should first be configured and working as described in the first part of this tutorial. You can copy the config files from the master node. *</p><p>Stop the ejabberd server:</p><pre><code>/etc/init.d/ejabberd stop
</code></pre><p>Stop the ejabberd server on the master and edit the <code>/etc/default/ejabberd</code> file:</p><pre><code>vim /etc/default/ejabberd
</code></pre><p>Uncomment the hostname option and change it to a FQDN hostname:</p><pre><code>ERLANG_NODE=ejabberd@srv2.example.org
</code></pre><p>And add the external (public) IP addres as a tuple (no dots but comma's):</p><pre><code>INET_DIST_INTERFACE={30,40,20,6}
</code></pre><p>If you use ejabberd internally then use the primary NIC address.</p><p>Now remove all the mnesia tables:</p><pre><code>rm /var/lib/ejabberd/*
</code></pre><p>Copy the cookie from the ejabberd master node, either by <code>cat</code> and <code>vim</code> or via <code>scp</code>:</p><pre><code># On the master node
cat /var/lib/ejabberd/.erlang.cookie
HFHHGYYEHF362GG1GF

# On the slave node
echo "HFHHGYYEHF362GG1GF" &gt; /var/lib/ejabberd/.erlang.cookie
chown ejabberd:ejabberd /var/lib/ejabberd/.erlang.cookie
</code></pre><p>We are now going to add and compile an erlang module, the easy_cluster module. This is a very small module which adds an erlang shell command to make the cluster addition easier. You can also execute the commands in the erlang functions itself on an erlang debug shell, but I find this easier and it gives less errors:</p><pre><code>vim /usr/lib/ejabberd/ebin/easy_cluster.erl
</code></pre><p>Add the following contents:</p><pre><code>-module(easy_cluster).

-export([test_node/1,join/1]).

test_node(MasterNode) -&gt;
    case net_adm:ping(MasterNode) of 'pong' -&gt;
        io:format("server is reachable.~n");
    _ -&gt;
        io:format("server could NOT be reached.~n")
    end.

join(MasterNode) -&gt;
    application:stop(ejabberd),
    mnesia:stop(),
    mnesia:delete_schema([node()]),
    mnesia:start(),
    mnesia:change_config(extra_db_nodes, [MasterNode]),
    mnesia:change_table_copy_type(schema, node(), disc_copies),
    application:start(ejabberd).
</code></pre><p>Save it and compile it into a working erlang module:</p><pre><code>cd /usr/lib/ejabberd/ebin/
erlc easy_cluster.erl
</code></pre><p>Now check if it succeeded:</p><pre><code>ls | grep easy_cluster.beam
</code></pre><p>If you see the file it worked. You can find more info on the module here: <a href="https://github.com/chadillac/ejabberd-easy_cluster/">https://github.com/chadillac/ejabberd-easy_cluster/</a></p><p>We are now going to join the cluster node to the master node. Make sure the master is working and running. Also make sure the erlang cookies are synchronized.</p><p>On the slave node, start an ejabberd live shell:</p><pre><code>/etc/init.d/ejabberd live
</code></pre><p>This will start an erlang shell and it will give some output. If it stops outputting then you can press <code>ENTER</code> to get a prompt. Enter the following command to test if the master node can be reached:</p><pre><code>easy_cluster:test_node('ejabberd@srv1.example.org').
</code></pre><p>You should get the following response: <code>server is reachable</code>. If so, continue.</p><p>Enter the following command to actually join the node:</p><pre><code>easy_cluster:join('ejabberd@srv1.example.org').
</code></pre><p>Here's example output from a successful test and join join:</p><pre><code>/etc/init.d/ejabberd live
*******************************************************
* To quit, press Ctrl-g then enter q and press Return *
*******************************************************

Erlang R15B01 (erts-5.9.1) [source] [async-threads:0] [kernel-poll:false]

Eshell V5.9.1  (abort with ^G)

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.39.0&gt;:cyrsasl_digest:44) : FQDN used to check DIGEST-MD5 SASL authentication: "srv2.example.org"

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.576.0&gt;:ejabberd_listener:166) : Reusing listening port for 5222

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.577.0&gt;:ejabberd_listener:166) : Reusing listening port for 5269

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.578.0&gt;:ejabberd_listener:166) : Reusing listening port for 5280

=INFO REPORT==== 10-Jun-2013::20:38:15 ===
I(&lt;0.39.0&gt;:ejabberd_app:72) : ejabberd 2.1.10 is started in the node 'ejabberd@srv2.example.org'
easy_cluster:test_node('ejabberd@srv1.example.org').
server is reachable.
ok
(ejabberd@srv2.example.org)2&gt; easy_cluster:join('ejabberd@srv1.example.org').

=INFO REPORT==== 10-Jun-2013::20:38:51 ===
I(&lt;0.39.0&gt;:ejabberd_app:89) : ejabberd 2.1.10 is stopped in the node 'ejabberd@srv2.example.org'

=INFO REPORT==== 10-Jun-2013::20:38:51 ===
    application: ejabberd
    exited: stopped
    type: temporary

=INFO REPORT==== 10-Jun-2013::20:38:51 ===
    application: mnesia
    exited: stopped
    type: permanent

=INFO REPORT==== 10-Jun-2013::20:38:52 ===
I(&lt;0.628.0&gt;:cyrsasl_digest:44) : FQDN used to check DIGEST-MD5 SASL authentication: "srv2.example.org"

=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.1026.0&gt;:ejabberd_listener:166) : Reusing listening port for 5222

=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.1027.0&gt;:ejabberd_listener:166) : Reusing listening port for 5269

=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.1028.0&gt;:ejabberd_listener:166) : Reusing listening port for 5280
ok
(ejabberd@srv2.example.org)3&gt;
=INFO REPORT==== 10-Jun-2013::20:38:53 ===
I(&lt;0.628.0&gt;:ejabberd_app:72) : ejabberd 2.1.10 is started in the node 'ejabberd@srv2.example.org'
</code></pre><p>Exit your erlang shell by pressing <code>CTRL+C</code> twice. Now stop ejabberd and start it again:</p><pre><code>/etc/init.d/ejabberd restart
</code></pre><p>You can now check in the admin webinterface if the cluster join succeeded:</p><pre><code>http://srv1.example.org:5280/admin/nodes/
</code></pre><p><img alt="Ejabberd nodes" src="https://raymii.org/s/inc/img/ejabberd1.png"/></p><p>If it shows the other node you are finished. If not, see if the steps worked and check the below section on troubleshooting.</p><p>Repeat the above steps for every node you want to add. You can add as many nodes as you want.</p><h3>Errors when clustering</h3><p>When setting up your cluster you might run into errors. Below are my notes for the errors I found.</p><ul><li><p>ejabberd restart does not restart epmd (erlang daemon)</p><ul><li>overkill solution: killall -u ejabberd</li></ul></li><li><p>ejabberd gives hostname errors</p><ul><li>make sure the hostname is set correctly (<code>hostname srv1.example.com</code>)</li></ul></li><li><p>ejabberd gives inconsistent database errors</p><ul><li>backup the erlang cookie (<code>/var/lib/ejabberd/.erlang.cookie</code>) and then remove the contents of the <code>/var/lib/ejabberd</code> folder so that mnesia rebuilds its tables.</li></ul></li><li><p>ejabberd reports "Connection attempt from disallowed node"</p><ul><li>make sure the erlang cookie is correct (<code>/var/lib/ejabberd/.erlang.cookie</code>). Set vim in insert mode before pasting...</li></ul></li></ul><h3>DNS SRV Records and Federation</h3><p>The DNS SRV Record is used both by chat clients to find the right server address as well as by other XMPP servers for federation. Example: Alice configures her XMPP clients with the email address alice@example.org. Her chat client looks up the SRV record and knows the chat server to connect to is <code>chat.example.org</code>. Bob sets up his client with the address <code>bob@bobsbussiness.com</code>, and adds Alice as a contact. The XMPP server at <code>bobsbussiness.com</code> looks up the SRV record and knows that it should initiate a server2server connection to <code>chat.example.org</code> to federate and let Bob connect with Alice.</p><p>The BIND 9 config looks like this:</p><pre><code>; XMPP
_xmpp-client._tcp                       IN SRV 5 0 5222 chat.example.org.
_xmpp-server._tcp                       IN SRV 5 0 5269 chat.example.org.
_jabber._tcp                            IN SRV 5 0 5269 chat.example.org.
</code></pre><p>It is your basic SRV record, both the client port and the server2server port, and legacy Jabber. If you have hosted DNS then either enter it in your panel or consult your service provider.</p><p>You can use the following <code>dig</code> query to verify your SRV records:</p><pre><code>dig _xmpp-client._tcp.example.org SRV
dig _xmpp-server._tcp.example.org SRV
</code></pre><p>Or if you are on Windows and have to use <code>nslookup</code>:</p><pre><code>nslookup -querytype=SRV _xmpp-client._tcp.example.org
nslookup -querytype=SRV _xmpp-server._tcp.example.org
</code></pre><p>If you get a result like this then you are set up correctly:</p><pre><code>;; QUESTION SECTION:
;_xmpp-client._tcp.raymii.org.  IN      SRV

;; ANSWER SECTION:
_xmpp-client._tcp.raymii.org. 3600 IN   SRV     5 0 5222 chat.raymii.org.
</code></pre><p>The actual record for <code>chat.raymii.org</code> in my case are multiple A records:</p><pre><code>;; ADDITIONAL SECTION:
chat.raymii.org.        3600    IN      A       84.200.77.167
chat.raymii.org.        3600    IN      A       205.185.117.74
chat.raymii.org.        3600    IN      A       205.185.124.11
</code></pre><p>But if you run a single node this can also be a CNAME or just one A/AAAA record.</p><h3>Final testing</h3><p>To test if it all worked you can add the Duck Duck Go XMPP bot. If this works flawlessly and you can add it and chat to it, then you have done everything correctly. The email address to add is <code>im@ddg.gg</code>.</p><hr/>Tags: <a class="link" href="../tags/chat.html">chat,</a><a class="link" href="../tags/dns.html">dns,</a><a class="link" href="../tags/ejabberd.html">ejabberd,</a><a class="link" href="../tags/erlang.html">erlang,</a><a class="link" href="../tags/federation.html">federation,</a><a class="link" href="../tags/google-talk.html">google-talk,</a><a class="link" href="../tags/jabber.html">jabber,</a><a class="link" href="../tags/xmpp.html">xmpp,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>