
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Pass the SSL Labs Test on NGINX (Mitigate the CRIME and BEAST attack, Disable SSLv2 and Enable Perfect Forward Secrecy). - Raymii.org</title>
        <link href="/s/inc/css/bootstrap.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link rel="alternate" type="application/rss+xml" title="Raymii.org RSS" href="http://feeds.feedburner.com/Raymiiorg" />

    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
        <div class="row-fluid">
        
        <div class="span10 offset1">
                
            <div class="span3 well"> 
            
                <!-- <h1 class="topheader"></h1> -->
                <h3>Raymii.org</h3>
                <h6>Quis custodiet ipsos custodes?</h6>
                <h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS Feed</a></h6>
            
            </div>

            <div class="span4 green-block">
                
                    <h3>Featured Items</h3>
    <a href="/s/tutorials/Ansible_Deployment_Framework.html" class="whitelink">Ansible Deployment Framework</a>
<br />
<a href="/s/tutorials/Pass_the_SSL_Labs_Test_on_Apache2_(Mitigate_the_CRIME_and_BEAST_attack_-_Disable_SSLv2_-_Enable_PFS).html" class="whitelink">Pass the SSL Labs Test on Apache2 (Mitigate the CRIME and BEAST attack   Disable SSLv2   Enable PFS)</a>
<br />
<a href="/s/articles/Small_Linux_PCs.html" class="whitelink">Small Linux PCs</a>
<br />
<a href="/s/tutorials/VMWare-ESXi-5-USB-installer.html" class="whitelink">VMWare ESXi 5 USB installer</a>
<br />

            
        </div>
        <div class="span4 green-block">
            
                <h3>Featured Items</h3>
    <a href="/s/software/Bash_PHP_Server_Status_Monitor.html" class="whitelink">Bash PHP Server Status Monitor</a>
<br />
<a href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html" class="whitelink">IPSEC L2TP vpn with Ubuntu 12.04</a>
<br />
<a href="/s/software/Nopriv-IMAP-backup.html" class="whitelink">Nopriv IMAP backup</a>
<br />
<a href="/s/tutorials/Pass_the_SSL_Labs_Test_on_NGINX_(Mitigate_the_CRIME_and_BEAST_attack_-_Disable_SSLv2_-_Enable_PFS).html" class="whitelink">Pass the SSL Labs Test on NGINX (Mitigate the CRIME and BEAST attack   Disable SSLv2   Enable PFS)</a>
<br />

            
        </div>
    </div>
    
    </div>
    <div class="row-fluid">
    <div class="span10 offset1">
    

    <div class="span3">
    <h3>&nbsp;&nbsp;&nbsp;Menu</h3><ul class="nav nav-pills nav-stacked">
<li><a href="/s/" class="link">Home</a>
</li>
<li><a href="/s/static/Contact.html" class="link">Contact</a>
</li>
<li><a href="/s/static/Disclaimer.html" class="link">Disclaimer</a>
</li>
<li><a href="/s/static/Hosted_Piwik.html" class="link">Hosted Piwik</a>
</li>
<li><a href="/s/static/Sparkling_Network.html" class="link">Sparkling Network</a>
</li>
<li><a href="/s/static/Terrible-Linux.html" class="link">Terrible Linux</a>
</li>
</ul>
<h3>&nbsp;&nbsp;&nbsp;Categories</h3>
<ul class="nav nav-pills nav-stacked">
<li><a href="/s/articles" class="link">Articles</a>
</li>
<li><a href="/s/snippets" class="link">Snippets</a>
</li>
<li><a href="/s/software" class="link">Software</a>
</li>
<li><a href="/s/tutorials" class="link">Tutorials</a>
</li>
<li><a href="/s/everything.html" class="link">All Items</li>
</a>
</ul>
               <!-- advertisement start -->
                <hr class="alt2">
                <h2>Advertisement</h2>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Need a VPS server? InceptionHosting has excellent VPS servers located in the USA or NL!</a><p />
                <script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                /* Raymii-2 */
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script>
                <script type="text/javascript"
                src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>    
                <!-- advertisement end -->

           </div>  
           <div class="span7"> 
                <div class="inner">


           <h2>Pass the SSL Labs Test on NGINX (Mitigate the CRIME and BEAST attack, Disable SSLv2 and Enable Perfect Forward Secrecy).</h2>
<ul class="breadcrumb">
<li><a href="../" class="link">Home</a>
<span class="divider">/</span></li>
<li><a href="../tutorials" class="link">Tutorials</a>
<span class="divider">/</span></li>
<li><a href="Pass_the_SSL_Labs_Test_on_NGINX_(Mitigate_the_CRIME_and_BEAST_attack_-_Disable_SSLv2_-_Enable_PFS).html" class="link">Pass the SSL Labs Test on NGINX (Mitigate the CRIME and BEAST attack, Disable SSLv2 and Enable Perfect Forward Secrecy).</a>
</li>
</ul>
<h6>Author: Remy Van Elst</h6>
<h6>Date: 23-07-2013</h6>
<br>
<p><a href="https://www.ssllabs.com/ssltest/analyze.html?d=raymii.org"><img src="https://raymii.org/s/inc/img/ssl-labs-nginx.png" alt="A on ssl labs test" /></a></p>

<p>This tutorial shows you how to get an A on the <a href="https://www.ssllabs.com/ssltest/">SSL Labs test</a> using the NGINX webserver. We do this by disabling CBC based chipers to mitigate the BEAST attack, disabling SSL Compression to mitigate the CRIME attack, disable SSLv2 and below because of vulnerabilities in the protocol and we will enable Perfect Forward Secrecy when possible. This way we have a future proof ssl configuration and we get an A on the Qually Labs SSL Test.</p>

<p><a href="https://raymii.org/s/tutorials/Pass_the_SSL_Labs_Test_on_Apache2_%28Mitigate_the_CRIME_and_BEAST_attack_-_Disable_SSLv2_-_Enable_PFS%29.html">This tutorial is also available for Apache2</a></p>

<p>You can find more info on the topics by following the links below:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#BEAST_attack">BEAST Attack</a></li>
<li><a href="https://en.wikipedia.org/wiki/CRIME_%28security_exploit%29">CRIME Attack</a></li>
<li><a href="https://en.wikipedia.org/wiki/Perfect_forward_secrecy">Perfect Forward Secrecy</a></li>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Dealing_with_RC4_and_BEAST">Dealing with RC4 and BEAST</a></li>
</ul>

<p><em>Make sure you backup the files before editing them!</em></p>

<p>I&#39;m using NGINX 1.2.1 from the Debian Wheezy repositories on this website, but I&#39;ve also tested it on CentOS 5 and 6 with NGINX from the EPEL.</p>

<h3>Mitigate the BEAST attack</h3>

<p>In short, by tampering with with an encryption algorithm&#39;s CBC - cipher block chaining - mode&#39;s,  portions of the encrypted traffic can be secretly decrypted. More info on the above link.</p>

<p>To mitigate it, we are going to edit the nginx settings in the file <code>/etc/nginx/sited-enables/yoursite.com</code> (On Ubuntu/Debian) or in <code>/etc/nginx/conf.d/nginx.conf</code> (On RHEL/CentOS).</p>

<p><em>For the entire tutorial, you need to edit the parts between the <code>server</code> block for the server config for port 443 (ssl config). At the end of the tutorial you can find the complete config example.</em> </p>

<p>What we need to do is disable all CBC chipers. If you have a version of OpenSSL lower than 1.0.1c then your only option is to use the RC4 chiper because TLS 1.2 support is added in 1.0.1c, but the RC4 chiper also has known weaknesses in it.</p>

<p>The lines below first have TLS 1.2 chipers for TLS 1.2 clients to pick those up, and at the end it has the RC4 chiper. It also enables the <code>ssl_prefer_server_ciphers</code> option which uses the servers order of chipers instead of letting the client choose. (<a href="http://wiki.nginx.org/HttpSslModule#ssl_prefer_server_ciphers">More on ssl<em>prefer</em>server_ciphers</a> - <a href="http://wiki.nginx.org/HttpSslModule#ssl_ciphers">More info on ssl_chipers</a>.</p>

<pre><code> ssl_prefer_server_ciphers on;
 ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-RC4-SHA:ECDHE-RSA-RC4-SHA:ECDH-ECDSA-RC4-SHA:ECDH-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:RC4-SHA; 
 ssl_session_cache  builtin:1000  shared:SSL:10m;
</code></pre>

<h3>Mitigate the CRIME attack</h3>

<p>The CRIME attack uses SSL Compression to do its magic, so we need to disable that. SSL compression is turned off by default in nginx 1.1.6+/1.0.9+ (if OpenSSL 1.0.0+ used) and nginx 1.3.2+/1.2.2+ (if older versions of OpenSSL are used). </p>

<p>If you are using al earlier version of nginx or OpenSSL and your distro has not backported this option then you need to recompile OpenSSL without ZLIB support. This will disable the use of OpenSSL using the DEFLATE compression method. If you do this then you can still use regular HTML DEFLATE compression.</p>

<h3>Disable SSLv2</h3>

<p>SSL v2 is insecure, so we need to disable it. Again edit the config file:</p>

<pre><code>ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
</code></pre>

<p><a href="http://wiki.nginx.org/HttpSslModule#ssl_protocols">More Info</a></p>

<h3>Enable Forward Secrecy</h3>

<p>(Perfect) Forward Secrecy ensures the integrity of a session key in the event that a long-term key is compromised. PFS accomplishes this by enforcing the derivation of a new key for each and every session.</p>

<p>This means that when the private key gets compromised it cannot be used to decrypt recorded SSL traffic.</p>

<p>The cipher suites that provide Perfect Forward Secrecy are those that use an ephemeral form of the Diffie-Hellman key exchange. Their disadvantage is their overhead, which can be improved by using the elliptic curve variants.</p>

<p>Do note that for PFS support and mitigating the BEAST attack TLS v1.2 is required. I&#39;ve also included a config line which gives you PFS but lets you vulnerable for the BEAST attack, but that is your only option on &lt; TLS v1.2.</p>

<p>The above config line <code>ssl_chipers</code> in the <em>Beast Attack</em> section, is the most workable line for now. It enables a few forward secrecy chipers, but it also allows RC4 (non-cbc). <em>You should use this line if you want to mititgate the BEAST attack and offer forward secrecy</em>:</p>

<pre><code>ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-RC4-SHA:ECDHE-RSA-RC4-SHA:ECDH-ECDSA-RC4-SHA:ECDH-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:RC4-SHA; 
</code></pre>

<p><a href="http://code-bear.com/bearlog/2013/06/26/nginx-ssl-config-for-forward-secrecy/">Source</a></p>

<p>If you really need forward secrecy and want to accept the rist of being vulnerable to the BEAST attack, use this line:</p>

<pre><code>ssl_chipers ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:EDH-DSS-DES-CBC3-SHA:!MD5:!aNULL:!EDH;
</code></pre>

<h3>Config Example</h3>

<pre><code>server {

  listen [::]:443 default_server;

  ssl on;
  ssl_certificate_key /etc/ssl/cert/raymii_org.pem;
  ssl_certificate /etc/ssl/cert/ca-bundle.crt;
  ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-RC4-SHA:ECDHE-RSA-RC4-SHA:ECDH-ECDSA-RC4-SHA:ECDH-RSA-RC4-SHA:ECDHE-RSA-AES256-SHA:RC4-SHA;
  ssl_prefer_server_ciphers on;

  root /var/www/;
  index index.html index.htm;
  server_name raymii.org;

}
</code></pre>

<h3>Conclusion</h3>

<p>If you have applied the above config lines you need to restart nginx:</p>

<pre><code># Check the config first:
/etc/init.d/nginx configtest
# Then restart:
/etc/init.d/nginx restart

# If you are on RHEL/CentOS:
/etc/init.d/nginx configtest
/etc/init.d/nginx restart
</code></pre>

<p>Now use the <a href="https://www.ssllabs.com/ssltest/">SSL Labs test</a> to see if you get a nice A. And of course have a safe and future proof SSL configuration!</p>
<hr>
Tags: <a href="../tags/BEAST.html" class="link">BEAST, 
</a>
<a href="../tags/CBC.html" class="link">CBC, 
</a>
<a href="../tags/CRIME.html" class="link">CRIME, 
</a>
<a href="../tags/RC4.html" class="link">RC4, 
</a>
<a href="../tags/featured-two.html" class="link">featured-two, 
</a>
<a href="../tags/nginx.html" class="link">nginx, 
</a>
<a href="../tags/pfs.html" class="link">pfs, 
</a>
<a href="../tags/ssl.html" class="link">ssl, 
</a>
<a href="../tags/ssl-labs.html" class="link">ssl-labs, 
</a>
<a href="../tags/tls.html" class="link">tls, 
</a>
<div class="footer">
                <hr />
                <br />
        
                <hr>

                <p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br />

                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
     
    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->
    
    <!-- google analytics -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-3704876-6");
    pageTracker._trackPageview();
    } catch(err) {}</script>
    <!--end analytics -->
    </body>
    </html>
    