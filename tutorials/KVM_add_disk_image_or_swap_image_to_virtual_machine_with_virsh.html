<!DOCTYPE html><html lang="en"><head><title>KVM add disk image or swap image to virtual machine with virsh - Raymii.org</title><link href="/s/inc/css/custom-first.css" rel="stylesheet"/><link href="/s/inc/css/light.css" rel="stylesheet"/><link href="/s/inc/css/custom.css" rel="stylesheet" title="custom"/><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Pages</a></li><li class="hideifsmall"><a class="link" href="/s/tags/bash.html">Bash</a></li><li class="hideifsmall"><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ssl.html">SSL</a></li><li class="hideifsmall"><a class="link" href="/s/tags/debian.html">Debian</a></li><li class="hideifsmall"><a class="link" href="/s/tags/python.html">Python</a></li><li class="hideifsmall"><a class="link" href="/s/tags/vpn.html">VPN</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li class="hideifsmall"><a class="link" href="/s/tags/nginx.html">nginx</a></li><li class="hideifsmall"><a class="link" href="/s/tags/openstack.html">Openstack</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br/><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="9322003332" style="display:inline-block;width:200px;height:200px"></ins><script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">KVM add disk image or swap image to virtual machine with virsh</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../tutorials/index.html">Tutorials</a></li><li><a class="link" href="KVM_add_disk_image_or_swap_image_to_virtual_machine_with_virsh.html">KVM add disk image or swap image to virtual machine with virsh</a></li></ul><p><small>23-02-2014</small> | <small>Remy van Elst</small></p><div class="ad"><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="6172324376" style="display:inline-block;width:728px;height:90px"></ins><script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script></div><br/><p>This tutorial shows you how to create and add a disk image to a KVM vm using virsh. This is useful when you for example want to expand the disk space of your virtual machine when it is using LVM, or if you want to add a swap disk to a virtual machine. Note that you can also create a swap file instead of a disk, however, this is an example for adding the disk.</p><p>Read this tutorial to <a href="https://raymii.org/s/tutorials/KVM_with_bonding_and_VLAN_tagging_setup_on_Ubuntu_12.04.html">learn how to set up a proper KVM hypervisor host: https://raymii.org/s/tutorials/KVM<em>with</em>bonding<em>and</em>VLAN<em>tagging</em>setup<em>on</em>Ubuntu_12.04.html</a></p><h3>Requirements</h3><ul><li><p>Host running KVM and virsh</p></li><li><p>Virtual Machine to add disk to</p></li></ul><p>This was tested on a KVM hypervisor host running Ubuntu 12.04 LTS and a Ubuntu 13.10 virtual machine. The KVM hypervisor uses virsh for management.</p><p>The example vm is named <code>example-vm</code> in virsh (domain).</p><h3>Create and attach the disk image</h3><p>Execute these steps on the KVM hypervisor host.</p><p>cd to the folder where you store your disk images:</p><pre><code>cd /var/lib/libvirt/images/
</code></pre><p>Create the new disk image:</p><pre><code>qemu-img create -f raw example-vm-swap.img 1G
</code></pre><p>We use <code>qemu-img</code> to <code>create</code> a new <code>raw</code> disk image with a size of 1 GB.</p><p>Attach the disk to the example virtual machine using virsh:</p><pre><code>virsh attach-disk example-vm --source /var/lib/libvirt/images/example-vm-swap.img --target vdb --persistent
</code></pre><p>We use <code>virsh</code> to attach the disk image <code>/var/lib/libvirt/images/example-vm-swap</code> as a <code>virtio</code> (<code>/dev/vdb</code>) disk to the domain (vm) <code>example-vm</code>. The <code>--persistent</code> option updates the domain xml file with an element for the newly attached disk.</p><p>Note that if you already have a <code>/dev/vdb</code> disk you need to change <code>vdb</code> to a free device like <code>vdc</code> or <code>vdd</code>.</p><h3>Formatting the disk</h3><p>Execute these steps in your virtual machine.</p><p>Reboot it so that the kernel sees the new disk:</p><pre><code>reboot
</code></pre><p>Partition the drive with <code>cfdisk</code>. For our example we use filesystem type 82 (linux/linux swap):</p><pre><code>cfdisk /dev/vdb
</code></pre><p>Format the disk as swap:</p><pre><code>mkswap /dev/vdb1
</code></pre><p>Or format it as ext4:</p><pre><code>mkfs.ext4 /dev/vdb1
</code></pre><p>Make the swap active:</p><pre><code>swapon /dev/vdb1
</code></pre><p>Or mount the partition:</p><pre><code>mkdir /mnt/new-disk
mount /dev/vdb1 /mnt/new-disk
</code></pre><p>Add to /etc/fstab for reboot persistence:</p><pre><code>/dev/vdb1   swap            swap    defaults    0 0
</code></pre><p>Or for the ext4 disk:</p><pre><code>/dev/vdb1   /mnt/new-disk   ext4    defaults    0 0
</code></pre><p>That's it. You've now created, attached, formatted and mounted a new disk in your VM.</p><h3>Sources</h3><ul><li><a href="http://linux.die.net/man/1/qemu-img">qemu-img man page</a></li><li><a href="http://builder.virt-tools.org/artifacts/libvirt-virshcmdref/html/sect-attach-disk.html">virsh-attach doc page</a></li></ul><hr/>Tags: <a class="link" href="../tags/disk.html">disk,</a><a class="link" href="../tags/kvm.html">kvm,</a><a class="link" href="../tags/swap.html">swap,</a><a class="link" href="../tags/ubuntu.html">ubuntu,</a><a class="link" href="../tags/virsh.html">virsh,</a><a class="link" href="../tags/virtualization.html">virtualization,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>