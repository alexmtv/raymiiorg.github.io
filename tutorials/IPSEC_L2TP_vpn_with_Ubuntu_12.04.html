
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>IPSEC/L2TP VPN on Ubuntu 12.04 with OpenSwan, xl2tpd and ppp - Raymii.org</title>
        <link href="/s/inc/css/bootstrap.css" rel="stylesheet" />
        <link href="/s/inc/js/google-code-prettify/prettify.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
        <div class="row-fluid">
        
        <div class="span10 offset1">
                
            <div class="span4 well"> 
            
                <h1 class="topheader">Raymii.org</h1>
                <h6>Quis custodiet ipsos custodes?</h6>
                <h6><a href="/s/feed.xml">RSS</a></h6>
            
            </div>

            <div class="span4 green-block">
                
                    <h3>Featured Items</h3>
    <a href="/s/tutorials/Ansible.html" class="whitelink">Ansible</a>
<br />
<a href="/s/tutorials/Autossh_persistent_tunnels.html" class="whitelink">Autossh persistent tunnels</a>
<br />
<a href="/s/software/Codename_Geld.html" class="whitelink">Codename Geld</a>
<br />
<a href="/s/tutorials/Munin_optimalization_on_Debian.html" class="whitelink">Munin optimalization on Debian</a>
<br />
<a href="/s/articles/Small_Linux_PCs.html" class="whitelink">Small Linux PCs</a>
<br />

            
        </div>
        <div class="span4 green-block">
            
                <h3>Featured Items</h3>
    <a href="/s/software/Bash_PHP_Server_Status_Monitor.html" class="whitelink">Bash PHP Server Status Monitor</a>
<br />
<a href="/s/articles/Encryption-on-ANY-cloud-service.html" class="whitelink">Encryption on ANY cloud service</a>
<br />
<a href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html" class="whitelink">IPSEC L2TP vpn with Ubuntu 12.04</a>
<br />
<a href="/s/software/NutsManager.html" class="whitelink">NutsManager</a>
<br />
<a href="/s/tutorials/Tahoe_LAFS_Storage_Grid.html" class="whitelink">Tahoe LAFS Storage Grid</a>
<br />

            
        </div>
    </div>
    
    </div>
    <div class="row-fluid">
    <div class="span10 offset1">
    

    <div class="span3">
    <h3>Menu</h3><ul class="nav nav-pills nav-stacked">
<li><a href="/s/" class="link">Home</a>
</li>
<li><a href="/s/static/Contact.html" class="link">Contact</a>
</li>
<li><a href="/s/static/Disclaimer.html" class="link">Disclaimer</a>
</li>
<li><a href="/s/static/Terrible-Linux.html" class="link">Terrible Linux</a>
</li>
</ul>
<h3>Categories</h3>
<ul class="nav nav-pills nav-stacked">
<li><a href="/s/articles" class="link">Articles</a>
</li>
<li><a href="/s/snippets" class="link">Snippets</a>
</li>
<li><a href="/s/software" class="link">Software</a>
</li>
<li><a href="/s/tutorials" class="link">Tutorials</a>
</li>
</ul>
               <!-- advertisement start -->
                <hr class="alt2">
                <h2>Advertisement</h2>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Need a VPS server? InceptionHosting has excellent VPS servers located in the USA or NL!</a><p />
                <script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                /* Raymii-2 */
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script>
                <script type="text/javascript"
                src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>    
                <!-- advertisement end -->

           </div>  
           <div class="span7"> 
                <div class="inner">


           <h2>IPSEC/L2TP VPN on Ubuntu 12.04 with OpenSwan, xl2tpd and ppp</h2>
<ul class="breadcrumb">
<li><a href="../" class="link">Home</a>
<span class="divider">/</span></li>
<li><a href="../tutorials" class="link">Tutorials</a>
<span class="divider">/</span></li>
<li><a href="IPSEC_L2TP_vpn_with_Ubuntu_12.04.html" class="link">IPSEC/L2TP VPN on Ubuntu 12.04 with OpenSwan, xl2tpd and ppp</a>
</li>
</ul>
<h6>Author: Remy Van Elst</h6>
<h6>Date: 08-07-2012</h6>
<br>
<p>This is a guide on setting up a IPSEC/L2TP vpn on Ubuntu 12.04 using Openswan as the IPsec server, xl2tpd as the l2tp provider and ppp for authentication. We choose the IPSEC/L2TP protocol stack because of recent vulnerabilities found in pptpd VPN&#39;s. </p>

<p><img src="http://f.cl.ly/items/0e2a2t1t182f201W0B1r/logo.jpg" alt="fusioned"><br>
<em>I would like to give a big thank you to <a href="https://www.fusioned.net">Fusioned for providing a KVM SSD VPS.</a></em>  </p>

<p><a href="https://raymii.org/cms/p_IPSEC_L2TP_VPN_on_ubuntu_12.10">If you are running Ubuntu 12.10 you should use this tutorial.</a><br>
<a href="https://raymii.org/cms/p_IPSEC_L2TP_vpn_on_CentOS_-_Red_Hat_Enterprise_Linux_or_Scientific_-_Linux_6">If you run CentOS 6, Scientific Linux 6 or Red Hat Enterprise Linux 6 you should use this tutorial</a>  </p>

<p>IPSec encrypts your IP packets to provide encryption and authentication, so no one can decrypt or forge data between your clients and your server. L2TP provides a tunnel to send data. It does not provide encryption and authentication though, that is why we need to use it together with IPSec. </p>

<p>To work trough this tutorial you should have:</p>

<ul>
<li>1 ubuntu 12.04 server with at least 1 public IP address and root access</li>
<li>1 (or more) clients running an OS that support IPsec/L2tp vpn&#39;s (Ubuntu, Mac OS, Windows, Android).</li>
<li>Ports 1701 TCP, 4500 UDP and 500 UDP opened in the firewall.</li>
</ul>

<p>If you are not running Ubuntu 12.04 you might have to compile the packages manually because openswan and xl2tpd in the older repositories seem to have critical bugs which make this all fail.</p>

<p>I do all the steps as the root user. You should do to, but only via * -i* or * su -*. Do not allow root to login via SSH!</p>

<h4>Install ppp openswan and xl2tpd</h4>

<p>First we will install the required packages:</p>

<pre><code> apt-get install openswan xl2tpd ppp 
</code></pre>

<p>The openswan installation will ask some questions, this tutorial works with the default answers (just enter through it).  </p>

<p>If you do not have <em>lsof</em> installed you also need to install that, otherwise the <em>ipsec verify</em> will fail:</p>

<pre><code> apt-get install lsof
</code></pre>

<h4>Firewall and sysctl</h4>

<p>We are going to set the firewall and make sure the kernel forwards IP packets:</p>

<p>Execute this command to enable the iptables firewall to allow the vpn:</p>

<pre><code>iptables --table nat --append POSTROUTING --jump MASQUERADE
</code></pre>

<p>Execute the below commands to enable kernel IP packet forwarding and disable ICP redirects.</p>

<pre><code>echo &quot;net.ipv4.ip_forward = 1&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.conf.all.accept_redirects = 0&quot; |  tee -a /etc/sysctl.conf
echo &quot;net.ipv4.conf.all.send_redirects = 0&quot; |  tee -a /etc/sysctl.conf
for vpn in /proc/sys/net/ipv4/conf/*; do echo 0 &gt; $vpn/accept_redirects; echo 0 &gt; $vpn/send_redirects; done
 sysctl -p
</code></pre>

<h5>/etc/rc.local</h5>

<p>To make sure this keeps working at boot you might want to add the following to <em>/etc/rc.local</em>:</p>

<pre><code>for vpn in /proc/sys/net/ipv4/conf/*; do echo 0 &gt; $vpn/accept_redirects; echo 0 &gt; $vpn/send_redirects; done
iptables --table nat --append POSTROUTING --jump MASQUERADE
</code></pre>

<p>There are better ways to do this (via sysctl.conf and ufw for example) but this is something that just works.</p>

<h4>Configure Openswan (IPSEC)</h4>

<p>Use your favorite editor to edit the following file:</p>

<p><em>/etc/ipsec.conf</em>  </p>

<p>Below is the contents of mine. Most lines have a comment below it explaining what it does.</p>

<pre><code>config setup
    dumpdir=/var/run/pluto/
    #in what directory should things started by setup (notably the Pluto daemon) be allowed to dump core?
    nat_traversal=yes
    #whether to accept/offer to support NAT (NAPT, also known as &quot;IP Masqurade&quot;) workaround for IPsec
    virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v6:fd00::/8,%v6:fe80::/10
    #contains the networks that are allowed as subnet= for the remote client. In other words, the address ranges that may live behind a NAT router through which a client connects.
    protostack=netkey
    #decide which protocol stack is going to be used.

conn L2TP-PSK-NAT
    rightsubnet=vhost:%priv
    also=L2TP-PSK-noNAT

conn L2TP-PSK-noNAT
    authby=secret
    #shared secret. Use rsasig for certificates.
    pfs=no
    #Disable pfs
    auto=add
    #start at boot
    keyingtries=3
    #Only negotiate a conn. 3 times.
    ikelifetime=8h
    keylife=1h
    type=transport
    #because we use l2tp as tunnel protocol
    left=%SERVERIP%
    #fill in server IP above
    leftprotoport=17/1701
    right=%any
    rightprotoport=17/%any
</code></pre>

<h5>The shared secret</h5>

<p>The shared secret is defined in the <em>/etc/ipsec.secrets</em> file. Make sure it is long and random:</p>

<pre><code>%SERVERIP%  %any:   PSK &quot;69EA16F2C5DCED8B29E74A7D1B0FE99E69F6BDCD3E44&quot;
</code></pre>

<h5>Verify</h5>

<p>Now to make sure IPSEC works, execute the following command:</p>

<pre><code> ipsec verify
</code></pre>

<p>My output looks like this:</p>

<pre><code>Checking your system to see if IPsec got installed and started correctly:
Version check and ipsec on-path                                 [OK]
Linux Openswan U2.6.37/K3.2.0-29-generic-pae (netkey)
Checking for IPsec support in kernel                            [OK]
 SAref kernel support                                           [N/A]
 NETKEY:  Testing XFRM related proc values                      [OK]
    [OK]
    [OK]
Checking that pluto is running                                  [OK]
 Pluto listening for IKE on udp 500                             [OK]
 Pluto listening for NAT-T on udp 4500                          [OK]
Two or more interfaces found, checking IP forwarding            [OK]
Checking NAT and MASQUERADEing                                  [OK]
Checking for &#39;ip&#39; command                                       [OK]
Checking /bin/sh is not /bin/dash                               [WARNING]
Checking for &#39;iptables&#39; command                                 [OK]
Opportunistic Encryption Support                                [DISABLED]
</code></pre>

<p>The /bin/sh and Opportunistic Encryption warnings can be ignored. The first one is a openswan bug and the second doesn&#39;t matter.</p>

<h4>Configure xl2tpd</h4>

<p>Use your favorite editor to edit the following file:</p>

<p><em>/etc/xl2tpd/xl2tpd.conf</em>  </p>

<p>Below is the contents of mine. Most lines have a comment below it explaining what it does.</p>

<pre><code>[global]
ipsec saref = yes

[lns default]
ip range = 172.16.1.30-172.16.1.100
local ip = 172.16.1.1
refuse pap = yes
require authentication = yes
ppp debug = yes
pppoptfile = /etc/ppp/options.xl2tpd
length bit = yes
</code></pre>

<ul>
<li>ip range = range of IP&#39;s to give to the connecting clients</li>
<li>local ip = IP of VPN server</li>
<li>refuse pap = refure pap authentication</li>
<li>ppp debug = yes when testing, no when in production</li>
</ul>

<p>If you want local accounts to be used instead of PPP accounts you can add the following line to the file:</p>

<pre><code>unix authentication = yes
</code></pre>

<h4>Configuring PPP</h4>

<p>Use your favorite editor to edit the following file:</p>

<p><em>/etc/ppp/options.xl2tpd</em>  </p>

<p>Below is the contents of mine. Most lines have a comment below it explaining what it does.</p>

<pre><code>require-mschap-v2
ms-dns 8.8.8.8
ms-dns 8.8.4.4
auth
mtu 1200
mru 1000
crtscts
hide-password
modem
name l2tpd
proxyarp
lcp-echo-interval 30
lcp-echo-failure 4
</code></pre>

<ul>
<li>ms-dns = The dns to give to the client. I use google&#39;s public DNS.</li>
<li>proxyarp = Add an entry to this system&#39;s ARP [Address Resolution Protocol] table with the IP address of the peer and the Ethernet address of this system. This will have the effect of making the peer appear to other systems to be on the local ethernet.</li>
<li>name l2tpd = is used in the ppp authentication file.</li>
</ul>

<h4>Adding users</h4>

<p>Every user should be defined in the <em>/etc/ppp/chap-secrets</em> file. Below is an example file. </p>

<pre><code># Secrets for authentication using CHAP
# client       server  secret                  IP addresses
alice          l2tpd   0F92E5FC2414101EA            *
bob            l2tpd   DF98F09F74C06A2F             *
</code></pre>

<ul>
<li>client = username for the user</li>
<li>server = the name we define in the ppp.options file for xl2tpd</li>
<li>secret = password for the user</li>
<li>IP Address = leave to * for any address or define addresses from were a user can login.</li>
</ul>

<h4>Testing it</h4>

<p>To make sure everything has the newest config files restart openswan and xl2tpd:</p>

<pre><code>/etc/init.d/ipsec restart;  /etc/init.d/xl2tpd restart
</code></pre>

<p>On the client connect to the server IP address (or add a DNS name) with a valid user, password and the shared secret. Test if you have internet access and which IP you have (via for example <a href="http://whatsmyip.org">whatsmyip.org</a>. ). If it is the VPN servers IP then it works.</p>

<p>Another nice test is to connect multiple clients of which one has a webserver. Make sure it only listens on a VPN IP (172.16.1.xxx in above example). Test if you can access it only via the VPN. You now have a &quot;secret&quot; webserver.</p>

<p>If you experience problems make sure to check the client log files and the ubuntu <em>/var/log/syslog</em> file. If you google the error messages you most of the time get a good answer.</p>

<h4>Sources</h4>

<ul>
<li><a href="http://blog.riobard.com/2010/04/30/l2tp-over-ipsec-ubuntu">http://blog.riobard.com/2010/04/30/l2tp-over-ipsec-ubuntu</a></li>
<li><a href="http://www.cryptocracy.com/blog/2012/05/13/ipsec-slash-l2tp-vpn-server-with-ubuntu-precise">http://www.cryptocracy.com/blog/2012/05/13/ipsec-slash-l2tp-vpn-server-with-ubuntu-precise</a></li>
<li><a href="http://rootmanager.com/ubuntu-ipsec-l2tp-windows-domain-auth/setting-up-openswan-xl2tpd-with-native-windows-clients-lucid.html">http://rootmanager.com/ubuntu-ipsec-l2tp-windows-domain-auth/setting-up-openswan-xl2tpd-with-native-windows-clients-lucid.html</a></li>
</ul>
<hr>
Tags: <a href="../tags/debian.html" class="link">debian, 
</a>
<a href="../tags/featured-two.html" class="link">featured-two, 
</a>
<a href="../tags/ipsec.html" class="link">ipsec, 
</a>
<a href="../tags/l2tp.html" class="link">l2tp, 
</a>
<a href="../tags/openvpn.html" class="link">openvpn, 
</a>
<a href="../tags/pptp.html" class="link">pptp, 
</a>
<a href="../tags/ubuntu.html" class="link">ubuntu, 
</a>
<a href="../tags/vpn.html" class="link">vpn, 
</a>
<div class="footer">
                <hr />
                <br />
                <p>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'raymiiorg'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </p>
        
                <hr>

                <p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br />

                <small></small></p>

                <small><a href="http://validator.w3.org/check/referer" target="_blank">Validate XHTML</a></small>

                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>


    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "http://irixos.nl/piwik/" : "http://irixos.nl/piwik/");
    document.write("<script src='" + pkBaseURL + "piwik.js' type='text/javascript'></script>");
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 2);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://irixos.nl/piwik/piwik.php?idsite=2" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->

    <!-- google analytics -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write("<script src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'></script>");
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-3704876-6");
    pageTracker._trackPageview();
    } catch(err) {}</script>
    <!--end analytics -->    
    </body>
    </html>
    