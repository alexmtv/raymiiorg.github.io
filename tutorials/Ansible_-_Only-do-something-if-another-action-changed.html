<!DOCTYPE html><html lang="en"><head><title>Ansible - Only do something if another action changed - Raymii.org</title><link href="/s/inc/css/light.css" rel="stylesheet" title="light"/><link href="/s/inc/css/dark.css" rel="alternate stylesheet" title="dark"/><script src="/s/inc/js/jquery-2.1.1.min.js"></script><script src="/s/inc/js/bootstrap.3.2.0.min.js"></script><script src="/s/inc/js/styleswitcher.js"></script><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="http://feeds.feedburner.com/Raymiiorg" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="https://raymii.org/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Items</a></li><li><a class="link" href="/s/tags/bash.html">Bash</a></li><li><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li><a class="link" href="/s/tags/ssl.html">SSL</a></li><li><a class="link" href="/s/tags/debian.html">Debian</a></li><li><a class="link" href="/s/tags/python.html">Python</a></li><li><a class="link" href="/s/tags/vpn.html">VPN</a></li><li><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li><a class="link" href="/s/tags/nginx.html">nginx</a></li><li><a class="link" href="/s/tags/apache.html">Apache</a></li><li><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><ul class="navbar-collapse nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Style<b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#" onclick="setActiveStyleSheet('dark')">Dark</a></li><li><a href="#" onclick="setActiveStyleSheet('light')">Light</a></li></ul></li></ul><br/><br/><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link</a><br/><script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">Ansible - Only do something if another action changed</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../tutorials/index.html">Tutorials</a></li><li><a class="link" href="Ansible_-_Only-do-something-if-another-action-changed.html">Ansible - Only do something if another action changed</a></li></ul><p><small>22-12-2013</small> | <small>Remy van Elst</small></p><div class="ad"><script type="text/javascript"><!--
                            google_ad_client = "ca-pub-7993642564731324";
                            /* voorartikel */
                            google_ad_slot = "6172324376";
                            google_ad_width = 728;
                            google_ad_height = 90;
                            //-->
                            </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                            </script></div><br/><p>This Ansible tutorial shows you how execute actions only if another action has changed. For example, a playbook which downloads a remote key for package signing but only executes the apt-add command if the key has changed. Or a playbook which clones a git repository and only restarts a service if the git repository has changed.</p><p>This example is tested on Ansible 1.4 and on a Digital Ocean VPS. If you like this tutorial and want to support my website, use this link to order a Digital Ocean VPS: <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">https://www.digitalocean.com/?refcode=7435ae6b8212</a></p><p>Using the <code>register</code> option we can, surprisingly, registers the result of a playbook action. In another action we can access this variable and use <code>when</code> to only execute an action if the previous action changed the machines state. The below example downloads the NGINX debian package signing key, but only adds it if the key changed or did not exist yet:</p><pre><code>- file: path=/var/keys state=directory owner=root

- get_url: url=http://nginx.org/keys/nginx_signing.key dest=/var/keys/nginx_signing.key
  register: aptkey

- command: "apt-key add /var/keys/nginx_signing.key"
  when: aptkey.changed

- apt: update_cache=yes
  when: aptkey.changed
</code></pre><p>It is part of one of my playbooks which installs and configures NGINX. I want to use the latest stable version provided by the NGINX project. They sign their debian packages, so I need their key otherwise I cannot install their packages from their repo.<br/> They provide their key online, the <code>get_url</code> module downloads this key. If the key is not on the system or if the key has changed, the action reports itself as changed. If the key already exists on the system and is the same as the downloaded file, it does not report itself changed.<br/> We only want to execute <code>apt-key add</code> if the key is new or changed. By using the <code>register: aptkey</code> option and the <code>when: aptkey.changed</code> options, we make sure apt only adds the key and updates the cache if the key was not there before. This helps with idempotency and saves system resources.</p><p>Another example I use consists out of cloning a git repository, and based on if the code in that repo has changed, restarting a service. I cannot go in much detail because this setup runs at a client, therefore the values are stubs. However, I can tell that this example runs via <code>ansible-pull</code> mode and makes sure one of their products is always the latest version. See it as a form of continuous deployment.</p><pre><code>- git: repo=https://gitlab.example.org/example-user/example-repo.git dest=/opt/example version=production force=yes
  register: examplesoftware

- service: name=example state=restarted enabled=yes
  when: examplesoftware.changed
</code></pre><p>The last example comes from my vnstat playbook. vnstat is a console based network traffic analyzer and logger, it gives me nice overviews of the traffic used. The below playbook installs vnstat but only executes the vnstat initialize command when the configuration file changes. This file never changes except at installation, so therefore I can be fairly sure the vnstat database is only initialized once.</p><pre><code>- apt: name=vnstat state=latest update_cache=yes

- action: template src=vnstat.conf dest=/etc/vnstat.conf mode=0644 owner=root group=root
  notify: restart vnstat
  register: result

- command: sudo vnstat -u -i {{ interface }}
  when: result.changed
  notify: restart vnstat
</code></pre><p>You can also go very advanced with error handling and defining when something changes or fails. The <a href="http://www.ansibleworks.com/docs/playbooks_error_handling.html">ansible documentation covers that fairly well: http://www.ansibleworks.com/docs/playbooks<em>error</em>handling.html</a>.</p><hr/>Tags: <a class="link" href="../tags/ansible.html">ansible,</a><a class="link" href="../tags/apt.html">apt,</a><a class="link" href="../tags/configuration-management.html">configuration-management,</a><a class="link" href="../tags/deployment.html">deployment,</a><a class="link" href="../tags/devops.html">devops,</a><a class="link" href="../tags/nginx.html">nginx,</a><a class="link" href="../tags/packages.html">packages,</a><a class="link" href="../tags/python.html">python,</a><a class="link" href="../tags/ssl.html">ssl,</a><a class="link" href="../tags/yum.html">yum,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>