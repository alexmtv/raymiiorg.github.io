<!-- nominify -->



    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Nitrokey gnuk firmware update via DFU - Raymii.org</title>
        <link href="/s/inc/css/custom-first.css" rel="stylesheet" />
        <link href="/s/inc/css/light.css" rel="stylesheet"  />
        <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />
        <script src="/s//inc/js/toc.js" type="text/javascript"></script>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link href="inc/img/icons/iphone.png" rel="apple-touch-icon" />
        <link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76" />
        <link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120" />
        <link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png" alt="IEC Resistor logo"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/index.html" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/everything.html" class="special-menu">All Pages</a></li><li class='hideifsmall'><a href="/s/tags/bash.html" class="link">Bash</a></li><li class='hideifsmall'><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li class='hideifsmall'><a href="/s/tags/ssl.html" class="link">SSL</a></li><li class='hideifsmall'><a href="/s/tags/debian.html" class="link">Debian</a></li><li class='hideifsmall'><a href="/s/tags/python.html" class="link">Python</a></li><li class='hideifsmall'><a href="/s/tags/vpn.html" class="link">VPN</a></li><li class='hideifsmall'><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li><li class='hideifsmall'><a href="/s/tags/nginx.html" class="link">nginx</a></li><li class='hideifsmall'><a href="/s/tags/openstack.html" class="link">Openstack</a></li><li class='hideifsmall'><a href="/s/tags/ansible.html" class="link">Ansible</a></li></ul>            
               <!-- advertisement start -->
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br />
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Raymii-2 -->
                <ins class="adsbygoogle"
                     style="display:inline-block;width:200px;height:200px"
                     data-ad-client="ca-pub-7993642564731324"
                     data-ad-slot="9322003332"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">

           <h2 class='headheader'>Nitrokey gnuk firmware update via DFU</h2><ul class="breadcrumb"><li><a href="../index.html" class="link">Home</a></li><li><a href="../tutorials/index.html" class="link">Tutorials</a></li><li><a href="Nitrokey_gnuk_firmware_update_via_DFU.html" class="link">Nitrokey gnuk firmware update via DFU</a></li></ul><p><small>11-10-2016</small> | <small>Remy van Elst</small></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>The Nitrokey (start) can be upgraded to a newer GNUK firmware. However, this can only be done via ST Link or DFU, if you use the Gnuk USB firmware upgrade you will brick the device. This guide shows you how to attach a DFU adapter and how to flash firmware to a Nitrokey, both for upgrading or unbricking an USB upgraded one. </p>

<p>You need to build the <code>gnuk</code> firmware. The Device ID needs to be changed to <code>20a0:4211</code> in the file <code>gnuk/USB_DEBVICE_ID</code>:</p>

<pre><code>$ cat GNUK_USB_DEVICE_ID 
# VID:PID bcdDev  Product_STRING  Vendor_STRING
234b:0000 0200  Gnuk Token  Free Software Initiative of Japan
20a0:4211 0200  Nitrokey
##########&lt;TAB&gt; ##&lt;TAB&gt; ##########&lt;TAB&gt; #################
</code></pre>

<p>For the <code>gnuk</code> firmware compilation, please see <a href="https://raymii.org/s/tutorials/FST-01_firmware_upgrade_via_usb.html">this article</a>. I will not cover that here any further.</p>

<h3>Requirements and connection</h3>

<p>You do need the following:</p>

<ul>
<li>USB header (<a href="https://raymii.org/s/inc/img/stdemo/usb-header.png">like this</a>, I hot-aired one of an old motherboard)</li>
<li>Small bridge wire</li>
<li>USB to RS-232 serial adapter (<a href="https://raymii.org/s/inc/img/usb-serial.jpg">like this</a>)</li>
<li>Small wires</li>
<li>Caseless Nitrokey (note that you probably will break the case).</li>
</ul>

<h2>- <a href="https://sourceforge.net/p/stm32flash/wiki/Home/">stm32flash</a></h2>

<p>DFU is a simple protocol via serial port which allows programming but no debugging. On the Nitrokey hardware the appropriate pins are exposed over the USB connector. </p>

<p>Connect the wires from the USB serial adapter to the USB header (Nitrokey USB Plug &lt;-&gt; Serial/TTL adapter):</p>

<ul>
<li>Pin 1, VCC &lt;-&gt; VCC (5v)</li>
<li>Pin 2, D-  &lt;-&gt; TX</li>
<li>Pin 3, D+  &lt;-&gt; RX</li>
<li>Pin 4, GND &lt;-&gt; GND</li>
</ul>

<p>This diagram represents the pinout of the USB socket:</p>

<pre><code>  ################### 
  #                 # 
  # ############### # 
  #                 # 
  #                 # 
  ################### 
     #   #   #   #   
     #   #   #   #    

     1   2   3   4
</code></pre>

<p>(This nice ascii art comes from the <a href="https://github.com/Nitrokey/nitrokey-pro-hardware/blob/master/README">Nitrokey Pro Hardware</a> repo.)</p>

<p>You also need a small wire to bridge the two holes before you attach the Nitrokey so that it boots into DFU mode. </p>

<p>Here is a picture of my setup:</p>

<p><img src="https://raymii.org/s/inc/img/nitrokey-dfu-2.png"> </p>

<p>This was my complete workspace:</p>

<p><img src="https://raymii.org/s/inc/img/nitrokey-dfu-1.png"> </p>

<h3>Unblocking the flash</h3>

<p>The STM32 controller has a flash-protection bit which prohibits writing to the flash. The <code>stm32flash</code> tool says it&#39;s able to unblock that, but for the Nitrokey this fails:</p>

<pre><code>sudo stm32flash -u /dev/ttyUSB0 
</code></pre>

<p>Output:</p>

<pre><code>stm32flash 0.5

http://stm32flash.sourceforge.net/

Interface serial_posix: 57600 8E1
Version      : 0x22
Option 1     : 0x00
Option 2     : 0x00
Device ID    : 0x0410 (STM32F10xxx Medium-density)
- RAM        : 20KiB  (512b reserved by bootloader)
- Flash      : 128KiB (size first sector: 4x1024)
- Option RAM : 16b
- System RAM : 2KiB
Write-unprotecting flash
Got NACK from device on command 0x73
Done.
</code></pre>

<p>So sadly I have to use Windows software, the <a href="http://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/flasher-stm32.html">ST Demo Loader</a>. Download and install it and connect the DFU-Nitrokey to the Windows machine.</p>

<p>Also copy the compiled GNUK binary (<code>gnuk/src/build/gnuk.bin</code>) to the Windows machine.</p>

<h3>Flashing via Windows</h3>

<p>Start the utility up and select the correct COM port (COM4 for me):</p>

<p><img src="https://raymii.org/s/inc/img/stdemo/flash-1.png"></p>

<p>If the protection is set the tool will show a red traffic light and a <code>Remove Protection</code> button. Click and complete that, then click next:</p>

<p><img src="https://raymii.org/s/inc/img/stdemo/flash-2.png"></p>

<p>Click Next:</p>

<p><img src="https://raymii.org/s/inc/img/stdemo/flash-3.png"></p>

<p>Select <code>Download to device</code>, <code>Erase the necessary pages</code> and choose the <code>gnuk.bin</code> file:</p>

<p><img src="https://raymii.org/s/inc/img/stdemo/flash-4.png"></p>

<p>It will erase the flash:</p>

<p><img src="https://raymii.org/s/inc/img/stdemo/flash-5.png"></p>

<p>Then upload the firmware:</p>

<p><img src="https://raymii.org/s/inc/img/stdemo/flash-6.png"> </p>

<p>It will complete with a nice green bar:</p>

<p><img src="https://raymii.org/s/inc/img/stdemo/flash-7.png"> </p>

<p>Now the binary is flashed and your Nitrokey should work. In my case, it sucessfully worked with gnuk 1.2:</p>

<pre><code>$ gpg --card-status

Reader ...........: Nitrokey Nitrokey Start (FSIJ-1.2.1-87042430) 00 00
Application ID ...: D276000124010200FFFE870424300000
Version ..........: 2.0
Manufacturer .....: unmanaged S/N range
Serial number ....: 87042430
Name of cardholder: [not set]
Language prefs ...: [not set]
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 4
Signature key ....: 3D1B 8501 882B EA0D D813  6CAC 1437 62A5 87BD 54FE
      created ....: 2016-10-11 15:06:29
Encryption key....: 9898 208B 7876 4F65 A06E  3E65 637A 80D6 31D5 21C2
      created ....: 2016-10-11 15:06:29
Authentication key: 2141 3E30 8EFF F2D0 FB3D  4C9E DA3D F5B9 7130 1532
      created ....: 2016-10-11 15:06:29
General key info..: pub  rsa2048/0x143762A587BD54FE 2016-10-11 Remy test (Test gnuk1.2) &lt;remy@test.nl&gt;
sec&gt;  rsa2048/0x143762A587BD54FE  created: 2016-10-11  expires: 2016-10-18
                                  card-no: FFFE 87042430
ssb&gt;  rsa2048/0xDA3DF5B971301532  created: 2016-10-11  expires: 2016-10-18
                                  card-no: FFFE 87042430
ssb&gt;  rsa2048/0x637A80D631D521C2  created: 2016-10-11  expires: 2016-10-18
                                  card-no: FFFE 87042430
</code></pre>

<p>An EC 25519 key can now also be used:</p>

<pre><code>$ gpg --card-status

Reader ...........: Nitrokey Nitrokey Start (FSIJ-1.2.1-87042430) 00 00
Application ID ...: D276000124010200FFFE870424300000
Version ..........: 2.0
Manufacturer .....: unmanaged S/N range
Serial number ....: 87042430
Name of cardholder: [not set]
Language prefs ...: [not set]
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: ed25519 rsa2048 rsa2048
Max. PIN lengths .: 127 127 127
PIN retry counter : 3 3 3
Signature counter : 0
Signature key ....: 3678 F2EE 1CCB 4B24 B107  38BA 101D 491F 08E7 FD60
      created ....: 2016-10-11 15:31:27
Encryption key....: [none]
Authentication key: [none]
General key info..: pub  ed25519/0x101D491F08E7FD60 2016-10-11 test remy ecc (gnuk 1.2) &lt;nitrokey@raymii.nl&gt;
sec&gt;  ed25519/0x101D491F08E7FD60  created: 2016-10-11  expires: 2016-10-18
                                  card-no: FFFE 87042430
</code></pre>

<h3>Flashing via Linux</h3>

<p>After I used the Windows tool, the <code>stm32flash</code> tool works as well. (Device should be in bootloader mode with the wire bridge):</p>

<pre><code>sudo stm32flash -w build/gnuk.bin -g 0x0 /dev/ttyUSB0 
</code></pre>

<p>Output:</p>

<pre><code>stm32flash 0.5

http://stm32flash.sourceforge.net/

Using Parser : Raw BINARY
Interface serial_posix: 57600 8E1
Version      : 0x22
Option 1     : 0x00
Option 2     : 0x00
Device ID    : 0x0410 (STM32F10xxx Medium-density)
- RAM        : 20KiB  (512b reserved by bootloader)
- Flash      : 128KiB (size first sector: 4x1024)
- Option RAM : 16b
- System RAM : 2KiB
Write to memory
Erasing memory
Wrote address 0x0801b000 (100.00%) Done.

Starting execution at address 0x08000000... done.
</code></pre>
</div><hr>Tags: <a href="../tags/fst-01.html" class="link">fst-01, </a><a href="../tags/gnuk.html" class="link">gnuk, </a><a href="../tags/gnupg.html" class="link">gnupg, </a><a href="../tags/gpg.html" class="link">gpg, </a><a href="../tags/neug.html" class="link">neug, </a><a href="../tags/nitrokey.html" class="link">nitrokey, </a><a href="../tags/nitrokey-start.html" class="link">nitrokey-start, </a><a href="../tags/start.html" class="link">start, </a><a href="../tags/stm32f103tb.html" class="link">stm32f103tb, </a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
     
    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->
    </body>
    </html>
    