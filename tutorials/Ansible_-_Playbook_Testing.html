<!DOCTYPE html><html lang="en"><head><title>Ansible - Playbook Testing - Raymii.org</title><link href="/s/inc/css/bootstrap.css" rel="stylesheet"/><link href="/s/inc/css/custom.css" rel="stylesheet"/><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="http://feeds.feedburner.com/Raymiiorg" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a> <div class="container-fluid "><div class="row"><div class="col-md-10 col-md-offset-1"><div class="col-md-3 well"> <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org</a></h3><h6>Quis custodiet ipsos custodes?</h6><h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS Feed</a></h6></div><div class="col-md-4 green-block"><h3>Featured Items</h3><a class="whitelink" href="/s/tutorials/Ansible_Deployment_Framework.html">Ansible Deployment Framework</a><br/><a class="whitelink" href="/s/articles/Digital_Ocean_Sucks._Use_Digital_Ocean.html">Digital Ocean Sucks. Use Digital Ocean</a><br/><a class="whitelink" href="/s/tutorials/Gitlab_and_Active_Directory_LDAP_Authentication.html">Gitlab and Active Directory LDAP Authentication</a><br/><a class="whitelink" href="/s/articles/Small_Linux_PCs.html">Small Linux PCs</a><br/><a class="whitelink" href="/s/tutorials/Strong_SSL_Security_On_Apache2.html">Strong SSL Security On Apache2</a><br/><a class="whitelink" href="/s/tutorials/VMWare-ESXi-5-USB-installer.html">VMWare ESXi 5 USB installer</a><br/></div><div class="col-md-4 green-block"><h3>Featured Items</h3><a class="whitelink" href="/s/software/Bash_PHP_Server_Status_Monitor.html">Bash PHP Server Status Monitor</a><br/><a class="whitelink" href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html">IPSEC L2TP vpn with Ubuntu 12.04</a><br/><a class="whitelink" href="/s/software/Nopriv-IMAP-backup.html">Nopriv IMAP backup</a><br/><a class="whitelink" href="/s/articles/Set_up_your_own_truly_secure_encrypted_shared_storage_aka_Dropbox_clone.html">Set up your own truly secure encrypted shared storage aka Dropbox clone</a><br/><a class="whitelink" href="/s/tutorials/Strong_SSL_Security_On_nginx.html">Strong SSL Security On nginx</a><br/></div></div></div><div class="row-fluid"><div class="col-md-11 col-md-offset-1"><div class="col-md-3"><h3>Menu</h3><ul class="nav nav-pills nav-stacked"><li><a class="link" href="/s/">Home</a></li><li><a class="link" href="/s/static/Contact.html">Contact</a></li><li><a class="link" href="/s/static/Disclaimer.html">Disclaimer</a></li><li><a class="link" href="/s/static/Hosted_Piwik.html">Hosted Piwik</a></li><li><a class="link" href="/s/static/Sparkling_Network.html">Sparkling Network</a></li></ul><h3>Categories</h3><ul class="nav nav-pills nav-stacked"><li><a class="link" href="/s/articles">Articles</a></li><li><a class="link" href="/s/snippets">Snippets</a></li><li><a class="link" href="/s/software">Software</a></li><li><a class="link" href="/s/tutorials">Tutorials</a></li><li><a class="link" href="/s/everything.html">All Items</a></li></ul><hr class="alt2"/><h3>Donate</h3><ul><li><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting VPS Affiliate Link</a></li><li><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean VPS Affiliate</a></li></ul><script id="flattrbtn">(function(i){var f,s=document.getElementById(i);f=document.createElement('iframe');f.src='//api.flattr.com/button/view/?uid=Remy&url='+encodeURIComponent(document.URL);f.title='Flattr';f.height=62;f.width=55;f.style.borderWidth=0;s.parentNode.insertBefore(f,s);})('flattrbtn');</script><br/><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top"><input name="cmd" type="hidden" value="_s-xclick"/><input name="encrypted" type="hidden" value="-----BEGIN PKCS7-----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-----END PKCS7-----"/><input alt="PayPal - The safer, easier way to pay online!" name="submit" src="https://www.paypalobjects.com/en_US/NL/i/btn/btn_donateCC_LG.gif" type="image"/><img alt="" height="1" src="https://www.paypalobjects.com/nl_NL/i/scr/pixel.gif" width="1"/></form><script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script><script src="http://pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                </script></div> <div class="col-md-7"> <div class="inner"><h2>Ansible - Playbook Testing</h2><ul class="breadcrumb"><li><a class="link" href="../">Home</a></li><li><a class="link" href="../tutorials">Tutorials</a></li><li><a class="link" href="Ansible_-_Playbook_Testing.html">Ansible - Playbook Testing</a></li></ul><h6>Author: Remy Van Elst</h6><h6>Date: 21-12-2013</h6><br/><p>This Ansible article shows you how to run a basic test on your playbooks to check if their syntax is correct. It shows methods for both Ansble 1.3 and 1.4. When you get more complicated Ansible playbooks you sometimes have syntax (YAML) errors in them. It sometimes can take a while before those errors show up because they are lower in a playbook. By running the syntax check you make sure this won't happen.</p><h3>Dummy inventory file</h3><p>Lets say your playbooks are located in <code>/home/username/ansible/playbooks</code>. You have a few roles and a few playbooks. To test them, we need a dummy <code>ansible_hosts</code> file. Ceate it: </p><pre><code>cd ~/ansible/
mkdir tests/
vim tests/ansible_hosts
</code></pre><p>Put this in the file:</p><pre><code>[local]
127.0.0.1
</code></pre><p>Note that when executing the tasks it will not actually execute them on your local machine. It only does a syntax check.</p><h3>Testing</h3><p>Use the <code>--syntax-check</code> and <code>-list-tasks</code> options, plus the dummy inventory file to do a full syntax check, including all includes roles and task files:</p><pre><code>ansible-playbook --syntax-check --list-tasks -i tests/ansible_hosts ./example-playbook.yml
</code></pre><p>If there are no errors, you will get a list of tasks which the playbook wil execute:</p><pre><code>playbook: ./playbooks/default-vps-setup.yml

  play #1 (local):
    apt name={{item}} state=latest update_cache=yes
    apt pkg={{item}} state=absent
    template src=localegen.j2 dest=/etc/locale.gen
    template src=localepurge.j2 dest=/etc/locale.nopurge
    template src=timezone.j2 dest=/etc/timezone
    template src=issue.net.j2 dest=/etc/issue.net
    template src=issue.net.j2 dest=/etc/issue
    template src=hostname.j2 dest=/etc/hostname
</code></pre><p>If you have an error it will show up in red:</p><pre><code>ansible-playbook --syntax-check --list-tasks -i tests/ansible_hosts ./playbooks/default-vps-setup.yml

playbook: ./playbooks/default-vps-setup.yml

ERROR: Syntax Error while loading YAML script, /home/remy/ansible/playbooks/roles/vim/tasks/main.yml
Note: The error may actually appear before this position: line 3, column 7

-dfi://dsf;apt: pkg=vim-tiny state=latest update_cache=yes
  sudo: yes
</code></pre><h3>Testing all the playbooks</h3><p>My ansible git repository is set up like so:</p><pre><code> $ tree -L 3

|-- ansible_hosts
|-- ci.sh
|-- playbooks
|   |-- debug.yml
|   |-- default-vps-setup.yml
|   |-- group_vars
|   |   |-- all.yml
|   |   |-- apache-php.yml
|   |   |-- lighttpd-php.yml
|   |   |-- desktop-awesome.yml
|   |   `-- nginx-php.yml
|   |-- nginx-vps.yml
|   `-- roles
       |-- bash
|       |   `-- tasks
|       |-- basic-debian-setup
|       |   |-- files
|       |   |-- tasks
|       |   `-- templates
[...]
|       |-- vim
|       `-- vnstat
`-- tests
    `-- ansible_hosts
</code></pre><p>As you can see my playbooks are in the <code>playbooks</code> folder. To test all the playbooks I use the following find command piped trough to ansible:</p><pre><code>find ./playbooks -name '*.yml' -depth 1 | xargs -n1  ansible-playbook --syntax-check --list-tasks -i tests/ansible_hosts
</code></pre><p>The <code>-depth 1</code> makes sure only playbooks are tested, testing task or variable files will fail. </p><p>You can very easily add this setup to Jenkins or any other CI. I have my playbooks in Jenkins, asimple bash script named <code>ci.sh</code> is used as the only test step:</p><pre><code>#!/usr/bin/env bash
set -o errexit
set -o nounset
# set -o xtrace
set -o pipefail

__DIR__="$(cd "$(dirname "${0}")"; echo $(pwd))"
__BASE__="$(basename "${0}")"
__FILE__="${__DIR__}/${__BASE__}"

echo "################################"
echo "Build Information"
echo "Directory: ${__DIR__}"
echo "Filename: ${__FILE__}"
echo "Version Information:"
echo "Ansible Version: $(ansible --version)"
echo "Ansible Playbook Version: $(ansible-playbook --version)"
echo "Operating System: $(lsb_release -d | awk -F: '{ print $2 }' | tr -d '\t')"
echo "Kernel: $(uname -a)"
echo "################################"

echo "### Starting tests"

find ./playbooks -maxdepth 1 -name '*.yml'| xargs -n1  ansible-playbook --syntax-check --list-tasks -i tests/ansible_hosts
</code></pre><hr/>Tags: <a class="link" href="../tags/ansible.html">ansible, </a><a class="link" href="../tags/configuration-management.html">configuration-management, </a><a class="link" href="../tags/deployment.html">deployment, </a><a class="link" href="../tags/python.html">python, </a><a class="link" href="../tags/syntax.html">syntax, </a><a class="link" href="../tags/testing.html">testing, </a><a class="link" href="../tags/tests.html">tests, </a><a class="link" href="../tags/yaml.html">yaml, </a><div class="footer"><hr/><br/><hr/><p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br/></p></div></div></div></div> </div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&amp;lt;p&amp;gt;&amp;lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&amp;gt;&amp;lt;/p&amp;gt;</noscript></body></html>