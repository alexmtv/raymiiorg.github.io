<!DOCTYPE html><html lang="en"><head><title>Self Hosted CryptoCat - Secure self hosted multiuser webchat - Raymii.org</title><link href="/s/inc/css/light.css" rel="stylesheet" title="light"/><link href="/s/inc/css/dark.css" rel="alternate stylesheet" title="dark"/><script async="" src="/s/inc/js/jquery-2.1.1.min.js"></script><script async="" src="/s/inc/js/bootstrap.3.2.0.min.js"></script><script async="" src="/s/inc/js/styleswitcher.js"></script><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="https://raymii.org/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Items</a></li><li><a class="link" href="/s/tags/bash.html">Bash</a></li><li><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li><a class="link" href="/s/tags/ssl.html">SSL</a></li><li><a class="link" href="/s/tags/debian.html">Debian</a></li><li><a class="link" href="/s/tags/python.html">Python</a></li><li><a class="link" href="/s/tags/vpn.html">VPN</a></li><li><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li><a class="link" href="/s/tags/nginx.html">nginx</a></li><li><a class="link" href="/s/tags/openstack.html">Openstack</a></li><li><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><ul class="navbar-collapse nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Style<b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#" onclick="setActiveStyleSheet('dark')">Dark</a></li><li><a href="#" onclick="setActiveStyleSheet('light')">Light</a></li></ul></li></ul><br/><br/><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br/><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="9322003332" style="display:inline-block;width:200px;height:200px"></ins><script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">Self Hosted CryptoCat - Secure self hosted multiuser webchat</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../tutorials/index.html">Tutorials</a></li><li><a class="link" href="Self_Hosted_CryptoCat_-_Secure_Self_Hosted_Multiuser_Webchat.html">Self Hosted CryptoCat - Secure self hosted multiuser webchat</a></li></ul><p><small>09-11-2013</small> | <small>Remy van Elst</small></p><div class="ad"><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="6172324376" style="display:inline-block;width:728px;height:90px"></ins><script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script></div><br/><p><a href="https://raymii.org/s/inc/img/cryptocat.png"><img alt="cryptocat" height="320" src="https://raymii.org/s/inc/img/cryptocat.png" width="480"/></a></p><p>This is a guide on setting up a self hosted secure multiuser webchat service with CryptoCat. It covers the set up of ejabberd, nginx and the web interface for CryptoCat. It supports secure encrypted group chat, secure encrypted private chat and file and photo sharing.</p><p><a href="http://en.wikipedia.org/wiki/Cryptocat">There were/are some issues with the encryption provided by CryptoCat. These seem to be fixed now, but still, beware.</a></p><p>This tutorial is tested on Ubuntu 12.04.</p><p><a href="https://raymii.org/s/tutorials/Set_up_a_federated_XMPP_Chat_Network_with_ejabberd.html">If you want to set up a federated XMPP Chat Network with ejabberd, see my tutorial how to do that.</a></p><h3>Set up a DNS record</h3><p>Make sure you set up two DNS A records to your chat server. One should be for example <code>chat.sparklingclouds.nl</code> and the other is for the conferencing: <code>conference.chat.sparklingclouds.nl</code>. You should contact your provider if you need help with this.</p><p><strong>In the configuration files, you should replace <code>chat.sparklingclouds.nl</code> with your own domain name.</strong></p><h3>Install required packages</h3><p>First we install the required packages:</p><pre><code>apt-get install ejabberd nginx vim git
</code></pre><h3>ejabberd configuration</h3><p>Edit the ejabberd configuratio file located:</p><pre><code>/etc/ejabberd/ejabberd.cfg
</code></pre><p>And place the following contents in it, replacing chat.sparklingclouds.nl with your own domain:</p><pre><code>%% Hostname
{hosts, ["chat.sparklingclouds.nl"]}.

%% Logging
{loglevel, 0}.

{listen,
 [
  {5222, ejabberd_c2s, [
            {access, c2s},
            {shaper, c2s_shaper},
            {max_stanza_size, infinite},
                        %%zlib,
            starttls, {certfile, "/etc/ejabberd/ejabberd.pem"}
               ]},

  {5280, ejabberd_http, [
             http_bind,
             http_poll
            ]}
 ]}.

{s2s_use_starttls, true}.

{s2s_certfile, "/etc/ejabberd/ejabberd.pem"}.

{auth_method, internal}.
{auth_password_format, scram}.

{shaper, normal, {maxrate, 500000000}}.

{shaper, fast, {maxrate, 500000000}}.

{acl, local, {user_regexp, ""}}.

{access, max_user_sessions, [{10, all}]}.

{access, max_user_offline_messages, [{5000, admin}, {100, all}]}. 

{access, c2s, [{deny, blocked},
           {allow, all}]}.

{access, c2s_shaper, [{none, admin},
              {normal, all}]}.

{access, s2s_shaper, [{fast, all}]}.

{access, announce, [{allow, admin}]}.

{access, configure, [{allow, admin}]}.

{access, muc_admin, [{allow, admin}]}.

{access, muc, [{allow, all}]}.

{access, register, [{allow, all}]}.

{registration_timeout, infinity}.

{language, "en"}.

{modules,
 [
  {mod_privacy,  []},
  {mod_ping, []},
  {mod_private,  []},
  {mod_http_bind, []},
  {mod_admin_extra, []},
  {mod_muc,      [
          {host, "conference.@HOST@"},
          {access, muc},
          {access_create, muc},
          {access_persistent, muc},
          {access_admin, muc_admin},
          {max_users, 500},
          {default_room_options, [
            {allow_change_subj, false},
            {allow_private_messages, true},
            {allow_query_users, true},
            {allow_user_invites, false},
            {anonymous, true},
            {logging, false},
            {members_by_default, false},
            {members_only, false},
            {moderated, false},
            {password_protected, false},
            {persistent, false},
            {public, false},
            {public_list, true}
              ]}
                 ]},
  {mod_register, [
          {welcome_message, {"Welcome!"}},
          {access, register}
         ]}
 ]}.
</code></pre><p><a href="https://raymii.org/s/tutorials/Ejabberd_SSL_Certificate.html">If you want a signed ejabberd ssl certificate you can read my tutorial how to do that</a></p><h3>NGINX Configuration</h3><p>We need an SSL certificate for the web server. You can generate one yourself using the following command:</p><pre><code>cd /etc/ssl/certs
openssl req -nodes -x509 -newkey rsa:4096 -keyout key.pem -out cert.crt -days 356
</code></pre><p>Or generate a CSR and let it sign by a "official" CA like verisign or digicert:</p><pre><code>cd /etc/ssl/certs
openssl req -nodes -newkey rsa:4096 -keyout private.key -out CSR.csr 
</code></pre><p>When the certificate is in place you can continue to configure NGINX.</p><p>Edit the file or create a new virtual host.</p><pre><code>vim /etc/nginx/sites-enabled/default
</code></pre><p>And place the following contents in it, replacing chat.sparklingclouds.nl with your own domain:</p><pre><code>server {
    listen 80;
    listen [::]:80 default ipv6only=on;

    server_name chat.sparklingclouds.nl;
    rewrite     ^   https://$server_name$request_uri? permanent;

    add_header Strict-Transport-Security max-age=31536000;

    location / {
            root /var/www;
            index index.html index.htm;
    }
}

# HTTPS server
server {
    listen 443;
    server_name chat.sparklingclouds.nl;

    add_header Strict-Transport-Security max-age=31536000;

    ssl  on;
    ssl_certificate  /etc/ssl/certs/cert.crt;
    ssl_certificate_key  /etc/ssl/certs/key.pem;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 5m;

    ssl_protocols TLSv1.1 TLSv1.2;
            ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES128-SHA:RC4:HIGH:!MD5:!aNULL:!EDH;
            ssl_prefer_server_ciphers on;

    location / {
        root /var/www;
        index index.html index.htm;
    }

    location /http-bind {
        proxy_buffering off;
        tcp_nodelay on;
        keepalive_timeout 55;
        proxy_pass http://127.0.0.1:5280/http-bind;
    }
}
</code></pre><p>Save it and restart NGINX:</p><pre><code>/etc/init.d/nginx restart
</code></pre><h3>Cronjob for ejabberd</h3><p>This is important, it cleans up unused ejabberd accounts. Create a new crontab like so:</p><pre><code>crontab -e
</code></pre><p>And place the following in it:</p><pre><code>1 1 * * * ejabberdctl delete-old-users 1
</code></pre><p>That way once every 24 hours the ejabberd server gets cleaned up.</p><h3>Web Frontend</h3><p>Note that you now already can use your own server with the CryptoCat frontend via: <a href="https://crypto.cat">https://crypto.cat</a>. We are going to set up our own frontend on our webserver so we don't need Crypto.Cat.</p><p>Setting up a web frontend is not recommended by the cryptocat developers. See the comment below, <a href="http://www.reddit.com/r/linux/comments/1q8zha/self_hosted_cryptocat_secure_self_hosted/">and read the full thread on this Reddit post</a></p><pre><code>When you host Cryptocat as a website, this means that every time someone wants to use it, they technically will need to re-download the entire code by visiting the website. This means that every use needs a full re-download of the Cryptocat code. By centralizing the code redistribution in a "web front-end" and making it necessary for everyone to redownload the code every time, you create an opportunity for malicious code poisoning by the host, or code injection by a third party. This is why the only recommended Cryptocat download is the browser extension from the official website, which downloads only once as opposed to every time (just like a regular desktop application), and is authenticated by Cryptocat's development team as genuine.  
Kaepora - 12-11-2013 on Reddit
</code></pre><p>Take that into consideration when setting up the frontend. A use case could be an internal cryptocat chat service where people don't need to change the default server address and such.</p><p>First get the source code:</p><pre><code>cd /tmp
git clone https://github.com/cryptocat/cryptocat.git
</code></pre><p>Then place it in the right folder;</p><pre><code>cp -r cryptocat/src/core /var/www/
</code></pre><p>Edit the config file to use your own server:</p><pre><code>cd /var/www
vim js/cryptocat.js
</code></pre><p>And place the following contents in it, replacing chat.sparklingclouds.nl with your own domain:</p><pre><code>/* Configuration */
// Domain name to connect to for XMPP.
var defaultDomain = 'chat.sparklingclouds.nl'
// Address of the XMPP MUC server.
var defaultConferenceServer = 'conference.chat.sparklingclouds.nl'
// BOSH is served over an HTTPS proxy for better security and availability.
var defaultBOSH = 'https://chat.sparklingclouds.nl/http-bind/'
</code></pre><p>Now save the file.</p><p>You are finished now. Go to your website and test the chat out.</p><hr/>Tags: <a class="link" href="../tags/chat.html">chat,</a><a class="link" href="../tags/cryptocat.html">cryptocat,</a><a class="link" href="../tags/ejabberd.html">ejabberd,</a><a class="link" href="../tags/jabber.html">jabber,</a><a class="link" href="../tags/nginx.html">nginx,</a><a class="link" href="../tags/xmpp.html">xmpp,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>