<!DOCTYPE html><html lang="en"><head><title>Microsoft Exchange / Active Directory Powershell script to notify users of expiring Passwords - Raymii.org</title><link href="/s/inc/css/bootstrap.css" rel="stylesheet"/><link href="/s/inc/css/custom.css" rel="stylesheet"/><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="http://feeds.feedburner.com/Raymiiorg" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a> <div class="container-fluid "><div class="row"><div class="col-md-10 col-md-offset-1"><div class="col-md-3 well"> <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org</a></h3><h6>Quis custodiet ipsos custodes?</h6><h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS Feed</a></h6></div><div class="col-md-4 green-block"><h3>Featured Items</h3><a class="whitelink" href="/s/tutorials/Ansible_Deployment_Framework.html">Ansible Deployment Framework</a> <br/><a class="whitelink" href="/s/tutorials/Pass_the_SSL_Labs_Test_on_Apache2_(Mitigate_the_CRIME_and_BEAST_attack_-_Disable_SSLv2_-_Enable_PFS).html">Pass the SSL Labs Test on Apache2 (Mitigate the CRIME and BEAST attack Disable SSLv2 Enable PFS)</a> <br/><a class="whitelink" href="/s/articles/Small_Linux_PCs.html">Small Linux PCs</a> <br/><a class="whitelink" href="/s/tutorials/Strong_SSL_Security_On_Apache2.html">Strong SSL Security On Apache2</a> <br/><a class="whitelink" href="/s/tutorials/VMWare-ESXi-5-USB-installer.html">VMWare ESXi 5 USB installer</a> <br/></div><div class="col-md-4 green-block"><h3>Featured Items</h3><a class="whitelink" href="/s/software/Bash_PHP_Server_Status_Monitor.html">Bash PHP Server Status Monitor</a> <br/><a class="whitelink" href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html">IPSEC L2TP vpn with Ubuntu 12.04</a> <br/><a class="whitelink" href="/s/software/Nopriv-IMAP-backup.html">Nopriv IMAP backup</a> <br/><a class="whitelink" href="/s/tutorials/Pass_the_SSL_Labs_Test_on_NGINX_(Mitigate_the_CRIME_and_BEAST_attack_-_Disable_SSLv2_-_Enable_PFS).html">Pass the SSL Labs Test on NGINX (Mitigate the CRIME and BEAST attack Disable SSLv2 Enable PFS)</a> <br/></div></div></div><div class="row-fluid"><div class="col-md-11 col-md-offset-1"><div class="col-md-3"><h3>Menu</h3><ul class="nav nav-pills nav-stacked"><li><a class="link" href="/s/">Home</a> </li><li><a class="link" href="/s/static/Contact.html">Contact</a> </li><li><a class="link" href="/s/static/Disclaimer.html">Disclaimer</a> </li><li><a class="link" href="/s/static/Hosted_Piwik.html">Hosted Piwik</a> </li><li><a class="link" href="/s/static/Sparkling_Network.html">Sparkling Network</a> </li></ul><h3>Categories</h3><ul class="nav nav-pills nav-stacked"><li><a class="link" href="/s/articles">Articles</a> </li><li><a class="link" href="/s/snippets">Snippets</a> </li><li><a class="link" href="/s/software">Software</a> </li><li><a class="link" href="/s/tutorial">Tutorial</a> </li><li><a class="link" href="/s/tutorials">Tutorials</a> </li><li><a class="link" href="/s/everything.html">All Items</a></li><a class="link" href="/s/everything.html"></a> </ul><hr class="alt2"/><h3>Donate</h3><ul><li><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting VPS Affiliate Link</a></li><li><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean VPS Affiliate</a></li></ul><script id="flattrbtn">(function(i){var f,s=document.getElementById(i);f=document.createElement('iframe');f.src='//api.flattr.com/button/view/?uid=Remy&url='+encodeURIComponent(document.URL);f.title='Flattr';f.height=62;f.width=55;f.style.borderWidth=0;s.parentNode.insertBefore(f,s);})('flattrbtn');</script><br/><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top"><input name="cmd" type="hidden" value="_s-xclick"/><input name="encrypted" type="hidden" value="-----BEGIN PKCS7-----MIIHLwYJKoZIhvcNAQcEoIIHIDCCBxwCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYB1lOyoMm13xLpyJ06VTAajIRPFl46+yfqSnLQLu1lFfVKmhLtM0Ql+JSnH+LzVuhHLTzXegaPClXjMvhTpp0byApM4YlCi1czJKxBGb2+qw6il53H1g7L1qlfm95Jd80s80C9r+b3ituTXuYhb4Eb7PQ6Cyy6ca9raUgYVv90pETELMAkGBSsOAwIaBQAwgawGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIS23AJUhGuB6AgYhcWUVn4DMqTx2Ai2Ql9TQjkiAC3tXScmjpq/10b0P6DTIIg5OSPIly9C2gLMEcMCZ8aNuLT3kp+2Hn+nDuzsdY/4QU8zOFC4STyDrAn1gqe8q4pPGADqE0KUiWRAJR8eTx9paclkiaxDicr3D0uF409IRLIe/v1S6ZV9JOlQk5Xys9cRfAuhTioIIDhzCCA4MwggLsoAMCAQICAQAwDQYJKoZIhvcNAQEFBQAwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tMB4XDTA0MDIxMzEwMTMxNVoXDTM1MDIxMzEwMTMxNVowgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDBR07d/ETMS1ycjtkpkvjXZe9k+6CieLuLsPumsJ7QC1odNz3sJiCbs2wC0nLE0uLGaEtXynIgRqIddYCHx88pb5HTXv4SZeuv0Rqq4+axW9PLAAATU8w04qqjaSXgbGLP3NmohqM6bV9kZZwZLR/klDaQGo1u9uDb9lr4Yn+rBQIDAQABo4HuMIHrMB0GA1UdDgQWBBSWn3y7xm8XvVk/UtcKG+wQ1mSUazCBuwYDVR0jBIGzMIGwgBSWn3y7xm8XvVk/UtcKG+wQ1mSUa6GBlKSBkTCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb22CAQAwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQUFAAOBgQCBXzpWmoBa5e9fo6ujionW1hUhPkOBakTr3YCDjbYfvJEiv/2P+IobhOGJr85+XHhN0v4gUkEDI8r2/rNk1m0GA8HKddvTjyGw/XqXa+LSTlDYkqI8OwR8GEYj4efEtcRpRYBxV8KxAW93YDWzFGvruKnnLbDAF6VR5w/cCMn5hzGCAZowggGWAgEBMIGUMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbQIBADAJBgUrDgMCGgUAoF0wGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMTMwODAzMTQxNTQ2WjAjBgkqhkiG9w0BCQQxFgQUhdv5C5Xqr+zLV4qAlrYYqFV/fgYwDQYJKoZIhvcNAQEBBQAEgYBaGzom1dMP+CEmGQIZfP6ynZyRIc+4uQuvKoeRlkHwOj9F4c8QqXwBq/fyMogtZ/iES1oTifarxzQ3gesy/dSSs+IxG6YLICQXsAWNVnYL7u9of1xcCyJh3QoH/elgrjdHw0KCeBWNZPlbzEKSwTJ08yBsuKFR8zSqz8pIjC6XrQ==-----END PKCS7-----"/><input alt="PayPal - The safer, easier way to pay online!" border="0" name="submit" src="https://www.paypalobjects.com/en_US/NL/i/btn/btn_donateCC_LG.gif" type="image"/><img alt="" border="0" height="1" src="https://www.paypalobjects.com/nl_NL/i/scr/pixel.gif" width="1"/></form><script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script><script src="http://pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                </script></div> <div class="col-md-7"> <div class="inner"><h2>Microsoft Exchange / Active Directory Powershell script to notify users of expiring Passwords</h2><ul class="breadcrumb"><li><a class="link" href="../">Home</a> <col-md- class="divider">/</col-md-></li><li><a class="link" href="../software">Software</a> <col-md- class="divider">/</col-md-></li><li><a class="link" href="Microsoft_Exchange_Powershell_Script_User_Password_Expiry.html">Microsoft Exchange / Active Directory Powershell script to notify users of expiring Passwords</a> </li></ul><h6>Author: Remy Van Elst</h6><h6>Date: 08-08-2013</h6><br/><p>This is a small PowerShell script which emails your users that their password is going to expire in X days. This is needed when you have an Active Directory and Exchange Environment, but your users do not log in to a Windows machine bound to the Active Directory, but for example a Mac OS X or Linux machine with Full Disk Encryption enabled. Then they are not notified that their password is about to expire. This script can run as a scheduled task and scan and email your users that their password is about to expire.</p><p>It is tested on a Windows Server 2008 environment, with Exchange 2010. Domain is not running in Mixed mode, all servers are Windows Server 2008 R2. The script is installed as a scheduled task on one of the Exchange Edge servers with the SMTP role, but it does not have to be there, because the SMTP server variable is configurable. The amount of days to email before a password expires is also configurable.</p><h3>PowerShell setup</h3><p>First we need to allow execution of unsigned Powershell scripts. <em>This can be dangerous, so make sure your server security is adequate.</em> Fire up a <code>cmd.exe</code> <em>with elevated privileges, run it as admin</em> and launch <code>powershell</code>. Then execute the following command:</p><pre><code>Set-ExecutionPolicy unrestricted
</code></pre><p>This does the following:</p><pre><code>Load all configuration files and run all scripts.
If you run an unsigned script that was downloaded from the
internet, you are prompted for permission before it runs.
</code></pre><p><a href="http://ss64.com/ps/set-executionpolicy.html">More info on the Set-ExecutionPolicy cmdlet</a></p><h3>The script</h3><pre><code>$ExpireDays = 30
$SendingEmail = "helpdesk@example.org"
$SMTPHost="127.0.0.1"
Import-Module ActiveDirectory
$AllUsers = get-aduser -filter * -properties * |where {$_.Enabled -eq "True"} | where { $_.PasswordNeverExpires -eq $false } | where { $_.passwordexpired -eq $false }
foreach ($User in $AllUsers)
{
  $Name = (Get-ADUser $User | foreach { $_.Name})
  $Email = $User.emailaddress
  $PasswdSetDate = (get-aduser $User -properties * | foreach { $_.PasswordLastSet })
  $MaxPasswdAge = (Get-ADDefaultDomainPasswordPolicy).MaxPasswordAge
  $ExpireDate = $PasswdSetDate + $MaxPasswdAge
  $Today = (get-date)
  $DaysToExpire = (New-TimeSpan -Start $Today -End $ExpireDate).Days
  $EmailSubject="Password Expiry Notice - your password expires in $DaystoExpire days"
  $Message="
  Dear $Name,
  <p> Your Password expires in $DaysToExpire days.<br />
  To change your password, please go to https://webmail.example.org/owa/, log in and click the settings button, then click Change Password. <br />
  If you do not update your password in $DaysToExpire days, you will not be able to log in, so please make sure you update your password. <br />
  If you need any help, contact us via email: helpdesk@example.org, by internal phone 1337, or walk by Building C, Floor 4, Room C41A. <br />
  Sincerely, <br />
  The IT Department. <br />
  </p>"
  if ($DaysToExpire -lt $ExpireDate)
  {
    echo "$Email expires in $DaysToExpire days"
    Send-Mailmessage -smtpServer $SMTPHost -from $SendingEmail -to $Email -subject $EmailSubject -body $Message -bodyasHTML -priority High

  } 
}
</code></pre><p>Save this as a <code>.ps1</code> script, for example <code>Expiry-Mail-30.ps1</code>. Then set up a scheduled task to run every night, without the user being logged in, as action executing this script. It will send out an email to all users with a password that expires in 30 days, it will keep doing so until they change it.</p><h3>For the helpdesk</h3><p>You can also change the script to send the email directly to the IT helpdesk, so that they can manually contact the user. Or you can do it both, or create a copy script and task with the <code>$ExpireDays</code> set to 2 and the email to IT Helpdesk, so that the user has a month to change their password, and the IT staff can help the user before it is to late.</p><hr/> Tags: <a class="link" href="../tags/active-directory.html">active-directory, </a> <a class="link" href="../tags/exchange.html">exchange, </a> <a class="link" href="../tags/ldap.html">ldap, </a> <a class="link" href="../tags/microsoft.html">microsoft, </a> <a class="link" href="../tags/outlook.html">outlook, </a> <a class="link" href="../tags/owa.html">owa, </a> <a class="link" href="../tags/password.html">password, </a> <a class="link" href="../tags/windows-server.html">windows-server, </a> <div class="footer"><hr/><br/><hr/><p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br/></p></div></div></div></div> </div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&amp;lt;p&amp;gt;&amp;lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&amp;gt;&amp;lt;/p&amp;gt;</noscript></body></html>