
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Restrict SSH - Raymii.org</title>
        <link href="/s/inc/css/bootstrap.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link rel="alternate" type="application/rss+xml" title="Raymii.org RSS" href="http://feeds.feedburner.com/Raymiiorg" />

    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
        <div class="row-fluid">
        
        <div class="span10 offset1">
                
            <div class="span4 well"> 
            
                <h1 class="topheader">Raymii.org</h1>
                <h6>Quis custodiet ipsos custodes?</h6>
                <h6><a href="http://feeds.feedburner.com/Raymiiorg">RSS</a></h6>
            
            </div>

            <div class="span4 green-block">
                
                    <h3>Featured Items</h3>
    <a href="/s/tutorials/Ansible.html" class="whitelink">Ansible</a>
<br />
<a href="/s/tutorials/Autossh_persistent_tunnels.html" class="whitelink">Autossh persistent tunnels</a>
<br />
<a href="/s/static/Hosted_Piwik.html" class="whitelink">Hosted Piwik</a>
<br />
<a href="/s/tutorials/Munin_optimalization_on_Debian.html" class="whitelink">Munin optimalization on Debian</a>
<br />
<a href="/s/articles/Small_Linux_PCs.html" class="whitelink">Small Linux PCs</a>
<br />

            
        </div>
        <div class="span4 green-block">
            
                <h3>Featured Items</h3>
    <a href="/s/software/Bash_PHP_Server_Status_Monitor.html" class="whitelink">Bash PHP Server Status Monitor</a>
<br />
<a href="/s/tutorials/IPSEC_L2TP_vpn_with_Ubuntu_12.04.html" class="whitelink">IPSEC L2TP vpn with Ubuntu 12.04</a>
<br />
<a href="/s/software/Nopriv.py.html" class="whitelink">Nopriv.py</a>
<br />
<a href="/s/software/NutsManager.html" class="whitelink">NutsManager</a>
<br />
<a href="/s/tutorials/Tahoe_LAFS_Storage_Grid.html" class="whitelink">Tahoe LAFS Storage Grid</a>
<br />

            
        </div>
    </div>
    
    </div>
    <div class="row-fluid">
    <div class="span10 offset1">
    

    <div class="span3">
    <h3>Menu</h3><ul class="nav nav-pills nav-stacked">
<li><a href="/s/" class="link">Home</a>
</li>
<li><a href="/s/static/Contact.html" class="link">Contact</a>
</li>
<li><a href="/s/static/Disclaimer.html" class="link">Disclaimer</a>
</li>
<li><a href="/s/static/Hosted_Piwik.html" class="link">Hosted Piwik</a>
</li>
<li><a href="/s/static/Terrible-Linux.html" class="link">Terrible Linux</a>
</li>
</ul>
<h3>Categories</h3>
<ul class="nav nav-pills nav-stacked">
<li><a href="/s/articles" class="link">Articles</a>
</li>
<li><a href="/s/snippets" class="link">Snippets</a>
</li>
<li><a href="/s/software" class="link">Software</a>
</li>
<li><a href="/s/tutorials" class="link">Tutorials</a>
</li>
</ul>
               <!-- advertisement start -->
                <hr class="alt2">
                <h2>Advertisement</h2>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Need a VPS server? InceptionHosting has excellent VPS servers located in the USA or NL!</a></p>
                <script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                /* Raymii-2 */
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script>
                <script type="text/javascript"
                src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>    
                <!-- advertisement end -->

           </div>  
           <div class="span7"> 
                <div class="inner">


           <h2>Restrict SSH</h2>
<ul class="breadcrumb">
<li><a href="../" class="link">Home</a>
<span class="divider">/</span></li>
<li><a href="../software" class="link">Software</a>
<span class="divider">/</span></li>
<li><a href="Restrict_SSH.html" class="link">Restrict SSH</a>
</li>
</ul>
<h6>Author: Remy Van Elst</h6>
<h6>Date: 20-01-2013</h6>
<br>
<p>restrict<em>ssh.sh is a bash script which restricts ssh for a user to a set of (flexible) commands via .ssh/authorized</em>keys, and log it verbosely.</p>

<h3>Purpose</h3>

<p>I have a web application which needs to do some things over ssh on a server. It runs as a seperate user, and this script allows me to restrict the commands it can execute as well. It however does allow regexes so filenames can be passed. It also logs the commands and session info.</p>

<h3>Installation / Usage</h3>

<p>Download the script from github, or clone the repository.</p>

<p>Put this script in the users home directory, or a directory which is accessible by that user.</p>

<p>Edit the <code>allowed_commands</code> array:</p>

<pre><code>declare -a allowed_commands=(&#39;^ls -[l|d|a]$&#39; &#39;ls -la&#39; &#39;w&#39; &#39;uptime&#39; &#39;pwd&#39; &#39;uname -a&#39;) 
</code></pre>

<p>Make sure that there are no comma&#39;s (<code>,</code>) between the options, otherwise it will fail.</p>

<p>Make it executable for that user: <code>chown user:usergroup /home/user/restrict_ssh.sh</code> and/or <code>chmod +x /home/user/restrict_ssh.sh</code>.</p>

<p>Modify the users <code>~/.ssh/authorized_keys</code> file, and before the ssh key(s) put the line <code>command=&quot;/home/user/restrict_ssh.sh&quot;</code> before the key. Like so:</p>

<pre><code>command=&quot;/home/remy/restrict_ssh.sh&quot; ssh-rsa AAAAB[...]X9t remy@macbookpro.raymii.nl
</code></pre>

<p>Optional: Disable password login for that user, edit <code>/etc/ssh/sshd_config</code> and add the following:</p>

<pre><code>Match User remy
    PasswordAuthentication no
</code></pre>

<p>This will disable password logins only for user <code>remy</code>.</p>

<h3>Regexing / Safety</h3>

<p>The default setup has a regex command allowed. It is the <code>ls</code> command, and the regex allows either <code>ls -l</code>, <code>ls -d</code> or <code>ls -a</code>. If you know basic Perl style regexes you can be very creative with this, for example <code>^ping -c 4 [a-zA-Z0-9]{2,20}.(com|org|net)$</code> allows the command ping to be executed for any 2 to 20 character .com, .net or .org domain. domain and nothing else.</p>

<p><em>BE CAREFULL WITH THIS. IF YOU CONFIGURE IT WRONG USER MAY BE ABLE TO GET A SHELL (vim, :!bash) OR OVERWRITE THE .ssh/authorized_keys FILE. IF YOU ARE NOT SURE, THEN DO NOT USE IT AT ALL!</em></p>

<p>Also, if you allow <code>vim</code>, <code>less</code>, <code>man</code>, or any other program, a user might get a shell. If the program you allow includes the possibility to run a shell, this script/restriction is of no use.</p>

<h3>Logging</h3>

<p>By default it logs lines like these to syslog:</p>

<pre><code>Jan 20 20:39:23 vps11 RESTRICTED_SSH[9015]: INFO: SSH Connection: &#39;x.x.x.x 32309 x.x.x.x 22&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9014]: INFO: SSH Client: &#39;x.x.x.x 32309 22&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9017]: INFO: SSH Username: &#39;remy&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9016]: INFO: SSH Shell: &#39;/bin/bash&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9013]: INFO: Sent SSH command: &#39;vim&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9018]: ERROR: Command &quot;vim&quot; is not allowed.
</code></pre>

<h3>Other info</h3>

<p>I think it requires <code>Bash 4+</code> because of the array search function. I have no bash lower than v4 to test it with.</p>

<h3>Links</h3>

<p><a href="https://raymii.org/s/software/Restrict_SSH.html">https://raymii.org/s/software/Restrict_SSH.html</a><br>
<a href="https://github.com/RaymiiOrg/restrict_ssh">https://github.com/RaymiiOrg/restrict_ssh</a></p>
<hr>
Tags: <a href="../tags/authorized_keys.html" class="link">authorized_keys, 
</a>
<a href="../tags/bash.html" class="link">bash, 
</a>
<a href="../tags/openssh.html" class="link">openssh, 
</a>
<a href="../tags/restricted.html" class="link">restricted, 
</a>
<a href="../tags/ssh.html" class="link">ssh, 
</a>
<div class="footer">
                <hr />
                <br />
                <p>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    var disqus_shortname = 'raymiiorg'; // required: replace example with your forum shortname
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </p>
        
                <hr>

                <p>Generated by <a href="https://raymii.org/s/software/ingsoc.html">ingsoc</a>.<br />

                <small></small></p>
                
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
     
    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->
    
    <!-- google analytics -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-3704876-6");
    pageTracker._trackPageview();
    } catch(err) {}</script>
    <!--end analytics -->
    </body>
    </html>
    