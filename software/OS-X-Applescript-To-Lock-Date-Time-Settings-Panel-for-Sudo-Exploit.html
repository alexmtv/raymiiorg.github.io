<!DOCTYPE html><html lang="en"><head><title>OS X - Applescript to lock date and time preference panel to fix local sudo exploit - Raymii.org</title><link href="/s/inc/css/light.css" rel="stylesheet" title="light"/><link href="/s/inc/css/dark.css" rel="alternate stylesheet" title="dark"/><script async="" src="/s/inc/js/jquery-2.1.1.min.js"></script><script async="" src="/s/inc/js/bootstrap.3.2.0.min.js"></script><script async="" src="/s/inc/js/styleswitcher.js"></script><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="https://raymii.org/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Items</a></li><li><a class="link" href="/s/tags/bash.html">Bash</a></li><li><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li><a class="link" href="/s/tags/ssl.html">SSL</a></li><li><a class="link" href="/s/tags/debian.html">Debian</a></li><li><a class="link" href="/s/tags/python.html">Python</a></li><li><a class="link" href="/s/tags/vpn.html">VPN</a></li><li><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li><a class="link" href="/s/tags/nginx.html">nginx</a></li><li><a class="link" href="/s/tags/openstack.html">Openstack</a></li><li><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><ul class="navbar-collapse nav navbar-nav"><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Style<b class="caret"></b></a><ul class="dropdown-menu"><li><a href="#" onclick="setActiveStyleSheet('dark')">Dark</a></li><li><a href="#" onclick="setActiveStyleSheet('light')">Light</a></li></ul></li></ul><br/><br/><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link</a><br/><script type="text/javascript"><!--
                google_ad_client = "ca-pub-7993642564731324";
                google_ad_slot = "9322003332";
                google_ad_width = 200;
                google_ad_height = 200;
                //-->
                </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">OS X - Applescript to lock date and time preference panel to fix local sudo exploit</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../software/index.html">Software</a></li><li><a class="link" href="OS-X-Applescript-To-Lock-Date-Time-Settings-Panel-for-Sudo-Exploit.html">OS X - Applescript to lock date and time preference panel to fix local sudo exploit</a></li></ul><p><small>02-09-2013</small> | <small>Remy van Elst</small></p><div class="ad"><script type="text/javascript"><!--
                            google_ad_client = "ca-pub-7993642564731324";
                            /* voorartikel */
                            google_ad_slot = "6172324376";
                            google_ad_width = 728;
                            google_ad_height = 90;
                            //-->
                            </script><script src="//pagead2.googlesyndication.com/pagead/show_ads.js" type="text/javascript">
                            </script></div><br/><p>This applescript locks the OS X Date and Time Preference Panel. It can be run via Apple Remote Desktop. This is related to <a href="https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2013-1775">CVE-2013-1775</a>, a local sudo root exploit on OS X. If the date and time preference panel is locked, setting the date and time also requires a sudo password.</p><p>To exploit the bug you have to be in an administrative group and you have to have used sudo before. OS X by default does not require extra authentication to set the date for administrative users. Limited users are not able to do this.</p><pre><code>When a user successfully authenticates with sudo, a time stamp
file is updated to allow that user to continue running sudo
without requiring a password for a preset time period (five
minutes by default).  The user's time stamp file can be reset
using "sudo -k" or removed altogether via "sudo -K".

A user who has sudo access and is able to control the local
clock (common in desktop environments) can run a command via
sudo without authenticating as long as they have previously
authenticated themselves at least once by running "sudo -k" and
then setting the clock to the epoch (1970-01-01 01:00:00).

The vulnerability does not permit a user to run commands other
than those allowed by the sudoers policy.
</code></pre><p><a href="http://seclists.org/oss-sec/2013/q1/489">Source</a></p><p>This script locks the date and time panel. When that is done, OS X requires a password to change the date and time. It is an applescript, it checks if the panel is locked or unlocked and if it is unlocked it locks it. It can also be run via Apple Remote Desktop.</p><p>The Applescript:</p><pre><code>-- By R. van Elst
-- License: GNU GPL v3 
quit application "System Preferences"
quit application "System Preferences"

tell application "System Preferences"
    activate
    set current pane to pane id "com.apple.preference.datetime"
end tell


tell application "System Events" to set frontmost of process "System Preferences" to true
tell application "System Events"
    tell process "System Preferences"
        tell window 1
            --set titlell to title of button 4
            --display dialog titlell
            if title of button 4 is "Click the lock to prevent further changes." then
                click button 4
            end if
        end tell
    end tell
end tell
quit application "System Preferences"
</code></pre><p>To run this via Apple Remote Desktop, select a machine and the run a UNIX command on it. Make sure it runs as the currently logged in console user. Paste this command in there:</p><pre><code>osascript &lt;&lt; endofSCRIPT

quit application "System Preferences"
quit application "System Preferences"

tell application "System Preferences"
    activate
    set current pane to pane id "com.apple.preference.datetime"
end tell


tell application "System Events" to set frontmost of process "System Preferences" to true
tell application "System Events"
    tell process "System Preferences"
        tell window 1
            --set titlell to title of button 4
            --display dialog titlell
            if title of button 4 is "Click the lock to prevent further changes." then
                click button 4
            end if
        end tell
    end tell
end tell
quit application "System Preferences"

endofSCRIPT
</code></pre><p>This also works when the machine is locked. **<a href="https://raymii.org/s/snippets/OS-X-Enable-Access-for-assistive-devices-via-command-line.html">You do need to enable access for assistive devices. Click this link to see how to do that via the command line</a></p><p>Another option is to configure sudo to ask for a password every time. Edit <code>/etc/sudoers</code> and add the following:</p><pre><code>Defaults timestamp_timeout=0 
</code></pre><p>Thanks to <a href="http://tinyapps.org/">Miles from TinyApps.org for the tip!</a></p><hr/>Tags: <a class="link" href="../tags/apple.html">apple,</a><a class="link" href="../tags/apple-remote-desktop.html">apple-remote-desktop,</a><a class="link" href="../tags/ard.html">ard,</a><a class="link" href="../tags/command-line.html">command-line,</a><a class="link" href="../tags/exploit.html">exploit,</a><a class="link" href="../tags/mac.html">mac,</a><a class="link" href="../tags/os-x.html">os-x,</a><a class="link" href="../tags/sudo.html">sudo,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>