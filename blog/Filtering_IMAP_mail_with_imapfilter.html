<!DOCTYPE html><html lang="en"><head><title>Filtering IMAP mail with imapfilter - Raymii.org</title><link href="/s/inc/css/custom-first.css" rel="stylesheet"/><link href="/s/inc/css/light.css" rel="stylesheet"/><link href="/s/inc/css/custom.css" rel="stylesheet" title="custom"/><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Pages</a></li><li class="hideifsmall"><a class="link" href="/s/tags/bash.html">Bash</a></li><li class="hideifsmall"><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ssl.html">SSL</a></li><li class="hideifsmall"><a class="link" href="/s/tags/debian.html">Debian</a></li><li class="hideifsmall"><a class="link" href="/s/tags/python.html">Python</a></li><li class="hideifsmall"><a class="link" href="/s/tags/vpn.html">VPN</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li class="hideifsmall"><a class="link" href="/s/tags/nginx.html">nginx</a></li><li class="hideifsmall"><a class="link" href="/s/tags/openstack.html">Openstack</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br/><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="9322003332" style="display:inline-block;width:200px;height:200px"></ins><script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">Filtering IMAP mail with imapfilter</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../blog/index.html">Blog</a></li><li><a class="link" href="Filtering_IMAP_mail_with_imapfilter.html">Filtering IMAP mail with imapfilter</a></li></ul><p><small>17-01-2015</small> | <small>Remy van Elst</small></p><div class="ad"><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="6172324376" style="display:inline-block;width:728px;height:90px"></ins><script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script></div><br/><p><img alt="mail" src="https://raymii.org/s/inc/img/mail-send-receive.png"/></p><p>I have several email accounts at different providers. Most of them don't offer filtering capabilites like Sieve, or only their own non exportable rule system (Google Apps). My mail client of choice, Thunderbird, has filtering capabilities but my phone has not and I don't want to leave my machine running Thunderbird all the time since it gets quite slow with huge mailboxes. Imapfilter is a mail filtering utility written in Lua which connects to one or more IMAP accounts and filters on the server using IMAP queries. It is a lightweight command line utility, the configuration can be versioned and is simple text and it is very fast.</p><p>If you like this tutorial and want to support my website, use this link to order a Digital Ocean VPS: <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">https://www.digitalocean.com/?refcode=7435ae6b8212</a></p><p>Imapfilter is configured via a config file. This article will discuss this config file with filtering and other examples. Start with a blank one:</p><pre><code>mkdir -p ~/.imapfilter
vim ~/.imapfilter/config.lua
</code></pre><h3>Options</h3><p>imapfilter has a few global options which are configured via the <code>options.$OPTION = $VALUE</code> format. These are the ones I have, the manpage has more. Comments in the config file are prefix by two dashes (<code>--</code>).</p><pre><code>-- One of the work mailservers is slow.
-- The time in seconds for the program to wait for a mail server's response (default 60)
options.timeout = 120

-- According to the IMAP specification, when trying to write a message to a non-existent mailbox, the server must send a hint to the client, whether it should create the mailbox and try again or not. However some IMAP servers don't follow the specification and don't send the correct response code to the client. By enabling this option the client tries to create the mailbox, despite of the server's response. 
options.create = true

-- By enabling this option new mailboxes that were automatically created, get also subscribed; they are set active in order for IMAP clients to recognize them
options.subscribe = true

-- Normally, messages are marked for deletion and are actually deleted when the mailbox is closed. When this option is enabled, messages are expunged immediately after being marked deleted.
options.expunge = true
</code></pre><h3>Accounts</h3><p>I've defined two example accounts, one for work and one for personal stuff:</p><pre><code>account1 = IMAP {
  server = "imap.gmail.com",
  username = "joe@gmail.com",
  password = "P@ssw0rd",
  ssl = "tls1"
}

account2 = IMAP {
  server = "imap.mywork.org",
  username = "joe",
  password = "W0rdP@ss",
  ssl = "ssl3"
}
</code></pre><p>You can define as much accounts as needed. You can even <a href="http://thomaslevine.com/!/imapfilter/">get your accounts from offlineimap</a>:</p><pre><code>function offlineimap (key)
  local status
  local value
  status, value = pipe_from('grep -A2 mail.gandi.net ~/.offlineimaprc | grep ' .. key .. '|cut -d= -f2')
  value = string.gsub(value, ' ', '')
  value = string.gsub(value, '\n', '')
  return value
end


T = IMAP {
  server   = offlineimap('remotehost'),
  username = offlineimap('remoteuser'),
  password = offlineimap('remotepass'),
  ssl = 'ssl3',
}
</code></pre><h3>Mailboxes / Folders</h3><p>imapfilter has the concept of <code>mailboxes</code>. While technically correct, we general users just call them (top level) folders. <code>INBOX</code> is a mailbox, other folders are as well. After an IMAP account has been initialized, mailboxes residing in that account can be accessed simply as elements of the account table:</p><pre><code>myaccount.mymailbox
</code></pre><p>If mailbox names don't only include letters, digits and underscores, or begin with a digit, an alternative form must be used:</p><pre><code>myaccount['mymailbox']
</code></pre><p>A mailbox inside a folder (subfolder) can be only accessed by using the alternative form:</p><pre><code>myaccount['myfolder/mymailbox']
</code></pre><p>In this article I use this alternative form for ease of use and consistensy.</p><h3>Filtering</h3><p>The filters defined are processed in order from top to bottom. I mostly filter my inbox by moving messages to another folder. If a message matched a filter it is moved, if it would then lower on match another filter that would not apply to that mail because it is already moved.</p><p>See the <a href="http://linux.die.net/man/5/imapfilter_config">manpage</a> for all configuration options.</p><p>If you simply want to filter a message based on the sender, receipient or subject you can use the following. It moves all messages with the Duplicity mailing list address to the mailinglists folder:</p><pre><code>  messages = account1["INBOX"]:contain_to("duplicity-talk@nongnu.org")
  messages:move_messages(account1["Mailinglists/Duplicity-Talk"])
</code></pre><p>If you want to filter based on a few more parameters, you can use the following operators, <code>*</code> for AND, <code>+</code> for OR and <code>-</code> for NOT. To filter nagios messages with a certain subject line:</p><pre><code>  messages = account1["INBOX"]:contain_from("nagios@monitoring.org")
    * account1["INBOX"]:contain_subject("important_hostname")
  messages:move_messages(account1["Important/Nagios"])
</code></pre><p>To move messages from Nagios from less important hosts, but not with the "CRITICAL" subject and mark them as read:</p><pre><code>  messages = account1["INBOX"]:contain_from("nagios@monitoring.org")
    - account1["INBOX"]:contain_subject("CRITICAL:")
  messages:mark_seen()  
  messages:move_messages(account1["Monitoring/Nagios"])    
</code></pre><p>As you can see the <code>mark_seen()</code> operator marks messages as read.</p><p>With these operators you can construct advanced filters.</p><h3>Copying mail</h3><p>To copy mail from one account to another account's folder and mark those copied messages as read, for archival purposes for example, use the following filter:</p><pre><code>    messages = account2['INBOX']:is_unseen()
    messages:copy_messages(account1["Backup_of_Account2"])

    messages = account1['Backup_of_Account2']:is_unseen()
    messages:mark_seen()
</code></pre><p>Place this at the top of the <code>account2</code> filtering rules.</p><h3>pipe_to</h3><p>Taken from the <a href="https://raw.githubusercontent.com/lefcha/imapfilter/master/samples/extend.lua">extended configuration example</a> here is an example piece of code which sends mail to an external program and based on the output deletes the messages the program marked as spam.</p><pre><code>-- The auxiliary function pipe_to() is supplied for conveniency.  For
-- example if there was a utility named "bayesian-spam-filter", which
-- returned 1 when it considered the message "spam" and 0 otherwise:

all = account1["INBOX"]:is_unseen()

results = Set {}
for _, mesg in ipairs(all) do
    mbox, uid = table.unpack(mesg)
    text = mbox[uid]:fetch_message()
    if (pipe_to('bayesian-spam-filter', text) == 1) then
        table.insert(results, mesg)
    end
end

results:delete_messages()
</code></pre><h3>Conclusion</h3><p>The above examples will get you started with message filtering right away. The <a href="http://linux.die.net/man/5/imapfilter_config">manpage</a> and the <a href="https://github.com/lefcha/imapfilter/blob/master/samples/config.lua">example config</a> and the <a href="https://github.com/lefcha/imapfilter/blob/master/samples/extend.lua">extended example config</a> will get you even further.</p><hr/>Tags: <a class="link" href="../tags/dovecot.html">dovecot,</a><a class="link" href="../tags/filter.html">filter,</a><a class="link" href="../tags/gmail.html">gmail,</a><a class="link" href="../tags/imap.html">imap,</a><a class="link" href="../tags/imapfilter.html">imapfilter,</a><a class="link" href="../tags/lua.html">lua,</a><a class="link" href="../tags/mail.html">mail,</a><a class="link" href="../tags/sieve.html">sieve,</a><a class="link" href="../tags/smtp.html">smtp,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>