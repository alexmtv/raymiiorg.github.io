
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Migrating personal webapps and services - Raymii.org</title>
        <link href="/s/inc/css/custom-first.css" rel="stylesheet" />
        <link href="/s/inc/css/light.css" rel="stylesheet"  />
        <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />
        <script src="/s//inc/js/toc.js" type="text/javascript"></script>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link href="inc/img/icons/iphone.png" rel="apple-touch-icon" />
        <link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76" />
        <link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120" />
        <link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png" alt="IEC Resistor logo"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/index.html" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/everything.html" class="special-menu">All Pages</a></li><li class='hideifsmall'><a href="/s/tags/bash.html" class="link">Bash</a></li><li class='hideifsmall'><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li class='hideifsmall'><a href="/s/tags/ssl.html" class="link">SSL</a></li><li class='hideifsmall'><a href="/s/tags/debian.html" class="link">Debian</a></li><li class='hideifsmall'><a href="/s/tags/python.html" class="link">Python</a></li><li class='hideifsmall'><a href="/s/tags/vpn.html" class="link">VPN</a></li><li class='hideifsmall'><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li><li class='hideifsmall'><a href="/s/tags/nginx.html" class="link">nginx</a></li><li class='hideifsmall'><a href="/s/tags/openstack.html" class="link">Openstack</a></li><li class='hideifsmall'><a href="/s/tags/ansible.html" class="link">Ansible</a></li></ul>            
               <!-- advertisement start -->
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br />
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Raymii-2 -->
                <ins class="adsbygoogle"
                     style="display:inline-block;width:200px;height:200px"
                     data-ad-client="ca-pub-7993642564731324"
                     data-ad-slot="9322003332"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">

           <h2 class='headheader'>Migrating personal webapps and services</h2><ul class="breadcrumb"><li><a href="../index.html" class="link">Home</a></li><li><a href="../blog/index.html" class="link">Blog</a></li><li><a href="Migrating_personal_services_and_webapps.html" class="link">Migrating personal webapps and services</a></li></ul><p><small>05-05-2016</small> | <small>Remy van Elst</small></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p><img src='https://raymii.org/s/inc/img/ubuntu-16.04.png' alt=ubuntu></p>

<p>Recently I&#39;ve migrated some of my personal servers and services to new machines and newer operating system versions. I prefer to migrate instead of upgrading the OS for a number of reasons. I&#39;ll also talk about the migration process and some stuff to remember when migrating web applications and services.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a> </p>

<p>As many of you might also do, I run a number of servers with applications for my personal use and a number of websites for friends and family. My own application landscape consists of:</p>

<ul>
<li>7 Wordpress websites (family and friends)</li>
<li>3 Drupal websites (family and friends)</li>
<li>OwnCloud for Contacts and Calendar sync</li>
<li>Tiny Tiny RSS</li>
<li><a href="https://ssldecoder.org">My SSL tester</a></li>
<li><a href="https://cipherli.st">Cipherli.st</a></li>
<li><a href="https://certificatemonitor.org">Certificate Expiry Monitor</a></li>
<li><a href="https://ponify.nl">Ponify</a></li>
<li>Piwik statistics</li>
<li>Seven static websites with email hosting for family.</li>
</ul>

<p>This was all spread over three servers at different VPS providers, namely Linode, Digital Ocean and CloudVPS. The three servers were running Ubuntu 12.04 and CentOS 6, with Apache, PHP and MySQL. Plus exim and dovecot for email. Quite a few servers and setups to maintain. </p>

<h3>Reasons for migrating</h3>

<p>There are multiple reasons for migrating and consolidating all the services. </p>

<p>The first one is that the server with the most websites on it, including the <a href="https://ssldecoder.org">SSL Decoder</a> had a broken OpenSSL version. That was my own fault as I was playing with compiling prereleases and not using a (docker) container or other confinement, thus overwriting system OpenSSL and libssl libraries. In general that&#39;s not a big problem, but all kinds of little things broke because of this. </p>

<p>The second reason is that I got a nice message from Andrew, the Community Manager at <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean</a> regarding <a href="https://cipherli.st">Cipherli.st</a>. He said the site was used inside of <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean</a> and they like it. I got some credits applied to my account, so that means free servers for a few months, which is awesome. Thanks to <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Andrew and DO</a> for that. <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a></p>

<p>The third reason is that the servers were running older versions of Operating systems, like Ubuntu 12.04 LTS and CentOS 6. Both of those still receive support and updates, but lack new technology like Docker, LXD or systemd. I&#39;m planning on using both Docker and LXD to test the <a href="https://ssldecoder.org">SSL Decoder</a>. </p>

<p>The SSL Decoder now <a href="https://github.com/RaymiiOrg/ssl-decoder/tree/master/docker">includes a Dockerfile</a> which sets up Apache, PHP and the latest OpenSSL (1.1.0). That means I can&#39;t screw up the system OpenSSL anymore. In the future the SSL Decoder will probably run in a container for production as well. I&#39;ve set up a new VPS with Ubuntu 16.04 on <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean</a>, which because it&#39;s KVM and not OpenVZ or Xen PV allows me to run Docker without problems.</p>

<p>Plus, in my humble opinion this is just regular maintenance. Like you do regular maintenance on your car or bicycle, you should also do that for your servers.</p>

<p>In the next few paragraphs I&#39;ll talk about the migration itself and what to do before and after migrating. The process itself is fairly simple, not much more than a few database dumps and <code>rsync</code> copy&#39;s. As always, it&#39;s the small things surrounding the process that make it tricky.</p>

<h3>Before the migration</h3>

<p>There are a few things to do before you migrate (web)services. The most important thing is to make a list of all the things you&#39;re going to migrate. This includes:</p>

<ul>
<li>Websites (URL, logins, IP)</li>
<li>Databases </li>
<li>Email accounts</li>
<li>DNS zones</li>
<li>Dependencies</li>
<li>Current monitoring</li>
</ul>

<p>Note down all these things and make sure you test beforehand. That way you&#39;ll know what the result should be in a working setup.</p>

<p>The other important thing to do is to lower the DNS TTL (Time-to-live) of the domain&#39;s DNS zones. If it&#39;s a TTL of 1 week, the migration will take a lot longer. Lower it to 1 hour (nobody (public DNS) honours anything lower (the 5 minutes)). Don&#39;t forget that you have to await the current TTL before the new one is active. If it&#39;s now a week, then you&#39;ll have to wait a week before the 1 hour TTL is active.</p>

<p>The TTL is used to point people to the IP when they visit an URL. A high TTL lets DNS servers cache the IP longer, so people will be sent to the wrong IP. If you want you can raise the TTL after the migration.</p>

<p>Depending on the service you&#39;re migrating you also want to send the users a prior notice, maybe a few. I notified the relatives and users that the migration was upcoming three times and afterwards also emailed them the migration completed successfully.</p>

<p>With your list, lowered DNS TTL and notified users, continue on to the actual migration.</p>

<h3>Migration process</h3>

<p>The migration itself consists out of two things. Setting up the server and transferring the data.</p>

<p>In my case the setup of the server was super easy. It is set up with Ansible and the playbooks used to set up Apache, PHP and MySQL on Ubuntu 12.04 and CentOS 6 also worked without issues on Ubuntu 16.04. Within 15 minutes the whole setup was done, just by adding a new host to my <code>ansible_hosts</code> file and updating the <code>webserver</code> hostgroup with this extra host.</p>

<p>The dovecot and exim playbook required a few <code>if</code> statements in the configuration templates, but nothing worldshocking. I tested the playbooks first on a disposable Ubuntu 16.04 VPS.</p>

<p>If you have a more manual setup then this step consists of installing and configuring all the required software manually and hopefully having some sort of checklist.</p>

<p>The data transfer part was just doing a <code>mysqldump</code>, recreating those databases on the new server with the database users and importing the data. If you don&#39;t want to recreate the users you can <code>mysqldump</code> the <code>mysql</code> database, which contains the <code>users</code> table. The import of that is quite funny:</p>

<pre><code>mysql mysql &lt; mysql
</code></pre>

<p>The first <code>mysql</code> is the command, the second is the database name and the third is the filename to import, which I cleverly named <code>mysql</code>.</p>

<p>The other data, websites, scripts, mailboxes and more were transferred with <code>rsync</code> over <code>ssh</code>. Check the permissions afterwards if you decide to change usernames. I didn&#39;t do that so it all went without issues or <code>chown</code>-ing.</p>

<h3>After the migration</h3>

<p>When all the data is transferred and the software has been set up properly it is time to test the services. I did that using my <code>/etc/hosts</code> file, pointing the domains one by one to my new servers IP. I had my list of sites and services to test, which I did one by one. </p>

<p>One of the things I forgot to migrate was the certificate for the SMTP and IMAP service. I thought Ansible would set that up but appearantly it didn&#39;t. I updated the playbooks, so now it does set it up correctly. If I hadn&#39;t tested, my users would complain about a warning, and we put in all this effort to make sure that doesn&#39;t happen.</p>

<p>When all the tests were finished I changed the DNS for all the domains to point to the new IP. Leaving the TTL to one hour, so in case of a failure the fallback wouldn&#39;t take long. </p>

<p>After a few days of no complaints I shut off the old servers. My monitoring went off, but not for the services I migrated. Just the host checks, as expected.</p>

<p>I keep a backup of the machines locally just to be sure. The servers were cancelled at the respective providers two weeks after the migration completed.</p>

<h3>Stuff to remember when migrating webapps that email.</h3>

<p>My webapplication sends email, so there are a few extra things that need to be set up and checked. I&#39;ve listed them below for my own reference:</p>

<ul>
<li>Reverse DNS for IPv4</li>
<li>Reverse DNS for IPv6</li>
<li>SMTP mailname must match hostname and reverse name</li>
<li>SPF records must include new IP</li>
<li>DKIM keys need to be updated</li>
</ul>

<p>A good service to test email sending in <a href="https://www.mail-tester.com/">Mail Tester</a>. If you forget the mailsettings your emails will go right into the SPAM folder of many users.</p>

<h3>Conclusion</h3>

<p>With a little bit of preparation and thought, a migration like this is easy to do and relatively painless. By keeping your servers up to date you are not only more secure, you will also have less hassle in the future. </p>

<p>I&#39;ve seen many last-minute migrations gone wrong. For example, a big new security vulnerability affects your services. And particularly those important machines were the migration keeps getting deferred for a boatload of (stupid) reasons. And then you&#39;re forced to migrate them on an inconvinient time, not having a good prepared plan or test scheme and getting delays on your other projects as well.</p>

<p>Better to just do regular maintenance in your own pace. </p>

<p>I&#39;d like to thank <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean</a> again for the generous credit. It was the thing that pushed me over the edge to plan and do this consolidation and migration.</p>
</div><hr>Tags: <a href="../tags/dns.html" class="link">dns, </a><a href="../tags/migrate.html" class="link">migrate, </a><a href="../tags/migration.html" class="link">migration, </a><a href="../tags/php.html" class="link">php, </a><a href="../tags/ubuntu.html" class="link">ubuntu, </a><a href="../tags/website.html" class="link">website, </a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
     
    <!-- Piwik --> 
    <script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Code -->
    </body>
    </html>
    