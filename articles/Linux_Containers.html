<!DOCTYPE html><html lang="en"><head><title>Linux Containers - Raymii.org</title><link href="/s/inc/css/custom-first.css" rel="stylesheet"/><link href="/s/inc/css/light.css" rel="stylesheet"/><link href="/s/inc/css/custom.css" rel="stylesheet" title="custom"/><script src="/s//inc/js/toc.js" type="text/javascript"></script><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Pages</a></li><li class="hideifsmall"><a class="link" href="/s/tags/bash.html">Bash</a></li><li class="hideifsmall"><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ssl.html">SSL</a></li><li class="hideifsmall"><a class="link" href="/s/tags/debian.html">Debian</a></li><li class="hideifsmall"><a class="link" href="/s/tags/python.html">Python</a></li><li class="hideifsmall"><a class="link" href="/s/tags/vpn.html">VPN</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li class="hideifsmall"><a class="link" href="/s/tags/nginx.html">nginx</a></li><li class="hideifsmall"><a class="link" href="/s/tags/openstack.html">Openstack</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br/><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="9322003332" style="display:inline-block;width:200px;height:200px"></ins><script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">Linux Containers</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../articles/index.html">Articles</a></li><li><a class="link" href="Linux_Containers.html">Linux Containers</a></li></ul><p><small>12-11-2015</small> | <small>Jonathan Robe</small></p><div class="ad"><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="6172324376" style="display:inline-block;width:728px;height:90px"></ins><script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script></div><br/><div id="toc"><h3>Table of Contents</h3></div><hr/><div id="contents"><p>This article was originaly published in <a href="http://www.linuxvoice.com/download-linux-voice-issue-2/">Linux Voice, issue 2, May 2014</a>. This issue is now available under a <a href="https://creativecommons.org/licenses/by-sa/3.0/">Creative Commons BY-SA license</a>. In a nutshell: you can modify and share all content from the magazine (apart from adverts), even for commercial purposes, providing you credit Linux Voice as the original source, and retain the same license.</p><p>This remix is converted manually to Markdown and HTML for ease of archiving and copy-pasting.</p><p>If you like this, please subscribe to Linux Voice. It is an awesome magazine with an awesome team of people. <a href="http://shop.linuxvoice.com/">Click here to subscribe</a> from just GBP 38 and get future issues straight to your door or inbox! (DRM Free PDF's and more available).</p><p>If you like this website and want to support it AND get $10 Digital Ocean credit (2 months free), use this link to order: <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">https://www.digitalocean.com/?refcode=7435ae6b8212</a> (referral link).</p><p>Other converted Linux Voice articles <a href="https://raymii.org/s/tags/linux-voice.html">can be found here</a>.</p><hr/><p>Enterprise-grade virtualisation on a real kernel.</p><p>While Linux containers have been around for a while, they've recently been gaining more recognition as a lightweight alternative to traditional virtualisation products like KVM or VMWare. With the arrival of LXC, Docker, and the next generation of distributions, we're all likely to see a lot more of them over the coming decade.</p><p>As with all virtualisation, the idea of containers is to make it easy to run multiple applications on a single host, all the while ensuring each remains separate. This enables the administrator to carefully manage the resources assigned to each application and to ensure that they can't interfere with each other.</p><p>What makes containers different to traditional products is that they don't do any hardware emulation. Instead, the applications in question all run directly on top of the host kernel, just like any other process. Separation between the running containers is achieved through the careful use of a number of Linux kernel features.</p><p>Control Groups (<code>cgroups</code>) are the first of these features, and are probably the best known. They provide a mean for administrators to group processes, and all their future children, into hierarchical groups. Various subsystems can then be used to strictly manage the processes and the resources they interact with.</p><h3>Control groups</h3><p>If you have systemd installed, you can quickly inspect what cgroup your processes are running in with the <code>ps</code> command:</p><pre><code>ps -aeo pid,cgroup,command 
</code></pre><p>Running this, you should see that all processes are running in cgroups that exist in a hierarchy below the systemd cgroup. You could use systemd unit files to manage the resources assigned to a service (indeed, if you're using systemd, this is probably the best way to use cgroups), but you can also interact with cgroups directly, too.</p><p>There are a collection of tools available in the <code>libcgroup-tools</code> package, including <code>cgcreate</code>, for example. You can use this tool to create a new cgroup as follows:</p><pre><code>cgcreate -g memory,cpu:mysql 
</code></pre><p>This will create a new cgroup called <code>mysql</code> which has been tied to the memory and cpu subsystems. You can then take advantage of a command such as <code>cgset</code>, or interact directly with the virtual filesystem exposed by cgroups, to manipulate the resource limits of this newly created group:</p><pre><code>cgset -r swappiness=xxx /sys/fs/cgroups/memory/ mysql 
</code></pre><p>This command will set the <code>swappiness</code> parameter of all processes running in the <code>mysql</code> cgroup to <code>xxx</code>. To add a process to the cgroup, all you need to do is echo its PID to the tasks file in the cgroup's filesystem or use the <code>cgclassify</code> command.</p><p><img alt="cgroups" src="https://raymii.org/s/inc/img/linuxvoice/2/cgrous1.png"/></p><p>Image 1: The highlighted area shows the cgroup in which the different processes are running. As you can see, all are either in the systemd defaults of <code>systemd:/user.slice</code> and <code>systemd:/system.slice</code></p><h3>Namespace isolation</h3><p>Namespace isolation is the other key technology that makes containers possible on Linux. Each namespace wraps a particular system resource, and makes processes running inside that namespace believe they have their own instance of that resource. There are six namespaces in Linux:</p><ul><li>mount: Isolates the filesystems visible to a group of processes, similar to the chroot command.</li><li>UTS: Isolates host and domain names so that each namespace can have its own. (UTS = Unix Time Sharing)</li><li>IPC: Isolates System V and POSIX message queue interprocess communication channels. (IPC = InterProcess Communication)</li><li>PID: Lets processes in different PID namespaces have the same PID. (This is useful in containers, as it lets each container have its own <code>init</code> (PID 1) and allows for easy migration between systems. ) (PID = Process ID)</li><li>network: Enables each network namespace to have its own view of the network stack, including network devices, IP addresses, routing tables etc.</li><li>user: Allows a process to have a different UID and GID inside a namespace to what it has outside.</li></ul><p>A quick way to experiment with namespaces yourself is to use the <code>unshare</code> command. This will run a particular program, removing its connection to a particular namespace of its parent:</p><pre><code>sudo unshare -u /bin/bash 
</code></pre><p>This will create a new bash process that doesn't share its parent UTS namespace. If you now set the hostname to <code>foo</code>, you'll then be able to look, in another shell on the same system, and see that the hostname in the root (original) namespace hasn't changed.</p><p><img alt="cgroups" src="https://raymii.org/s/inc/img/linuxvoice/2/cgrous2.png"/></p><p>Image 2: The output of this long listing in the <code>/sys/fs/cgroup</code> directory shows all the different subsystems that are available for managing processes with cgroups on a default Fedora 20 install.</p><h3>Linux containers</h3><p>Now that you have an idea of what the underlying technologies do, let's take a look at Linux Containers (<code>LXC</code>), a userspace interface that brings them together. To install the LXC userspace tools, you need to install the <code>lxc</code> package on Ubuntu and Fedora, but in the case of the latter, you should also install <code>lxc-templates</code> and <code>lxc-extras</code> for a better experience.</p><p>Once that's done, creating a new container, depending on your requirements, can be simple. In the <code>/usr/share/lxc/templates</code> directory, you'll find a collection of scripts that will create some default containers, including <code>Debian</code>, <code>Fedora</code> and <code>Ubuntu</code> system containers, and <code>sshd</code>, <code>BusyBox</code> and <code>Alpine</code> application containers. To put one of these to use, all you need to do is run the following command:</p><pre><code>lxc-create -n linux-voice -t /usr/share/lxc/templates/busybox --dir /home/jon/containers/linux-voice
</code></pre><ul><li><code>-n</code>: sets the name of the container.</li><li><code>-t</code>: says which template you want to use.</li><li><code>--dir</code>: says where you want the rootfs for the new container to be created.</li></ul><p>This command creates a directory in <code>/var/lib/lxc</code> with the name set by the <code>-n</code> flag. The contents of this directory are populated by the script specified with the <code>-t</code> flag.</p><p>If you look at, say, the <code>BusyBox</code> template, you'll see that this script sets up a filesystem hierarchy, copies appropriate binaries and installs important pieces of configuration with <code>heredoc</code> statements. Inside the created directory, you'll also find that a config file has been created. This defines which system resources are to be isolated and controlled by the container.</p><p>The <code>man lxc.conf</code> command goes in to detail on what options can be put in this file, but a few key examples will be helpful:</p><ul><li><code>lxc.cgroup.cpu.shares = 1234</code>: Sets the share of CPU that the container has.</li><li><code>lxc.utsname = linux-voice</code>: Sets the hostname of the container.</li><li><code>lxc.mount.entry = /lib/home/jon/containers/busybox/lib</code>: Specifies directories on the host filesystem that should be mounted in the container.</li></ul><p>This configuration file means you can apply the existing templates in quite flexible ways, but if you really want to create a custom container, you're going to have to set to work creating your own template script.</p><p>As the LXC man page says, creating a system container is paradoxically easier than creating an application container.</p><p>In the latter case, you have to start by figuring out which resources you want to isolate from the rest of the system, and then figure out how to populate the appropriate parts of the file system etc. In the former case, you simply isolate everything, much simpler.</p><p>Once you've created your container with <code>lxc-create</code> and modified the config file as you see fit, you can start it with the <code>lxc-start</code> command, use <code>lxc-console</code> to get a console in it, and shut it down with <code>lxc-shutdown</code>.</p><p>While cgroups and namespaces have reached a degree of maturity in Linux, the user experience still has some room for improvement. If you found the <code>lxc-commands</code> tricky to use, you might want to install <code>libvirt-sandbox</code>, which will provide a set of scripts and extensions for using LXC through the familiar <code>libvirt</code> tools.</p></div><hr/>Tags: <a class="link" href="../tags/cgroups.html">cgroups,</a><a class="link" href="../tags/container.html">container,</a><a class="link" href="../tags/docker.html">docker,</a><a class="link" href="../tags/linux-voice.html">linux-voice,</a><a class="link" href="../tags/linux-voice-issue-2-2014.html">linux-voice-issue-2-2014,</a><a class="link" href="../tags/lxc.html">lxc,</a><a class="link" href="../tags/namespace.html">namespace,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>