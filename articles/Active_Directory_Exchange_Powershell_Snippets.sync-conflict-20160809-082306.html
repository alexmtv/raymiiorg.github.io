<!DOCTYPE html><html lang="en"><head><title>Active Directory and Exchange Command Line Powershell - Raymii.org</title><link href="/s/inc/css/custom-first.css" rel="stylesheet"/><link href="/s/inc/css/light.css" rel="stylesheet"/><link href="/s/inc/css/custom.css" rel="stylesheet" title="custom"/><script src="/s//inc/js/toc.js" type="text/javascript"></script><meta content="text/html;charset=utf-8" http-equiv="Content-Type"/><link href="inc/img/icons/iphone.png" rel="apple-touch-icon"/><link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76"/><link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120"/><link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="/s/inc/opensearch.xml" rel="search" type="application/opensearchdescription+xml"/><link href="https://raymii.org/s/feed.xml" rel="alternate" title="RSS Feed for Raymii.org" type="application/rss+xml"/></head><body><a id="top-of-page"></a><div class="container-fluid "><div class="row"><div class="col-md-12"><div class="col-md-3 col-sm-3 max-200"><div class="well well-none"><h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org<img alt="IEC Resistor logo" src="/s/inc/img/resistor-50.png"/></a></h3><h6 class="headheader">Quis custodiet ipsos custodes?</h6><h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6></div><form action="https://encrypted.google.com/search" role="search"><div class="form-group"><input name="as_sitesearch" type="hidden" value="raymii.org"/><input name="as_qdr" type="hidden" value="all"/><input class="form-control" name="as_q" placeholder="Search" type="text"/></div></form><div class="menu"><ul class="nav nav-pills nav-stacked"><li><a class="special-menu" href="/s/index.html">Home</a></li><li class="bottom-spacing"><a class="special-menu" href="/s/everything.html">All Pages</a></li><li class="hideifsmall"><a class="link" href="/s/tags/bash.html">Bash</a></li><li class="hideifsmall"><a class="link" href="/s/tags/monitoring.html">Monitoring</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ssl.html">SSL</a></li><li class="hideifsmall"><a class="link" href="/s/tags/debian.html">Debian</a></li><li class="hideifsmall"><a class="link" href="/s/tags/python.html">Python</a></li><li class="hideifsmall"><a class="link" href="/s/tags/vpn.html">VPN</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ubuntu.html">Ubuntu</a></li><li class="hideifsmall"><a class="link" href="/s/tags/nginx.html">nginx</a></li><li class="hideifsmall"><a class="link" href="/s/tags/openstack.html">Openstack</a></li><li class="hideifsmall"><a class="link" href="/s/tags/ansible.html">Ansible</a></li></ul><a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br/> <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br/><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="9322003332" style="display:inline-block;width:200px;height:200px"></ins><script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script></div></div><div class="col-md-8 col-sm-8"><div class="inner"><h2 class="headheader">Active Directory and Exchange Command Line Powershell</h2><ul class="breadcrumb"><li><a class="link" href="../index.html">Home</a></li><li><a class="link" href="../articles/index.html">Articles</a></li><li><a class="link" href="Active_Directory_Exchange_Powershell_Snippets.html">Active Directory and Exchange Command Line Powershell</a></li></ul><p><small>27-02-2016</small> | <small>Remy van Elst</small></p><div class="ad"><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" data-ad-client="ca-pub-7993642564731324" data-ad-slot="6172324376" style="display:inline-block;width:728px;height:90px"></ins><script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script></div><br/><div id="toc"><h3>Table of Contents</h3></div><hr/><div id="contents"><p>This is a collection of Powershell snippets to install Active Directory, create a new Active Directory Domain, join an existing Active Directory domain, create an Active Directory user and to install Microsoft Exchange 2013. The snippets were tested on Windows Server 2012 R2.</p><p>I'm quite suprised with how easy it is to do the above tasks with Powershell. Much faster than the GUI wizards.</p><p>As a Linux admin, I do also like that these tasks can be automated via the command line. Also, my Windows knowledge is very limited. There are probably better ways to do the below things, if you know how, please shoot me an email via the contact page.</p><p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you'll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a></p><p>Start with a freshly installed Server 2012 R2 machine (or VM). Fire up a Powershell session.</p><h3>Install Active Directory</h3><p>The following command installs the Active Directory Domain Services role:</p><pre><code>Install-WindowsFeature -name AD-Domain-Services -IncludeManagementTools
</code></pre><h3>Create a new Active Directory Domain:</h3><p>First import the module in the PowerShell session:</p><pre><code>Import-Module ADDSDeployment
</code></pre><p>Initiate the new Active Directory:</p><pre><code>Install-ADDSForest
-CreateDnsDelegation:$false `
-DatabasePath "C:\Windows\NTDS" `
-DomainMode "Win2012R2" `
-DomainName "raymii.nl" `
-DomainNetbiosName "RAYMII" `
-ForestMode "Win2012R2" `
-InstallDns:$true `
-LogPath "C:\Windows\NTDS" `
-NoRebootOnCompletion:$false `
-SysvolPath "C:\Windows\SYSVOL" `
-Force:$true
</code></pre><p>Replace the <code>DomainName</code> and <code>DomainNetbiosName</code> with your chosen domain name. PowerShell will then ask you for the AD Recovery Password, make it a strong one.</p><h3>Add a server to a domain</h3><p>This adds a server to an existing domain, as a backup domain controller. First install the AD Domain Services as described above and import it in your powershell session.</p><p>First test the existing domain to make sure you can join:</p><pre><code>Test-ADDSForestInstallation -DomainName raymii.nl
</code></pre><p>Add the server to the domain as a backup domain controller:</p><pre><code>Install-ADDSDomainController -InstallDns -Credential `
  (Get-Credential RAYMII\Administrator) -DomainName raymii.nl
</code></pre><p>It'll prompt you for the user password.</p><h3>Create an Active Directory user account</h3><p>To create a new Active Directory user account, use the below command. It's enabled and has a password:</p><pre><code>New-ADUser -Name "John Doe" -GivenName John -Surname Doe `
  -SamAccountName jdoe -UserPrincipalName jdoe@craymii.nl `
  -AccountPassword (Read-Host -AsSecureString "hunter2") `
  -PassThru | Enable-ADAccount
</code></pre><p>The user is able to login right away after this. The user is created in the default <code>Users</code> OU.</p><h3>Create an Active Directory group</h3><p>Use the below command to create a new global group in the default <code>Users</code> folder of Active Directory called "Managers":</p><pre><code>New-ADGroup -name "Managers" -groupscope Global
</code></pre><p>If it needs to exist in different path in Active Directory, specify the path by its distinguished name:</p><pre><code>New-ADGroup -name "Managers" -groupscope Global -path "OU=OtherOU,DC=Raymii,DC=nl"
</code></pre><h3>Add user to a group</h3><p>The below command adds the user <code>jdoe</code> to the <code>Managers</code> group:</p><pre><code>Add-ADGroupMember -Identity "Managers" -Member "jdoe"
</code></pre><p>To add a user in a different OU to a group in a different OU, you can specify the full DN:</p><pre><code>Add-ADGroupMember -Identity "CN=SupportSlavesGroup,OU=SupportSlaves,DC=raymii,DC=nl" -Members "CN=jdoe,OU=OtherUserOU,DC=raymii,DC=nl" 
</code></pre><h3>Install Microsoft Exchange 2013</h3><p>Install the RSAT-DSS role via Powershell:</p><pre><code>Install-WindowsFeature RSAT-ADDS
</code></pre><p>We prepare the forest for the instalation of Exchange. First the Schema:</p><pre><code>setup /ps /IAcceptExchangeServerLicenseTerms
</code></pre><p>The Active Directory:</p><pre><code>setup /PrepareAD /OrganizationName:"Raymii" /IAcceptExchangeServerLicenseTerms
</code></pre><p>The Domain itself:</p><pre><code>setup /pd /IAcceptExchangeServerLicenseTerms
</code></pre><p>Install other required components and features for Exchange:</p><pre><code>Install-WindowsFeature AS-HTTP-Activation, Desktop-Experience, NET-Framework-45-Features, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation
</code></pre><p>You need to download and install the following setups manually from the Microsoft website and install them in the order listed below:</p><ul><li>Unified Communications Managed API 4.0 Runtime</li><li>Microsoft Office 2010 Filter Pack 64 bit</li><li>Microsoft Office 2010 Filter Pack SP1 64 bit</li></ul><p>Start the actual Exchange installation:</p><pre><code>setup /m:Install /Roles:ca,mb,mt /IAcceptExchangeServerLicenseTerms /InstallWindowsComponents /DBFilePath:"E:\EXCHANGE\MDB001.edb" /LogFolderPath:"E:\EXCHANGE" /MdbName:"MDB001"
</code></pre><p>When it's finished, the ECP web admin is available.</p></div><hr/>Tags: <a class="link" href="../tags/active-directory.html">active-directory,</a><a class="link" href="../tags/domain.html">domain,</a><a class="link" href="../tags/exchange.html">exchange,</a><a class="link" href="../tags/ldap.html">ldap,</a><a class="link" href="../tags/microsoft.html">microsoft,</a><a class="link" href="../tags/owa.html">owa,</a><a class="link" href="../tags/powershell.html">powershell,</a><a class="link" href="../tags/windows-server.html">windows-server,</a><div class="footer"><hr/><p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | <a href="/s/static/About.html">About</a><br/></p></div></div></div></div></div></div><script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://hosted-oswa.org/piwik/" : "http://hosted-oswa.org/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript>&lt;p&gt;&lt;img src="http://hosted-oswa.org/piwik/piwik.php?idsite=1" style="border:0" alt="" /&gt;&lt;/p&gt;</noscript></body></html>